version: 2.1

orbs:
  node: circleci/node@5.2.0
  android: circleci/android@2.5.0

executors:
  node-executor:
    docker:
      - image: cimg/node:20.19
    working_directory: ~/project
    resource_class: medium

jobs:
  # Lint and unit tests - runs on all branches
  test:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          cache-version: v2
      - run:
          name: Lint
          command: npm run lint
      - run:
          name: Unit Tests
          command: npm test -- --ci --coverage --maxWorkers=2
      - store_test_results:
          path: coverage
      - store_artifacts:
          path: coverage

  # Build production web
  build-web:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          cache-version: v2
      - run:
          name: Build Production
          command: npm run build:prod
      - persist_to_workspace:
          root: .
          paths:
            - www
            - node_modules
            - package.json
            - capacitor.config.ts
            - android

  # Deploy preview to Netlify (branches != master)
  # Requires NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID in CircleCI project settings
  deploy-preview:
    executor: node-executor
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Deploy Preview to Netlify
          command: |
            BRANCH_ALIAS="${CIRCLE_BRANCH//\//-}"
            npx netlify-cli deploy \
              --auth="$NETLIFY_AUTH_TOKEN" \
              --site="$NETLIFY_SITE_ID" \
              --dir=www \
              --alias="$BRANCH_ALIAS" \
              --message="Preview: $CIRCLE_BRANCH"

  # Deploy production to Netlify (master only)
  # Requires NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID in CircleCI project settings
  deploy-prod:
    executor: node-executor
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Deploy Production to Netlify
          command: |
            npx netlify-cli deploy \
              --auth="$NETLIFY_AUTH_TOKEN" \
              --site="$NETLIFY_SITE_ID" \
              --dir=www \
              --prod \
              --message="Production deploy"

  # Android build - API 34 (target)
  build-android:
    executor:
      name: android/android-machine
      tag: 2024.01.1
    steps:
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - gradle-v2-{{ checksum "android/build.gradle" }}-{{ checksum "android/app/build.gradle" }}
            - gradle-v2-{{ checksum "android/build.gradle" }}
            - gradle-v2-
      - run:
          name: Sync Capacitor
          command: npx cap sync android
      - run:
          name: Build Debug APK
          command: cd android && ./gradlew assembleDebug --no-daemon --parallel --build-cache
      - save_cache:
          key: gradle-v2-{{ checksum "android/build.gradle" }}-{{ checksum "android/app/build.gradle" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
            - android/.gradle
      - store_artifacts:
          path: android/app/build/outputs/apk/debug

  # Release APK with version
  release-apk:
    executor:
      name: android/android-machine
      tag: 2024.01.1
    steps:
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - gradle-v2-{{ checksum "android/build.gradle" }}-{{ checksum "android/app/build.gradle" }}
            - gradle-v2-
      - run:
          name: Get version
          command: |
            VERSION=$(node -p "require('./package.json').version")
            echo "export VERSION=$VERSION" >> $BASH_ENV
      - run:
          name: Sync Capacitor
          command: npx cap sync android
      - run:
          name: Build Release APK
          command: cd android && ./gradlew assembleDebug --no-daemon --parallel --build-cache
      - run:
          name: Package Release
          command: |
            mkdir -p release
            cp android/app/build/outputs/apk/debug/app-debug.apk "release/diabetactic-v${VERSION}.apk"
      - store_artifacts:
          path: release
          destination: apk-release

workflows:
  # CI workflow - runs on all branches
  ci:
    jobs:
      - test
      - build-web:
          requires:
            - test
      # Preview deploy for feature branches
      - deploy-preview:
          requires:
            - build-web
          filters:
            branches:
              ignore: master
      # Production deploy for master
      - deploy-prod:
          requires:
            - build-web
          filters:
            branches:
              only: master
      # Android build only on master (save resources)
      - build-android:
          requires:
            - build-web
          filters:
            branches:
              only: master

  # Release workflow - manual approval required
  release:
    jobs:
      - test:
          filters:
            branches:
              only: master
      - build-web:
          requires:
            - test
          filters:
            branches:
              only: master
      - hold-for-approval:
          type: approval
          requires:
            - build-web
      - release-apk:
          requires:
            - hold-for-approval
