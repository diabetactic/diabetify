version: 2.1

orbs:
  node: circleci/node@5.2.0
  android: circleci/android@2.5.0

executors:
  node-executor:
    docker:
      - image: cimg/node:20.19
    working_directory: ~/project

jobs:
  # Lint and unit tests
  test:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          cache-version: v1
      - run:
          name: Lint
          command: npm run lint
      - run:
          name: Unit Tests
          command: npm test -- --ci --coverage
      - store_test_results:
          path: coverage
      - store_artifacts:
          path: coverage

  # Build production web
  build-web:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          cache-version: v1
      - run:
          name: Build Production
          command: npm run build:prod
      - persist_to_workspace:
          root: .
          paths:
            - www
            - node_modules
            - package.json
            - capacitor.config.ts
            - android

  # Deploy to Netlify
  deploy-netlify:
    executor: node-executor
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Deploy to Netlify
          command: |
            npm install -g netlify-cli
            netlify deploy --prod --dir=www --site=$NETLIFY_SITE_ID --auth=$NETLIFY_AUTH_TOKEN

  # Android smoke test - API 33
  build-android:
    executor:
      name: android/android-machine
      tag: 2024.01.1
    steps:
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - gradle-v1-{{ checksum "android/build.gradle" }}
            - gradle-v1-
      - run:
          name: Sync Capacitor
          command: npx cap sync android
      - run:
          name: Build Debug APK
          command: cd android && ./gradlew assembleDebug --no-daemon
      - save_cache:
          key: gradle-v1-{{ checksum "android/build.gradle" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
      - store_artifacts:
          path: android/app/build/outputs/apk/debug

  # Release APK - requires tests to pass
  release-apk:
    executor:
      name: android/android-machine
      tag: 2024.01.1
    steps:
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - gradle-v1-{{ checksum "android/build.gradle" }}
            - gradle-v1-
      - run:
          name: Get version
          command: |
            VERSION=$(node -p "require('./package.json').version")
            echo "export VERSION=$VERSION" >> $BASH_ENV
      - run:
          name: Sync Capacitor
          command: npx cap sync android
      - run:
          name: Build Debug APK
          command: cd android && ./gradlew assembleDebug --no-daemon
      - run:
          name: Rename APK
          command: |
            mkdir -p release
            cp android/app/build/outputs/apk/debug/app-debug.apk "release/diabetactic-v${VERSION}.apk"
      - store_artifacts:
          path: release
          destination: apk-release

workflows:
  # Main CI workflow
  ci:
    jobs:
      - test
      - build-web:
          requires:
            - test
      - build-android:
          requires:
            - build-web
          filters:
            branches:
              only: master
      - deploy-netlify:
          requires:
            - build-web
          filters:
            branches:
              only: master

  # Release workflow - REQUIRES CI to pass first
  release:
    jobs:
      - test:
          filters:
            branches:
              only: master
      - build-web:
          requires:
            - test
          filters:
            branches:
              only: master
      - hold-for-approval:
          type: approval
          requires:
            - build-web
      - release-apk:
          requires:
            - hold-for-approval
