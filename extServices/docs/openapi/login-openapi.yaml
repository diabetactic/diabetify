openapi: 3.0.3
info:
  title: Diabetify Login/User Service
  version: 0.1.0
  description: Users and Admins authentication and profiles. Intended for internal use by API gateways.
servers:
  - url: http://localhost:8003
tags:
  - name: Users
  - name: Admin
components:
  schemas:
    User:
      type: object
      properties:
        dni: { type: string }
        name: { type: string }
        surname: { type: string }
        blocked: { type: boolean }
        email: { type: string, format: email }
        tidepool: { type: string, nullable: true }
        hospital_account: { type: string }
        times_measured: { type: integer }
        streak: { type: integer }
        max_streak: { type: integer }
      required: [dni, name, surname, blocked, email, hospital_account]
    UserInDB:
      allOf:
        - $ref: '#/components/schemas/User'
        - type: object
          properties:
            user_id: { type: integer }
          required: [user_id]
    UserSignUp:
      allOf:
        - $ref: '#/components/schemas/User'
        - type: object
          properties:
            password: { type: string }
          required: [password]
    UserLogin:
      type: object
      properties:
        dni: { type: string }
        password: { type: string }
      required: [dni, password]
    Admin:
      type: object
      properties:
        username: { type: string }
        email: { type: string, format: email }
      required: [username, email]
    AdminInDB:
      allOf:
        - $ref: '#/components/schemas/Admin'
        - type: object
          properties:
            admin_id: { type: integer }
          required: [admin_id]
    AdminCreate:
      allOf:
        - $ref: '#/components/schemas/Admin'
        - type: object
          properties:
            password: { type: string }
          required: [password]
    AdminLogin:
      type: object
      properties:
        username: { type: string }
        password: { type: string }
      required: [username, password]
paths:
  /users/grantaccess:
    post:
      tags: [Users]
      summary: Validate user credentials and return profile
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UserLogin' }
      responses:
        '200':
          description: User
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
              examples:
                example:
                  value:
                    { dni: "1000", name: "Nacho", surname: "Scocco", blocked: false, email: "1@example.com", hospital_account: "1", times_measured: 0, streak: 0, max_streak: 0 }
  /users:
    get:
      tags: [Users]
      summary: List users
      responses:
        '200':
          description: Users
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/UserInDB' }
    post:
      tags: [Users]
      summary: Create user
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UserSignUp' }
      responses:
        '200':
          description: Created user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserInDB' }
  /users/from_dni/{dni}:
    get:
      tags: [Users]
      summary: Get user by DNI
      parameters:
        - in: path
          name: dni
          required: true
          schema: { type: string }
      responses:
        '200':
          description: User
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserInDB' }
  /users/{user_id}:
    get:
      tags: [Users]
      summary: Get user by ID
      parameters:
        - in: path
          name: user_id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: User
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
  /users/force/{user_id}:
    get:
      tags: [Users]
      summary: Get user (no blocked check)
      parameters:
        - in: path
          name: user_id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: User
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserInDB' }
  /users/block/{user_id}:
    post:
      tags: [Users]
      summary: Toggle block/unblock user
      parameters:
        - in: path
          name: user_id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Updated user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserInDB' }
  /admin:
    post:
      tags: [Admin]
      summary: Create admin
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AdminCreate' }
      responses:
        '201':
          description: Created admin
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AdminInDB' }
  /admin/grantaccess:
    post:
      tags: [Admin]
      summary: Validate admin credentials and return profile
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AdminLogin' }
      responses:
        '200':
          description: Admin
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Admin' }
  /admin/password/check:
    post:
      tags: [Admin]
      summary: Check admin password
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AdminLogin' }
      responses:
        '200': { description: OK }
  /admin/password/change:
    put:
      tags: [Admin]
      summary: Change admin password
      parameters:
        - in: query
          name: admin_id
          required: true
          schema: { type: integer }
        - in: query
          name: new_password
          required: true
          schema: { type: string }
      responses:
        '200': { description: Changed }
  /admin/mail/change:
    put:
      tags: [Admin]
      summary: Change admin email
      parameters:
        - in: query
          name: admin_id
          required: true
          schema: { type: integer }
        - in: query
          name: new_mail
          required: true
          schema: { type: string, format: email }
      responses:
        '200':
          description: Updated admin
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Admin' }
  /admin/password/recover:
    post:
      tags: [Admin]
      summary: Trigger password recovery email
      parameters:
        - in: query
          name: email
          required: true
          schema: { type: string, format: email }
        - in: query
          name: token
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Message
          content:
            application/json:
              schema: { type: string }
  /admin/from_username/{username}:
    get:
      tags: [Admin]
      summary: Get admin by username
      parameters:
        - in: path
          name: username
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Admin
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AdminInDB' }
  /admin/from_mail/{email}:
    get:
      tags: [Admin]
      summary: Get admin by email
      parameters:
        - in: path
          name: email
          required: true
          schema: { type: string, format: email }
      responses:
        '200':
          description: Admin
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AdminInDB' }
  /admin/{admin_id}:
    get:
      tags: [Admin]
      summary: Get admin by ID
      parameters:
        - in: path
          name: admin_id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Admin
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Admin' }
