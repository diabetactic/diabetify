# Run services with host user to prevent root-owned files
# start.sh auto-exports DOCKER_UID/DOCKER_GID, or they default to 1000:1000

services:
  # PostgreSQL Databases
  glucoserver_db:
    container_name: diabetactic_glucoserver_db
    image: postgres:16
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=glucoserver
    volumes:
      - postgres_data_glucoserver:/var/lib/postgresql/data/
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - diabetactic-network

  users_db:
    container_name: diabetactic_users_db
    image: postgres:16
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=users
    volumes:
      - postgres_data_users:/var/lib/postgresql/data/
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - diabetactic-network

  appointments_db:
    container_name: diabetactic_appointments_db
    image: postgres:16
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=appointments
    volumes:
      - postgres_data_appointments:/var/lib/postgresql/data/
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - diabetactic-network

  # Backend Services
  glucoserver:
    container_name: diabetactic_glucoserver
    build: ../../glucoserver/
    user: '${DOCKER_UID:-1000}:${DOCKER_GID:-1000}'
    command: python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      glucoserver_db:
        condition: service_healthy
    volumes:
      - ../../glucoserver:/app
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@glucoserver_db:5432/glucoserver
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'python3 -c "import urllib.request; urllib.request.urlopen(''http://127.0.0.1:8000/health'', timeout=1)"',
        ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - diabetactic-network

  login_service:
    container_name: diabetactic_login_service
    build: ../../login/
    user: '${DOCKER_UID:-1000}:${DOCKER_GID:-1000}'
    command: python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      users_db:
        condition: service_healthy
    volumes:
      - ../../login:/app
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@users_db:5432/users
      - NOREPLY_ACCOUNT=diabetactic@gmail.com
      - NOREPLY_PASSWORD=${NOREPLY_PASSWORD:-}
      - BACKOFFICE_FRONT_URL=http://localhost:3000
      - MOBILE_FRONT_URL=http://localhost:4200
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'python3 -c "import urllib.request; urllib.request.urlopen(''http://127.0.0.1:8000/health'', timeout=1)"',
        ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - diabetactic-network

  appointments:
    container_name: diabetactic_appointments
    build: ../../appointments/
    user: '${DOCKER_UID:-1000}:${DOCKER_GID:-1000}'
    command: python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      appointments_db:
        condition: service_healthy
    volumes:
      - ../../appointments:/app
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@appointments_db:5432/appointments
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'python3 -c "import urllib.request; urllib.request.urlopen(''http://127.0.0.1:8000/health'', timeout=1)"',
        ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - diabetactic-network

  api-gateway:
    container_name: diabetactic_api_gateway
    build: ../../api-gateway/
    user: '${DOCKER_UID:-1000}:${DOCKER_GID:-1000}'
    command: python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - '${DIABETACTIC_API_PORT:-8000}:8000'
    depends_on:
      login_service:
        condition: service_healthy
      appointments:
        condition: service_healthy
      glucoserver:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ../../api-gateway:/app
    environment:
      - USERS_BASE_URL=http://login_service:8000
      - APPOINTMENTS_BASE_URL=http://appointments:8000
      - GLUCOSERVER_BASE_URL=http://glucoserver:8000
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY:-dev-secret-change-me}
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'python3 -c "import urllib.request; urllib.request.urlopen(''http://127.0.0.1:8000/health'', timeout=1)"',
        ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - diabetactic-network

  api-gateway-backoffice:
    container_name: diabetactic_api_gateway_backoffice
    build: ../../api-gateway-backoffice/
    user: '${DOCKER_UID:-1000}:${DOCKER_GID:-1000}'
    command: python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - '${DIABETACTIC_BACKOFFICE_PORT:-8001}:8000'
    depends_on:
      login_service:
        condition: service_healthy
      appointments:
        condition: service_healthy
      glucoserver:
        condition: service_healthy
    volumes:
      - ../../api-gateway-backoffice:/app
    environment:
      - USERS_BASE_URL=http://login_service:8000
      - APPOINTMENTS_BASE_URL=http://appointments:8000
      - GLUCOSERVER_BASE_URL=http://glucoserver:8000
      - SECRET_KEY=${SECRET_KEY:-dev-secret-change-me}
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'python3 -c "import urllib.request; urllib.request.urlopen(''http://127.0.0.1:8000/health'', timeout=1)"',
        ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - diabetactic-network

  redis:
    image: redis:7-alpine
    container_name: diabetactic_redis
    volumes:
      - redis_data:/data
    networks:
      - diabetactic-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 3

  # Test Utils Container - for user management scripts
  test-utils:
    container_name: diabetactic_test_utils
    build:
      context: .
      dockerfile: Dockerfile.test-utils
    depends_on:
      api-gateway:
        condition: service_healthy
    environment:
      - API_GATEWAY_URL=http://api-gateway:8000
      - LOGIN_SERVICE_URL=http://login_service:8000
    networks:
      - diabetactic-network
    command: tail -f /dev/null # Keep container running

volumes:
  postgres_data_users:
  postgres_data_appointments:
  postgres_data_glucoserver:
  redis_data:

networks:
  diabetactic-network:
    driver: bridge
