# Docker Compose v2+ (no version key needed)
#
# Usage:
#   Full Playwright (all browsers):  docker compose -f docker/docker-compose.e2e.yml up --build
#   Slim (Chromium-only project):    E2E_SLIM=1 docker compose -f docker/docker-compose.e2e.yml up --build
#   Slim image (Chromium-only deps): E2E_DOCKERFILE=Dockerfile.e2e-slim E2E_SLIM=1 docker compose -f docker/docker-compose.e2e.yml up --build
#
services:
  # ============================================================================
  # App Server - Serves the built Angular application
  # ============================================================================
  app:
    image: nginx:1.25-alpine
    container_name: diabetactic-app
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ../www/browser:/usr/share/nginx/html:ro
    ports:
      - '4200:80'
    networks:
      - e2e-network
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://127.0.0.1:80/health']
      interval: 5s
      timeout: 3s
      start_period: 10s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # Playwright - Runs E2E tests against the app server
  # ============================================================================
  # Use E2E_DOCKERFILE=... to select the runner image.
  # Use E2E_SLIM=1 to run only the `mobile-chromium` project.
  playwright:
    build:
      context: ..
      dockerfile: docker/${E2E_DOCKERFILE:-Dockerfile.e2e-runner}
    container_name: diabetactic-playwright
    depends_on:
      app:
        condition: service_healthy
    environment:
      - E2E_HOST=localhost
      - E2E_PORT=80
      - E2E_BASE_URL=http://localhost:80
      - E2E_SKIP_SERVER=true
      - CI=true
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - E2E_DEBUG
      - E2E_DEBUG_VERBOSE
      - E2E_TRACE
      - DEBUG
    volumes:
      # Mount Playwright workspace (tests + helpers + snapshots + artifacts dir)
      - ../playwright:/e2e/playwright
      - ../playwright-report:/e2e/playwright-report
      - ../playwright.config.ts:/e2e/playwright.config.ts:ro
    network_mode: 'service:app'
    working_dir: /e2e
    user: pwuser
    # Use the repo's `playwright.config.ts` reporter config (CI=true already set above).
    # Do not override via CLI: `json=...` is not a valid reporter module and will fail resolution.
    command: sh -c "npx --no-install wait-on --timeout 120000 http://localhost:80/health && npx playwright test ${E2E_SLIM:+--project=mobile-chromium}"

  # ============================================================================
  # Mock Backend (Optional) - For local backend testing
  # ============================================================================
  # Uncomment if you need a mock backend service
  # mock-backend:
  #   image: node:20-alpine
  #   container_name: diabetactic-mock-backend
  #   volumes:
  #     - ../mock-api:/app
  #   working_dir: /app
  #   command: npm start
  #   ports:
  #     - "8000:8000"
  #   networks:
  #     - e2e-network
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/health"]
  #     interval: 5s
  #     timeout: 3s
  #     start_period: 10s
  #     retries: 5

networks:
  e2e-network:
    driver: bridge
    name: diabetactic-e2e
# ============================================================================
# Usage Instructions
# ============================================================================
#
# 1. Build and run tests:
#    docker-compose -f docker/docker-compose.e2e.yml up --build --abort-on-container-exit
#
# 2. Run tests only (if images already built):
#    docker-compose -f docker/docker-compose.e2e.yml up --abort-on-container-exit
#
# 3. Clean up:
#    docker-compose -f docker/docker-compose.e2e.yml down -v
#
# 4. View test reports:
#    open playwright-report/index.html
#
# 5. Debug with headed browser (requires X11):
#    docker-compose -f docker/docker-compose.e2e.yml run --rm playwright npx playwright test --headed
#
# ============================================================================
