<ion-header>
  <ion-toolbar color="primary">
    <ion-title>{{ 'tabs.profile' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="profile-content" [fullscreen]="true">
  <div class="flex flex-col gap-4 px-4 pb-8 pt-6">
    <section class="profile-hero">
      <div class="avatar-wrapper" (click)="changePhoto()" [class.cursor-pointer]="editMode">
        <ion-avatar class="hero-avatar">
          <ion-icon *ngIf="!avatarUrl" name="person-circle-outline" class="avatar-fallback">
          </ion-icon>
          <img *ngIf="avatarUrl" [src]="avatarUrl" alt="User avatar" />
        </ion-avatar>
        <ion-badge *ngIf="editMode" color="primary" class="absolute bottom-0 right-0">üì∑</ion-badge>
      </div>
      <h2 *ngIf="!editMode" class="m-0 text-2xl font-bold text-white">{{ greeting }}</h2>
      <ion-input
        *ngIf="editMode"
        [(ngModel)]="editableName"
        placeholder="Nombre completo"
        class="bg-base-100 rounded-md px-3 py-2 text-center text-2xl font-bold text-white"
      ></ion-input>
      <p *ngIf="!editMode" class="m-0 text-sm text-white opacity-85">{{ emailText }}</p>
      <ion-input
        *ngIf="editMode"
        [(ngModel)]="editableEmail"
        type="email"
        placeholder="correo@ejemplo.com"
        class="bg-base-100 rounded-md px-3 py-2 text-center text-sm text-white opacity-85"
      ></ion-input>
      <p class="m-0 text-sm text-white opacity-85">{{ memberSinceText }}</p>

      <!-- Edit/Save Button -->
      <ion-button
        *ngIf="!editMode"
        expand="block"
        fill="outline"
        (click)="toggleEdit()"
        class="mt-4"
      >
        ‚úèÔ∏è Editar Perfil
      </ion-button>
      <ion-button
        *ngIf="editMode"
        expand="block"
        color="success"
        (click)="saveProfile()"
        class="mt-4"
      >
        ‚úÖ Guardar Cambios
      </ion-button>
    </section>

    <section class="overview-grid">
      <button type="button" class="overview-card" (click)="editAge()">
        <ion-icon
          name="accessibility-outline"
          aria-hidden="true"
          class="text-primary text-[28px]"
        ></ion-icon>
        <div class="min-w-0 flex-1">
          <p class="m-0 text-base font-semibold">{{ 'profile.age' | translate }}</p>
          <p class="text-base-content/70 mb-0 mt-1 text-sm">{{ ageDescription }}</p>
        </div>
        <ion-icon
          name="chevron-forward-outline"
          class="text-base-content/70"
          aria-hidden="true"
        ></ion-icon>
      </button>

      <div class="overview-card">
        <ion-icon
          name="medkit-outline"
          aria-hidden="true"
          class="text-primary text-[28px]"
        ></ion-icon>
        <div class="min-w-0 flex-1">
          <p class="m-0 text-base font-semibold">{{ 'profile.diabetesInfo' | translate }}</p>
          <p class="text-base-content/70 mb-0 mt-1 text-sm">{{ diabetesSummary }}</p>
        </div>
      </div>

      <div class="overview-card" [class.overview-card--placeholder]="!hasEmergencyContact">
        <ion-icon
          name="warning-outline"
          aria-hidden="true"
          class="text-primary text-[28px]"
        ></ion-icon>
        <div class="min-w-0 flex-1">
          <p class="m-0 text-base font-semibold">{{ 'profile.emergencyContact' | translate }}</p>
          <p class="text-base-content/70 mb-0 mt-1 text-sm">{{ emergencySummary }}</p>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 class="text-base-content m-0 text-lg font-bold">
        {{ 'profile.preferences' | translate }}
      </h3>

      <div class="preference-row">
        <div class="flex min-w-0 flex-1 items-center gap-3">
          <ion-icon
            name="contrast-outline"
            aria-hidden="true"
            class="text-primary text-[26px]"
          ></ion-icon>
          <div>
            <p class="text-base-content m-0 text-base font-semibold">
              {{ 'profile.theme.title' | translate }}
            </p>
          </div>
        </div>
        <ion-select
          interface="alert"
          [value]="currentTheme"
          (ionChange)="onThemeChange($event)"
          aria-label="{{ 'profile.theme.title' | translate }}"
        >
          <ion-select-option value="light">{{
            'profile.theme.light' | translate
          }}</ion-select-option>
          <ion-select-option value="dark">{{ 'profile.theme.dark' | translate }}</ion-select-option>
          <ion-select-option value="auto">{{ 'profile.theme.auto' | translate }}</ion-select-option>
        </ion-select>
      </div>

      <div class="preference-row">
        <div class="flex min-w-0 flex-1 items-center gap-3">
          <ion-icon
            name="language-outline"
            aria-hidden="true"
            class="text-primary text-[26px]"
          ></ion-icon>
          <div>
            <p class="text-base-content m-0 text-base font-semibold">
              {{ 'profile.language.title' | translate }}
            </p>
          </div>
        </div>
        <ion-select
          interface="alert"
          [value]="currentLanguage"
          (ionChange)="onLanguageChange($event)"
          aria-label="{{ 'profile.language.title' | translate }}"
        >
          <ion-select-option value="en">{{ 'profile.language.en' | translate }}</ion-select-option>
          <ion-select-option value="es">{{ 'profile.language.es' | translate }}</ion-select-option>
        </ion-select>
      </div>

      <div class="preference-row">
        <div class="flex min-w-0 flex-1 items-center gap-3">
          <ion-icon
            name="water-outline"
            aria-hidden="true"
            class="text-primary text-[26px]"
          ></ion-icon>
          <div>
            <p class="text-base-content m-0 text-base font-semibold">
              {{ 'profile.glucoseUnits' | translate }}
            </p>
          </div>
        </div>
        <ion-select
          interface="alert"
          [value]="currentGlucoseUnit"
          (ionChange)="onGlucoseUnitChange($event)"
          aria-label="{{ 'profile.glucoseUnits' | translate }}"
        >
          <ion-select-option *ngFor="let option of unitOptions" [value]="option.value">
            {{ option.label }}
          </ion-select-option>
        </ion-select>
      </div>
    </section>

    <section class="card tidepool-card">
      <div class="flex items-center gap-3">
        <ion-icon
          name="cloud-outline"
          aria-hidden="true"
          class="text-primary text-[28px]"
        ></ion-icon>
        <div>
          <p class="m-0 text-base font-semibold">{{ 'profile.tidepoolIntegration' | translate }}</p>
          <p class="text-base-content/70 mb-0 mt-1 text-sm">
            {{
              isConnected ? ('profile.connected' | translate) : ('profile.notConnected' | translate)
            }}
          </p>
        </div>
      </div>
      <p class="text-base-content/70 m-0 text-sm" *ngIf="isConnected">
        {{ 'profile.lastSync' | translate }}: {{ formatLastSyncTime() }}
      </p>
      <ion-button
        expand="block"
        [color]="isConnected ? 'danger' : 'primary'"
        (click)="onToggleTidepoolConnection()"
      >
        <ion-icon
          slot="start"
          [name]="isConnected ? 'log-out-outline' : 'log-in-outline'"
        ></ion-icon>
        {{ isConnected ? ('profile.disconnect' | translate) : ('profile.connect' | translate) }}
      </ion-button>
    </section>

    <section class="card">
      <h3 class="text-base-content m-0 text-lg font-bold">{{ 'profile.about' | translate }}</h3>

      <div class="text-base-content flex items-center gap-3 py-3">
        <ion-icon
          name="information-circle-outline"
          aria-hidden="true"
          class="text-primary text-[26px]"
        ></ion-icon>
        <div>
          <p class="m-0 text-base font-semibold">{{ 'profile.appVersion' | translate }}</p>
          <p class="text-base-content/70 mb-0 mt-1 text-sm">{{ appVersion }}</p>
        </div>
      </div>

      <button type="button" class="about-row link" (click)="openTermsOfService()">
        <ion-icon
          name="document-text-outline"
          aria-hidden="true"
          class="text-primary text-[26px]"
        ></ion-icon>
        <div>
          <p class="m-0 text-base font-semibold">{{ 'profile.termsOfService' | translate }}</p>
          <p class="text-base-content/70 mb-0 mt-1 text-sm">
            {{ 'profile.viewTerms' | translate }}
          </p>
        </div>
        <ion-icon
          name="chevron-forward-outline"
          class="text-base-content/70"
          aria-hidden="true"
        ></ion-icon>
      </button>

      <button type="button" class="about-row link" (click)="openPrivacyPolicy()">
        <ion-icon
          name="shield-checkmark-outline"
          aria-hidden="true"
          class="text-primary text-[26px]"
        ></ion-icon>
        <div>
          <p class="m-0 text-base font-semibold">{{ 'profile.privacyPolicy' | translate }}</p>
          <p class="text-base-content/70 mb-0 mt-1 text-sm">
            {{ 'profile.viewPolicy' | translate }}
          </p>
        </div>
        <ion-icon
          name="chevron-forward-outline"
          class="text-base-content/70"
          aria-hidden="true"
        ></ion-icon>
      </button>
    </section>

    <ion-button expand="block" fill="outline" color="danger" class="sign-out" (click)="onSignOut()">
      <ion-icon slot="start" name="log-out-outline"></ion-icon>
      {{ 'profile.signOut' | translate }}
    </ion-button>
  </div>
</ion-content>
