<ion-header>
  <ion-toolbar color="primary">
    <ion-title>{{ 'tabs.profile' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="profile-content" [fullscreen]="true">
  <div class="page-shell flex flex-col gap-4 pb-8 pt-6">
    <section class="profile-hero">
      <div class="avatar-container">
        <div class="avatar-wrapper">
          <ion-avatar class="hero-avatar">
            <ion-icon *ngIf="!avatarUrl" name="person-circle-outline" class="avatar-fallback">
            </ion-icon>
            <img *ngIf="avatarUrl" [src]="avatarUrl" [alt]="'profile.avatarAlt' | translate" />
          </ion-avatar>
        </div>
        <input
          #avatarInput
          type="file"
          accept="image/*"
          hidden
          (change)="onAvatarSelected($event)"
        />
        <ion-button
          fill="outline"
          size="small"
          color="light"
          class="change-photo-btn"
          (click)="triggerAvatarUpload()"
          data-testid="avatar-upload-btn"
        >
          <ion-icon name="camera-outline" slot="start"></ion-icon>
          {{ 'profile.changePhoto' | translate }}
        </ion-button>
      </div>
      <h2 class="m-0 text-2xl font-bold text-white">{{ greeting }}</h2>
      <p class="m-0 text-sm text-white opacity-85">{{ emailText }}</p>
      <p class="m-0 text-sm text-white opacity-85">{{ memberSinceText }}</p>
      <ion-button
        id="edit-profile-btn"
        fill="outline"
        size="small"
        color="light"
        (click)="editProfile()"
        data-testid="edit-profile-btn"
        class="mt-3"
      >
        <ion-icon name="create-outline" slot="start"></ion-icon>
        {{ 'profile.editProfile' | translate }}
      </ion-button>
    </section>

    <section class="overview-grid">
      <button type="button" class="overview-card" (click)="editAge()">
        <app-icon
          name="calendar-outline"
          aria-hidden="true"
          class="text-primary text-[28px]"
        ></app-icon>
        <div class="min-w-0 flex-1">
          <p class="m-0 text-base font-semibold">{{ 'profile.age' | translate }}</p>
          <p class="text-medium mb-0 mt-1 text-sm">{{ ageDescription }}</p>
        </div>
        <app-icon name="chevron-forward-outline" aria-hidden="true" class="text-medium"></app-icon>
      </button>

      <div class="overview-card">
        <app-icon
          name="medkit-outline"
          aria-hidden="true"
          class="text-primary text-[28px]"
        ></app-icon>
        <div class="min-w-0 flex-1">
          <p class="m-0 text-base font-semibold">{{ 'profile.diabetesInfo' | translate }}</p>
          <p class="text-medium mb-0 mt-1 text-sm">{{ diabetesSummary }}</p>
        </div>
      </div>

      <div class="overview-card" [class.overview-card--placeholder]="!hasEmergencyContact">
        <app-icon
          name="warning-outline"
          aria-hidden="true"
          class="text-primary text-[28px]"
        ></app-icon>
        <div class="min-w-0 flex-1">
          <p class="m-0 text-base font-semibold">{{ 'profile.emergencyContact' | translate }}</p>
          <p class="text-medium mb-0 mt-1 text-sm">{{ emergencySummary }}</p>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 class="text-dark m-0 text-lg font-bold">{{ 'profile.preferences' | translate }}</h3>

      <div class="preference-row">
        <div class="flex min-w-0 flex-1 items-center gap-3">
          <app-icon
            name="contrast-outline"
            aria-hidden="true"
            class="text-primary text-[26px]"
          ></app-icon>
          <div>
            <p class="text-dark m-0 text-base font-semibold">
              {{ 'profile.theme.title' | translate }}
            </p>
          </div>
        </div>
        <ion-select
          id="theme-selector"
          interface="alert"
          [value]="currentTheme"
          (ionChange)="onThemeChange($event)"
          aria-label="{{ 'profile.theme.title' | translate }}"
          data-testid="theme-selector"
        >
          <ion-select-option value="light">{{
            'profile.theme.light' | translate
          }}</ion-select-option>
          <ion-select-option value="dark">{{ 'profile.theme.dark' | translate }}</ion-select-option>
          <ion-select-option value="auto">{{ 'profile.theme.auto' | translate }}</ion-select-option>
        </ion-select>
      </div>

      <div class="preference-row">
        <div class="flex min-w-0 flex-1 items-center gap-3">
          <app-icon
            name="language-outline"
            aria-hidden="true"
            class="text-primary text-[26px]"
          ></app-icon>
          <div>
            <p class="text-dark m-0 text-base font-semibold">
              {{ 'profile.language.title' | translate }}
            </p>
          </div>
        </div>
        <ion-select
          id="language-selector"
          interface="alert"
          [value]="currentLanguage"
          (ionChange)="onLanguageChange($event)"
          aria-label="{{ 'profile.language.title' | translate }}"
          data-testid="language-selector"
        >
          <ion-select-option value="en">{{ 'profile.language.en' | translate }}</ion-select-option>
          <ion-select-option value="es">{{ 'profile.language.es' | translate }}</ion-select-option>
        </ion-select>
      </div>

      <div class="preference-row">
        <div class="flex min-w-0 flex-1 items-center gap-3">
          <app-icon
            name="water-outline"
            aria-hidden="true"
            class="text-primary text-[26px]"
          ></app-icon>
          <div>
            <p class="text-dark m-0 text-base font-semibold">
              {{ 'profile.glucoseUnits' | translate }}
            </p>
          </div>
        </div>
        <ion-select
          interface="alert"
          [value]="currentGlucoseUnit"
          (ionChange)="onGlucoseUnitChange($event)"
          aria-label="{{ 'profile.glucoseUnits' | translate }}"
          data-testid="glucose-units-selector"
        >
          <ion-select-option *ngFor="let option of unitOptions" [value]="option.value">
            {{ option.label }}
          </ion-select-option>
        </ion-select>
      </div>

      <div class="preference-row">
        <div class="flex min-w-0 flex-1 items-center gap-3">
          <app-icon
            name="notifications-outline"
            aria-hidden="true"
            class="text-primary text-[26px]"
          ></app-icon>
          <div>
            <p class="text-dark m-0 text-base font-semibold">
              {{ 'profile.notifications.title' | translate }}
            </p>
            <p class="text-medium mb-0 mt-1 text-xs">
              {{ 'profile.notifications.desc' | translate }}
            </p>
          </div>
        </div>
        <ion-toggle
          [checked]="notificationsEnabled"
          (ionChange)="onNotificationsToggle($event)"
          aria-label="{{ 'profile.notifications.title' | translate }}"
          data-testid="notifications-toggle"
        ></ion-toggle>
      </div>
    </section>

    <section class="card tidepool-card">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <app-icon
            name="cloud-outline"
            aria-hidden="true"
            class="text-primary text-[28px]"
          ></app-icon>
          <div>
            <p class="m-0 text-base font-semibold">
              {{ 'profile.tidepoolIntegration' | translate }}
            </p>
            <p class="text-medium mb-0 mt-1 text-sm">
              {{
                isConnected
                  ? ('profile.connected' | translate)
                  : ('profile.notConnected' | translate)
              }}
            </p>
          </div>
        </div>
        <ion-button
          fill="clear"
          size="default"
          (click)="showTidepoolInfo()"
          data-testid="tidepool-info-btn"
          class="text-primary min-h-[44px] min-w-[44px]"
        >
          <ion-icon slot="icon-only" name="information-circle-outline" size="large"></ion-icon>
        </ion-button>
      </div>
      <div
        class="bg-base-200/60 mt-3 rounded-lg px-3 py-2"
        *ngIf="isConnected && (authState?.userId || profile?.tidepoolConnection?.userId)"
      >
        <p class="text-base-content/60 m-0 text-xs font-medium">
          {{ 'profile.tidepoolUserId' | translate }}
        </p>
        <p class="text-base-content m-0 font-mono text-sm font-semibold">
          {{ authState?.userId || profile?.tidepoolConnection?.userId }}
        </p>
      </div>
      <p class="text-medium m-0 text-sm" *ngIf="isConnected">
        {{ 'profile.lastSync' | translate }}: {{ formatLastSyncTime() }}
      </p>
      <ion-button
        *ngIf="isConnected"
        expand="block"
        fill="outline"
        color="primary"
        (click)="openTidepoolDashboard()"
        data-testid="tidepool-dashboard-btn"
      >
        <ion-icon slot="start" name="open-outline"></ion-icon>
        {{ 'profile.viewDashboard' | translate }}
      </ion-button>
      <ion-button
        expand="block"
        [color]="isConnected ? 'danger' : 'primary'"
        (click)="onToggleTidepoolConnection()"
        data-testid="tidepool-connect-btn"
      >
        <ion-icon
          slot="start"
          [name]="isConnected ? 'log-out-outline' : 'log-in-outline'"
        ></ion-icon>
        {{ isConnected ? ('profile.disconnect' | translate) : ('profile.connect' | translate) }}
      </ion-button>
    </section>

    <section class="card">
      <h3 class="text-dark m-0 text-lg font-bold">{{ 'profile.about' | translate }}</h3>

      <div class="text-dark flex items-center gap-3 py-3">
        <app-icon
          name="information-circle-outline"
          aria-hidden="true"
          class="text-primary text-[26px]"
        ></app-icon>
        <div>
          <p class="m-0 text-base font-semibold">{{ 'profile.appVersion' | translate }}</p>
          <p class="text-medium mb-0 mt-1 text-sm">{{ appVersion }}</p>
        </div>
      </div>

      <button type="button" class="about-row link" (click)="openTermsOfService()">
        <app-icon
          name="document-text-outline"
          aria-hidden="true"
          class="text-primary text-[26px]"
        ></app-icon>
        <div>
          <p class="m-0 text-base font-semibold">{{ 'profile.termsOfService' | translate }}</p>
          <p class="text-medium mb-0 mt-1 text-sm">{{ 'profile.viewTerms' | translate }}</p>
        </div>
        <app-icon name="chevron-forward-outline" aria-hidden="true" class="text-medium"></app-icon>
      </button>

      <button type="button" class="about-row link" (click)="openPrivacyPolicy()">
        <app-icon
          name="shield-checkmark-outline"
          aria-hidden="true"
          class="text-primary text-[26px]"
        ></app-icon>
        <div>
          <p class="m-0 text-base font-semibold">{{ 'profile.privacyPolicy' | translate }}</p>
          <p class="text-medium mb-0 mt-1 text-sm">{{ 'profile.viewPolicy' | translate }}</p>
        </div>
        <app-icon name="chevron-forward-outline" aria-hidden="true" class="text-medium"></app-icon>
      </button>
    </section>

    <ion-button
      id="sign-out-btn"
      expand="block"
      fill="outline"
      color="danger"
      class="sign-out inline-flex items-center gap-2"
      (click)="onSignOut()"
      data-testid="sign-out-btn"
    >
      <app-icon name="log-out-outline"></app-icon>
      {{ 'profile.signOut' | translate }}
    </ion-button>
  </div>
</ion-content>
