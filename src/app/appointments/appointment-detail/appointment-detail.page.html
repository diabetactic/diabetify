<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <app-icon slot="icon-only" name="arrow-left"></app-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ 'appointments.detail.title' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="appointment-detail-content">
  <div class="px-4 py-6">
    <!-- Loading state -->
    <div *ngIf="loading" class="flex flex-col items-center justify-center gap-4 py-12">
      <app-icon name="loader-circle" class="text-primary animate-spin text-4xl"></app-icon>
      <p class="text-base-content/60 dark:text-base-content/80 m-0 text-base">
        {{ 'appointments.detail.loading' | translate }}
      </p>
    </div>

    <!-- Appointment details -->
    <div *ngIf="!loading && appointment" class="flex flex-col gap-4">
      <!-- Header card with ID and motive -->
      <ion-card class="!m-0">
        <ion-card-header>
          <ion-card-subtitle class="flex items-center gap-2">
            <app-icon name="clipboard-list" class="text-primary"></app-icon>
            {{ 'appointments.record' | translate }} #{{ appointment.appointment_id }}
          </ion-card-subtitle>
          <ion-card-title class="text-xl">
            {{ formatMotive(appointment.motive) }}
          </ion-card-title>
        </ion-card-header>
      </ion-card>

      <!-- Treatment parameters card -->
      <ion-card class="!m-0">
        <ion-card-header>
          <ion-card-title class="flex items-center gap-2 text-lg">
            <app-icon name="activity" class="text-primary"></app-icon>
            {{ 'appointments.detail.treatmentParams' | translate }}
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="grid grid-cols-2 gap-4">
            <!-- Glucose Objective -->
            <div class="bg-base-200 flex flex-col rounded-xl p-3">
              <span
                class="text-base-content/60 dark:text-base-content/80 text-xs uppercase tracking-wide"
              >
                {{ 'appointments.fields.glucoseObjective' | translate }}
              </span>
              <span class="text-primary text-lg font-bold">
                {{ appointment.glucose_objective }} mg/dL
              </span>
            </div>

            <!-- Insulin Type -->
            <div class="bg-base-200 flex flex-col rounded-xl p-3">
              <span
                class="text-base-content/60 dark:text-base-content/80 text-xs uppercase tracking-wide"
              >
                {{ 'appointments.fields.insulinType' | translate }}
              </span>
              <span class="text-lg font-semibold">
                {{ formatInsulinType(appointment.insulin_type) }}
              </span>
            </div>

            <!-- Dose -->
            <div class="bg-base-200 flex flex-col rounded-xl p-3">
              <span
                class="text-base-content/60 dark:text-base-content/80 text-xs uppercase tracking-wide"
              >
                {{ 'appointments.fields.dose' | translate }}
              </span>
              <span class="text-lg font-semibold">{{ appointment.dose }} U</span>
            </div>

            <!-- Fixed Dose -->
            <div class="bg-base-200 flex flex-col rounded-xl p-3">
              <span
                class="text-base-content/60 dark:text-base-content/80 text-xs uppercase tracking-wide"
              >
                {{ 'appointments.fields.fixedDose' | translate }}
              </span>
              <span class="text-lg font-semibold">{{ appointment.fixed_dose }} U</span>
            </div>

            <!-- Ratio -->
            <div class="bg-base-200 flex flex-col rounded-xl p-3">
              <span
                class="text-base-content/60 dark:text-base-content/80 text-xs uppercase tracking-wide"
              >
                {{ 'appointments.fields.ratio' | translate }}
              </span>
              <span class="text-lg font-semibold">1:{{ appointment.ratio }}</span>
            </div>

            <!-- Sensitivity -->
            <div class="bg-base-200 flex flex-col rounded-xl p-3">
              <span
                class="text-base-content/60 dark:text-base-content/80 text-xs uppercase tracking-wide"
              >
                {{ 'appointments.fields.sensitivity' | translate }}
              </span>
              <span class="text-lg font-semibold">{{ appointment.sensitivity }}</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Insulin details card -->
      <ion-card class="!m-0">
        <ion-card-header>
          <ion-card-title class="flex items-center gap-2 text-lg">
            <app-icon name="syringe" class="text-primary"></app-icon>
            {{ 'appointments.detail.insulinDetails' | translate }}
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list lines="none" class="ion-no-padding">
            <ion-item>
              <ion-label>
                <p class="text-base-content/60 dark:text-base-content/80">
                  {{ 'appointments.fields.fastInsulin' | translate }}
                </p>
                <h3 class="font-semibold">{{ formatTextField(appointment.fast_insulin) }}</h3>
              </ion-label>
            </ion-item>
            <ion-item>
              <ion-label>
                <p class="text-base-content/60 dark:text-base-content/80">
                  {{ 'appointments.fields.pumpType' | translate }}
                </p>
                <h3 class="font-semibold">{{ formatPumpType(appointment.pump_type) }}</h3>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Control data card -->
      <ion-card
        *ngIf="appointment.control_data && !isPlaceholderValue(appointment.control_data)"
        class="!m-0"
      >
        <ion-card-header>
          <ion-card-title class="flex items-center gap-2 text-lg">
            <app-icon name="file-text" class="text-primary"></app-icon>
            {{ 'appointments.fields.controlData' | translate }}
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p class="text-base-content/70 dark:text-base-content/90">
            {{ appointment.control_data }}
          </p>
        </ion-card-content>
      </ion-card>

      <!-- Other motive card -->
      <ion-card
        *ngIf="appointment.other_motive && !isPlaceholderValue(appointment.other_motive)"
        class="!m-0"
      >
        <ion-card-header>
          <ion-card-title class="flex items-center gap-2 text-lg">
            <app-icon name="message-square" class="text-primary"></app-icon>
            {{ 'appointments.fields.otherMotive' | translate }}
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p class="text-base-content/70 dark:text-base-content/90">
            {{ appointment.other_motive }}
          </p>
        </ion-card-content>
      </ion-card>

      <!-- Another treatment card -->
      <ion-card
        *ngIf="appointment.another_treatment && !isPlaceholderValue(appointment.another_treatment)"
        class="!m-0"
      >
        <ion-card-header>
          <ion-card-title class="flex items-center gap-2 text-lg">
            <app-icon name="pill" class="text-primary"></app-icon>
            {{ 'appointments.fields.otherTreatment' | translate }}
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p class="text-base-content/70 dark:text-base-content/90">
            {{ appointment.another_treatment }}
          </p>
        </ion-card-content>
      </ion-card>

      <!-- Resolution card - shown when resolution data is available -->
      <ion-card
        *ngIf="resolution && resolution.resolved_at"
        class="!m-0 border-l-4 border-l-green-500"
      >
        <ion-card-header>
          <ion-card-title class="flex items-center gap-2 text-lg">
            <app-icon name="check-circle" class="text-green-500"></app-icon>
            {{ 'appointments.detail.resolution' | translate }}
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list lines="none" class="ion-no-padding">
            <ion-item *ngIf="resolution.resolved_at">
              <ion-label>
                <p class="text-base-content/60 dark:text-base-content/80">
                  {{ 'appointments.resolution.resolvedAt' | translate }}
                </p>
                <h3 class="font-semibold">{{ formatResolutionDate(resolution.resolved_at) }}</h3>
              </ion-label>
            </ion-item>
            <ion-item *ngIf="resolution.resolved_by">
              <ion-label>
                <p class="text-base-content/60 dark:text-base-content/80">
                  {{ 'appointments.resolution.resolvedBy' | translate }}
                </p>
                <h3 class="font-semibold">{{ resolution.resolved_by }}</h3>
              </ion-label>
            </ion-item>
            <ion-item *ngIf="resolution.notes">
              <ion-label>
                <p class="text-base-content/60 dark:text-base-content/80">
                  {{ 'appointments.resolution.notes' | translate }}
                </p>
                <h3 class="whitespace-pre-wrap font-semibold">{{ resolution.notes }}</h3>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Resolution loading state -->
      <ion-card *ngIf="loadingResolution" class="!m-0">
        <ion-card-content class="flex items-center justify-center py-4">
          <app-icon name="loader-circle" class="text-primary mr-2 animate-spin"></app-icon>
          <span class="text-base-content/60 dark:text-base-content/80">
            {{ 'appointments.resolution.loading' | translate }}
          </span>
        </ion-card-content>
      </ion-card>
    </div>
  </div>
</ion-content>
