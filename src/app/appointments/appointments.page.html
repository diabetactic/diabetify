<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>{{ 'appointments.title' | translate }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="createAppointment()" class="inline-flex items-center gap-2">
        <app-icon name="add"></app-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="appointments-content">
  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="px-4 py-6">
    <!-- Loading spinner -->
    <div *ngIf="loading" class="flex flex-col items-center justify-center gap-4 py-12">
      <app-icon name="loader-circle" class="text-primary animate-spin text-4xl"></app-icon>
      <p class="m-0 text-base text-gray-600 dark:text-gray-300">
        {{ 'appointments.loading' | translate }}
      </p>
    </div>

    <!-- Error message -->
    <ion-card *ngIf="error && !loading" color="danger" class="mb-4">
      <ion-card-content>
        <ion-text>
          <p>{{ error }}</p>
        </ion-text>
      </ion-card-content>
    </ion-card>

    <!-- Empty state -->
    <ion-card *ngIf="!loading && !error && appointments.length === 0" class="empty-state mb-4">
      <ion-card-content class="flex flex-col items-center py-8 text-center">
        <span class="material-symbols-outlined text-6xl text-gray-400">medical_information</span>
        <h2 class="mb-2 mt-4 text-xl font-semibold">
          {{ 'appointments.empty.title' | translate }}
        </h2>
        <p class="mb-6 text-sm text-gray-600 dark:text-gray-400">
          {{ 'appointments.empty.message' | translate }}
        </p>
        <ion-button (click)="createAppointment()" expand="block" class="w-full">
          {{ 'appointments.actions.create' | translate }}
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Current Appointment -->
    <div *ngIf="!loading && !error && currentAppointment" class="flex flex-col gap-4">
      <!-- Section header -->
      <div class="flex items-center gap-2">
        <span class="badge badge-primary">{{ 'appointments.current' | translate }}</span>
      </div>

      <ion-card
        class="appointment-card border-primary !m-0 cursor-pointer border-l-4 shadow-lg"
        (click)="viewAppointment(currentAppointment)"
      >
        <ion-card-header>
          <ion-card-subtitle class="flex items-center gap-2">
            <app-icon name="clipboard-list" class="text-primary"></app-icon>
            {{ 'appointments.record' | translate }} #{{ currentAppointment.appointment_id }}
          </ion-card-subtitle>
          <ion-card-title class="text-lg">
            {{ formatMotive(currentAppointment.motive) }}
          </ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <!-- Glucose objective -->
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="flex flex-col">
              <span class="text-gray-500 dark:text-gray-400">
                {{ 'appointments.fields.glucoseObjective' | translate }}
              </span>
              <span class="font-semibold">{{ currentAppointment.glucose_objective }} mg/dL</span>
            </div>

            <div class="flex flex-col">
              <span class="text-gray-500 dark:text-gray-400">
                {{ 'appointments.fields.insulinType' | translate }}
              </span>
              <span class="font-semibold">{{
                formatInsulinType(currentAppointment.insulin_type)
              }}</span>
            </div>

            <div class="flex flex-col">
              <span class="text-gray-500 dark:text-gray-400">
                {{ 'appointments.fields.dose' | translate }}
              </span>
              <span class="font-semibold">{{ currentAppointment.dose }} U</span>
            </div>

            <div class="flex flex-col">
              <span class="text-gray-500 dark:text-gray-400">
                {{ 'appointments.fields.ratio' | translate }}
              </span>
              <span class="font-semibold">1:{{ currentAppointment.ratio }}</span>
            </div>
          </div>

          <!-- Control data -->
          <div
            *ngIf="currentAppointment.control_data"
            class="mt-3 border-t border-gray-200 pt-3 dark:border-gray-700"
          >
            <span class="text-sm text-gray-500 dark:text-gray-400">
              {{ 'appointments.fields.controlData' | translate }}
            </span>
            <p class="mt-1 text-sm">{{ currentAppointment.control_data }}</p>
          </div>

          <!-- Other treatment -->
          <div *ngIf="currentAppointment.another_treatment" class="mt-2">
            <span class="text-sm text-gray-500 dark:text-gray-400">
              {{ 'appointments.fields.otherTreatment' | translate }}
            </span>
            <p class="mt-1 text-sm">{{ currentAppointment.another_treatment }}</p>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Past Appointments (Collapsible) -->
    <div *ngIf="!loading && !error && pastAppointments.length > 0" class="mt-6">
      <div
        class="bg-base-200 flex cursor-pointer items-center justify-between rounded-lg px-4 py-3"
        (click)="pastAppointmentsExpanded = !pastAppointmentsExpanded"
      >
        <span class="text-sm font-medium text-gray-600 dark:text-gray-300">
          {{ 'appointments.past' | translate }} ({{ pastAppointments.length }})
        </span>
        <app-icon
          [name]="pastAppointmentsExpanded ? 'chevron-up' : 'chevron-down'"
          class="text-gray-500"
        ></app-icon>
      </div>

      <div *ngIf="pastAppointmentsExpanded" class="mt-3 flex flex-col gap-3">
        <ion-card
          *ngFor="let appointment of pastAppointments"
          class="appointment-card !m-0 cursor-pointer opacity-60 transition-opacity hover:opacity-80"
          (click)="viewAppointment(appointment)"
        >
          <ion-card-header class="pb-2">
            <ion-card-subtitle class="flex items-center gap-2 text-xs">
              <app-icon name="clipboard-list" class="text-gray-400"></app-icon>
              {{ 'appointments.record' | translate }} #{{ appointment.appointment_id }}
            </ion-card-subtitle>
            <ion-card-title class="text-base">
              {{ formatMotive(appointment.motive) }}
            </ion-card-title>
          </ion-card-header>

          <ion-card-content class="pt-0">
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div class="flex flex-col">
                <span class="text-gray-500 dark:text-gray-400">
                  {{ 'appointments.fields.glucoseObjective' | translate }}
                </span>
                <span class="font-medium">{{ appointment.glucose_objective }} mg/dL</span>
              </div>
              <div class="flex flex-col">
                <span class="text-gray-500 dark:text-gray-400">
                  {{ 'appointments.fields.dose' | translate }}
                </span>
                <span class="font-medium">{{ appointment.dose }} U</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </div>
  </div>
</ion-content>
