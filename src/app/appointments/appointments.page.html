<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>{{ 'appointments.title' | translate }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="createAppointment()" class="inline-flex items-center gap-2">
    <app-icon name="add"></app-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar color="primary">
    <ion-segment [(ngModel)]="selectedSegment" (ionChange)="onSegmentChange($event)">
      <ion-segment-button value="upcoming">
        <ion-label>{{ 'appointments.tabs.upcoming' | translate }}</ion-label>
      </ion-segment-button>
      <ion-segment-button value="past">
        <ion-label>{{ 'appointments.tabs.past' | translate }}</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="appointments-content">
  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="px-4 py-6">
    <!-- Loading spinner -->
    <div *ngIf="loading" class="flex flex-col items-center justify-center gap-4 py-12">
      <app-icon  name="loader-circle" class="animate-spin text-4xl text-primary"></app-icon>
      <p class="m-0 text-base text-gray-600 dark:text-gray-300">{{ 'appointments.loading' | translate }}</p>
    </div>

    <!-- Error message -->
    <ion-card *ngIf="error && !loading" color="danger" class="mb-4">
      <ion-card-content>
        <ion-text>
          <p>{{ error }}</p>
        </ion-text>
      </ion-card-content>
    </ion-card>

    <!-- Upcoming appointments -->
    <div *ngIf="selectedSegment === 'upcoming' && !loading">
      <!-- Empty state -->
      <ion-card *ngIf="upcomingAppointments.length === 0" class="empty-state mb-4">
        <ion-card-content class="flex flex-col items-center py-8 text-center">
          <span class="material-symbols-outlined large-icon">event_busy</span>
          <h2 class="mt-4 mb-2 text-xl font-semibold">{{ 'appointments.empty.upcoming.title' | translate }}</h2>
          <p class="mb-6 text-sm text-gray-600 dark:text-gray-400">{{ 'appointments.empty.upcoming.message' | translate }}</p>
          <ion-button (click)="createAppointment()" expand="block" class="w-full">
            {{ 'appointments.actions.schedule' | translate }}
          </ion-button>
        </ion-card-content>
      </ion-card>

      <!-- Appointments list -->
      <ion-list *ngIf="upcomingAppointments.length > 0" class="mb-4">
        <ion-item-sliding *ngFor="let appointment of upcomingAppointments" class="appointment-item-sliding">
          <ion-item button (click)="viewAppointment(appointment)" class="appointment-item">
            <ion-avatar slot="start">
              <div class="appointment-avatar">
                <app-icon name="person"></app-icon>
              </div>
            </ion-avatar>

            <ion-label>
              <h2>{{ appointment.doctorName || 'Doctor' }}</h2>
              <h3>{{ formatDate(appointment.date) }}</h3>
              <p>
                <app-icon  name="time-outline"></app-icon>
                {{ formatTime(appointment.startTime) }} - {{ formatTime(appointment.endTime) }}
              </p>
              <p *ngIf="appointment.reason">
                <app-icon  name="medical-outline"></app-icon>
                {{ appointment.reason }}
              </p>
            </ion-label>

            <ion-note slot="end" class="flex flex-col items-end gap-1">
              <ion-badge [color]="getStatusColor(appointment.status)">
                <span class="material-symbols-outlined badge-icon">{{
                  getStatusIcon(appointment.status)
                }}</span>
                {{ appointment.status }}
              </ion-badge>
              <ion-badge
                *ngIf="appointment.urgency !== 'routine'"
                [color]="getUrgencyColor(appointment.urgency)"
                class="urgency-badge"
              >
                {{ appointment.urgency }}
              </ion-badge>
            </ion-note>
          </ion-item>

          <ion-item-options side="end">
            <ion-item-option color="warning" class="flex items-center gap-2">
      <app-icon name="edit"></app-icon>
              {{ 'appointments.actions.edit' | translate }}
            </ion-item-option>
            <ion-item-option color="danger" class="flex items-center gap-2">
      <app-icon name="cancel"></app-icon>
              {{ 'appointments.actions.cancel' | translate }}
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      </ion-list>
    </div>

    <!-- Past appointments -->
    <div *ngIf="selectedSegment === 'past' && !loading">
      <!-- Empty state -->
      <ion-card *ngIf="pastAppointments.length === 0" class="empty-state mb-4">
        <ion-card-content class="flex flex-col items-center py-8 text-center">
          <span class="material-symbols-outlined large-icon">history</span>
          <h2 class="mt-4 mb-2 text-xl font-semibold">{{ 'appointments.empty.past.title' | translate }}</h2>
          <p class="mb-0 text-sm text-gray-600 dark:text-gray-400">{{ 'appointments.empty.past.message' | translate }}</p>
        </ion-card-content>
      </ion-card>

      <!-- Appointments list -->
      <ion-list *ngIf="pastAppointments.length > 0" class="mb-4">
        <ion-item
          *ngFor="let appointment of pastAppointments"
          button
          (click)="viewAppointment(appointment)"
          class="appointment-item mb-2"
        >
          <ion-avatar slot="start">
            <div class="appointment-avatar past">
              <app-icon name="person"></app-icon>
            </div>
          </ion-avatar>

          <ion-label>
            <h2>{{ appointment.doctorName || 'Doctor' }}</h2>
            <h3>{{ formatDate(appointment.date) }}</h3>
            <p>
              <app-icon  name="time-outline"></app-icon>
              {{ formatTime(appointment.startTime) }} - {{ formatTime(appointment.endTime) }}
            </p>
            <p *ngIf="appointment.reason">
              <app-icon  name="medical-outline"></app-icon>
              {{ appointment.reason }}
            </p>
          </ion-label>

          <ion-note slot="end" class="flex flex-col items-end gap-1">
            <ion-badge [color]="getStatusColor(appointment.status)">
              <span class="material-symbols-outlined badge-icon">{{
                getStatusIcon(appointment.status)
              }}</span>
              {{ appointment.status }}
            </ion-badge>
            <div *ngIf="appointment.glucoseDataShared" class="shared-indicator">
              <app-icon  name="share-outline" class="text-success"></app-icon>
              <small>{{ 'appointments.dataShared' | translate }}</small>
            </div>
          </ion-note>
        </ion-item>
      </ion-list>
    </div>
  </div>
</ion-content>
