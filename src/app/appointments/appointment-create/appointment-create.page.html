<ion-header>
  <ion-toolbar class="ion-padding-top">
    <ion-buttons slot="start">
      <ion-button (click)="cancel()">
        <app-icon name="close" slot="icon-only" aria-hidden="true"></app-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ 'appointments.create.title' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="mx-auto max-w-3xl">
    <form class="flex flex-col gap-4">
      <!-- Glucose Objective -->
      <ion-item
        lines="none"
        class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="w-full py-2">
          <ion-input
            type="number"
            label-placement="stacked"
            [(ngModel)]="formData.glucose_objective"
            name="glucose_objective"
            placeholder="100"
            min="0"
            required
            class="text-lg"
          >
            <div slot="label" class="mb-1 font-medium text-gray-700 dark:text-gray-300">
              {{ 'appointments.create.glucose_objective' | translate }}
              <span class="text-red-500">*</span>
            </div>
            <div slot="end" class="text-base-content/60 dark:text-base-content/80 text-sm">
              mg/dL
            </div>
          </ion-input>
        </div>
      </ion-item>

      <!-- Insulin Type -->
      <ion-item
        lines="none"
        class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="w-full py-2">
          <ion-select
            id="insulin-type-selector"
            label-placement="stacked"
            [(ngModel)]="formData.insulin_type"
            name="insulin_type"
            interface="popover"
            [placeholder]="'appointments.create.insulin_type' | translate"
            data-testid="insulin-type-selector"
          >
            <div slot="label" class="mb-1 font-medium text-gray-700 dark:text-gray-300">
              {{ 'appointments.create.insulin_type' | translate }}
              <span class="text-red-500">*</span>
            </div>
            @for (type of insulinTypes; track trackByInsulinType($index, type)) {
              <ion-select-option [value]="type.value">
                {{ type.label | translate }}
              </ion-select-option>
            }
          </ion-select>
        </div>
      </ion-item>

      <!-- Dose -->
      <ion-item
        lines="none"
        class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="w-full py-2">
          <ion-input
            type="number"
            label-placement="stacked"
            [(ngModel)]="formData.dose"
            name="dose"
            placeholder="0"
            min="0"
            step="0.1"
            required
            class="text-lg"
          >
            <div slot="label" class="mb-1 font-medium text-gray-700 dark:text-gray-300">
              {{ 'appointments.create.dose' | translate }}
              <span class="text-red-500">*</span>
            </div>
            <div slot="end" class="text-base-content/60 dark:text-base-content/80 text-sm">U</div>
          </ion-input>
        </div>
      </ion-item>

      <!-- Fast Insulin -->
      <ion-item
        lines="none"
        class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="w-full py-2">
          <ion-input
            type="text"
            label-placement="stacked"
            [(ngModel)]="formData.fast_insulin"
            name="fast_insulin"
            [placeholder]="'appointments.create.fast_insulin' | translate"
            required
          >
            <div slot="label" class="mb-1 font-medium text-gray-700 dark:text-gray-300">
              {{ 'appointments.create.fast_insulin' | translate }}
              <span class="text-red-500">*</span>
            </div>
          </ion-input>
        </div>
      </ion-item>

      <!-- Fixed Dose -->
      <ion-item
        lines="none"
        class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="w-full py-2">
          <ion-input
            type="number"
            label-placement="stacked"
            [(ngModel)]="formData.fixed_dose"
            name="fixed_dose"
            placeholder="0"
            min="0"
            step="0.1"
            required
          >
            <div slot="label" class="mb-1 font-medium text-gray-700 dark:text-gray-300">
              {{ 'appointments.create.fixed_dose' | translate }}
              <span class="text-red-500">*</span>
            </div>
            <div slot="end" class="text-base-content/60 dark:text-base-content/80 text-sm">U</div>
          </ion-input>
        </div>
      </ion-item>

      <!-- Ratio -->
      <ion-item
        lines="none"
        class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="w-full py-2">
          <ion-input
            type="number"
            label-placement="stacked"
            [(ngModel)]="formData.ratio"
            name="ratio"
            placeholder="0"
            min="0"
            step="0.1"
            required
          >
            <div slot="label" class="mb-1 font-medium text-gray-700 dark:text-gray-300">
              {{ 'appointments.create.ratio' | translate }}
              <span class="text-red-500">*</span>
            </div>
          </ion-input>
        </div>
      </ion-item>

      <!-- Sensitivity -->
      <ion-item
        lines="none"
        class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="w-full py-2">
          <ion-input
            type="number"
            label-placement="stacked"
            [(ngModel)]="formData.sensitivity"
            name="sensitivity"
            placeholder="0"
            min="0"
            step="0.1"
            required
          >
            <div slot="label" class="mb-1 font-medium text-gray-700 dark:text-gray-300">
              {{ 'appointments.create.sensitivity' | translate }}
              <span class="text-red-500">*</span>
            </div>
          </ion-input>
        </div>
      </ion-item>

      <!-- Pump Type -->
      <ion-item
        lines="none"
        class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="w-full py-2">
          <ion-select
            label-placement="stacked"
            [(ngModel)]="formData.pump_type"
            name="pump_type"
            interface="popover"
            [placeholder]="'appointments.create.pump_type' | translate"
            data-testid="pump-type-selector"
          >
            <div slot="label" class="mb-1 font-medium text-gray-700 dark:text-gray-300">
              {{ 'appointments.create.pump_type' | translate }}
              <span class="text-red-500">*</span>
            </div>
            @for (type of pumpTypes; track trackByPumpType($index, type)) {
              <ion-select-option [value]="type.value">
                {{ type.label | translate }}
              </ion-select-option>
            }
          </ion-select>
        </div>
      </ion-item>

      <!-- Motive (Checkboxes) -->
      <div class="ion-padding-vertical">
        <ion-label class="ion-padding-start font-medium">
          {{ 'appointments.create.motive' | translate }}
          <span class="text-red-500">*</span>
        </ion-label>
        <div
          class="mt-2 overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800"
        >
          @for (motive of motiveOptions; track trackByMotive($index, motive)) {
            <ion-item lines="full" class="last:border-b-0">
              <ion-checkbox
                [checked]="isMotiveSelected(motive.value)"
                (ionChange)="onMotiveChange(motive.value, $event)"
                slot="start"
              ></ion-checkbox>
              <ion-label>{{ motive.label | translate }}</ion-label>
            </ion-item>
          }
        </div>
      </div>

      <!-- Other Motive (conditional) -->
      @if (showOtherMotive) {
        <ion-item
          lines="none"
          class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800"
        >
          <div class="w-full py-2">
            <ion-input
              type="text"
              label-placement="stacked"
              [(ngModel)]="formData.other_motive"
              name="other_motive"
              [placeholder]="'appointments.create.other_motive' | translate"
            >
              <div slot="label" class="mb-1 font-medium text-gray-700 dark:text-gray-300">
                {{ 'appointments.create.other_motive' | translate }}
                <span class="text-red-500">*</span>
              </div>
            </ion-input>
          </div>
        </ion-item>
      }

      <!-- Another Treatment (optional) -->
      <ion-item
        lines="none"
        class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="w-full py-2">
          <ion-textarea
            label-placement="stacked"
            [(ngModel)]="formData.another_treatment"
            name="another_treatment"
            [placeholder]="'appointments.create.another_treatment' | translate"
            rows="3"
          >
            <div slot="label" class="mb-1 font-medium text-gray-700 dark:text-gray-300">
              {{ 'appointments.create.another_treatment' | translate }}
            </div>
          </ion-textarea>
        </div>
      </ion-item>

      <!-- Buttons -->
      <div class="ion-padding-top">
        <ion-button
          id="appointment-submit-btn"
          expand="block"
          (click)="submitAppointment()"
          [disabled]="isLoading"
          color="primary"
          data-testid="appointment-submit-btn"
        >
          <app-icon name="checkmark-circle" slot="start" aria-hidden="true"></app-icon>
          {{ 'appointments.create.submit' | translate }}
        </ion-button>

        <ion-button
          id="appointment-cancel-btn"
          expand="block"
          (click)="cancel()"
          [disabled]="isLoading"
          fill="outline"
          color="medium"
          data-testid="appointment-cancel-btn"
        >
          <app-icon name="close-circle" slot="start" aria-hidden="true"></app-icon>
          {{ 'common.cancel' | translate }}
        </ion-button>
      </div>
    </form>
  </div>
</ion-content>
