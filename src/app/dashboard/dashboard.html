<ion-header>
  <ion-toolbar>
    <ion-title>{{ 'dashboard.title' | translate }}</ion-title>
    <ion-buttons slot="end">
      <app-language-switcher displayMode="button" [showText]="false"></app-language-switcher>
      <ion-button (click)="onSync()" [disabled]="isSyncing">
        <ion-icon slot="icon-only" name="sync-outline" [class.spinning]="isSyncing"> </ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Pull to Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="mx-auto max-w-7xl px-4 py-6 md:px-6">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="flex min-h-[400px] flex-col items-center justify-center gap-4">
      <ion-spinner name="crescent" *ngIf="!isKarma"></ion-spinner>
      <p class="m-0 text-base text-gray-600 dark:text-gray-300">{{ 'app.loading' | translate }}</p>
    </div>

    <!-- Dashboard Content -->
    <ng-container *ngIf="!isLoading">
      <!-- Success Alert Banner -->
      <app-alert-banner
        *ngIf="showSuccessAlert"
        type="success"
        [message]="'messages.saveSuccess' | translate"
        [dismissible]="true"
        (dismissed)="onAlertDismissed()"
        class="alert-banner"
      >
      </app-alert-banner>

      <!-- Stats Grid (2x2) -->
      <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <!-- HbA1c Card -->
        <app-stat-card
          [title]="'readings.statistics.hba1c' | translate"
          [value]="formatPercentage(statistics?.estimatedA1C)"
          unit=""
          [icon]="icons.hba1c"
          [gradientColors]="gradients.hba1c"
        >
        </app-stat-card>

        <!-- Time in Range Card -->
        <app-stat-card
          [title]="'dashboard.timeInRange' | translate"
          [value]="formatPercentage(statistics?.timeInRange)"
          unit=""
          [icon]="icons.timeInRange"
          [gradientColors]="gradients.timeInRange"
        >
        </app-stat-card>

        <!-- Average Glucose Card -->
        <app-stat-card
          [title]="'dashboard.averageGlucose' | translate"
          [value]="formatGlucose(statistics?.average)"
          [unit]="getCurrentGlucoseUnit()"
          [icon]="icons.avgGlucose"
          [gradientColors]="gradients.avgGlucose"
        >
        </app-stat-card>

        <!-- GMI Card -->
        <app-stat-card
          [title]="'readings.statistics.gmi' | translate"
          [value]="formatPercentage(statistics?.gmi)"
          unit=""
          [icon]="icons.gmi"
          [gradientColors]="gradients.gmi"
        >
        </app-stat-card>
      </div>

      <!-- Upcoming Appointment Card -->
      <ion-card *ngIf="upcomingAppointment" class="appointment-card mb-6">
        <ion-card-header class="pb-2">
          <ion-card-subtitle class="text-sm font-medium text-gray-600 dark:text-gray-300">{{ 'dashboard.upcomingAppointments' | translate }}</ion-card-subtitle>
          <ion-card-title class="text-xl font-bold text-gray-900 dark:text-white">{{
            upcomingAppointment.doctorName || ('appointments.doctor' | translate)
          }}</ion-card-title>
        </ion-card-header>
        <ion-card-content class="pt-2">
          <ion-item lines="none">
            <ion-icon slot="start" name="calendar-outline" color="primary"></ion-icon>
            <ion-label>
              <p>{{ upcomingAppointment.date | date: 'fullDate' }}</p>
              <h3>{{ upcomingAppointment.startTime }} - {{ upcomingAppointment.endTime }}</h3>
            </ion-label>
            <ion-badge slot="end" color="primary">{{ getTimeUntilAppointment() }}</ion-badge>
          </ion-item>

          <ion-item lines="none" *ngIf="upcomingAppointment.reason">
            <ion-icon slot="start" name="medical-outline" color="medium"></ion-icon>
            <ion-label>
              <p>{{ 'appointments.reason' | translate }}</p>
              <h3>{{ upcomingAppointment.reason }}</h3>
            </ion-label>
          </ion-item>

          <div class="mt-4 flex flex-col gap-2">
            <ion-button
              expand="block"
              (click)="shareGlucoseData()"
              [disabled]="isSharingGlucose || !upcomingAppointment.glucoseDataShared"
            >
              <ion-spinner name="crescent" *ngIf="isSharingGlucose && !isKarma"></ion-spinner>
              <span *ngIf="!isSharingGlucose">
                <ion-icon slot="start" name="share-outline"></ion-icon>
                {{ 'dashboard.shareReadings' | translate }}
              </span>
            </ion-button>
            <ion-button expand="block" fill="outline" (click)="viewAppointmentDetails()">
              {{ 'common.viewDetails' | translate }}
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Quick Actions Card -->
      <ion-card class="quick-actions-card mb-6">
        <ion-card-header class="pb-2">
          <ion-card-title class="text-xl font-bold text-gray-900 dark:text-white">{{ 'dashboard.quickActions' | translate }}</ion-card-title>
        </ion-card-header>
        <ion-card-content class="pt-2">
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <ion-button
                  expand="block"
                  fill="outline"
                  (click)="addReading()"
                  class="quick-action-btn"
                >
                  <ion-icon slot="start" name="add-circle-outline"></ion-icon>
                  {{ 'dashboard.addReading' | translate }}
                </ion-button>
              </ion-col>
              <ion-col size="6">
                <ion-button
                  expand="block"
                  fill="outline"
                  (click)="onSync()"
                  [disabled]="isSyncing"
                  class="quick-action-btn"
                >
                  <ion-icon
                    slot="start"
                    name="sync-outline"
                    [class.spinning]="isSyncing"
                  ></ion-icon>
                  {{ 'dashboard.syncNow' | translate }}
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>
          <ion-item lines="none" class="sync-status">
            <ion-label>
              <p>{{ 'dashboard.lastSync' | translate }}: {{ getLastSyncDisplay() }}</p>
              <h4 *ngIf="syncStatus">
                {{ syncStatus.itemsSynced }} {{ 'sync.items' | translate }}
                <span *ngIf="syncStatus.itemsFailed > 0" class="sync-error">
                  ({{ syncStatus.itemsFailed }} {{ 'sync.failed' | translate }})
                </span>
              </h4>
            </ion-label>
          </ion-item>
        </ion-card-content>
      </ion-card>

      <!-- Recent Readings Section -->
      <div class="recent-readings-section mt-6">
        <div class="mb-4 flex items-center justify-between">
          <h2 class="m-0 text-xl font-bold text-gray-900 dark:text-white">{{ 'dashboard.recentReadings' | translate }}</h2>
          <ion-button fill="clear" size="small" routerLink="/tabs/readings" class="m-0 h-auto text-sm font-medium">
            {{ 'common.viewAll' | translate }}
            <ion-icon slot="end" name="chevron-forward-outline" class="text-base"></ion-icon>
          </ion-button>
        </div>

        <!-- Empty State -->
        <app-empty-state
          *ngIf="recentReadings.length === 0"
          illustration="fitness_center"
          [heading]="'dashboard.noReadings' | translate"
          [message]="'dashboard.noReadingsMessage' | translate"
          ctaText=""
        >
        </app-empty-state>

        <!-- Reading Items -->
        <div class="flex flex-col gap-3" *ngIf="recentReadings.length > 0">
          <app-reading-item *ngFor="let reading of recentReadings" [reading]="reading">
          </app-reading-item>
        </div>
      </div>
    </ng-container>
  </div>
</ion-content>
