<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ 'settings.title' | translate }}</ion-title>
    <ion-buttons slot="end">
      <ion-button
        (click)="saveSettings()"
        [disabled]="!hasChanges"
        class="inline-flex items-center gap-2 text-white"
        [attr.aria-label]="'common.save' | translate"
      >
        <app-icon name="save-outline" class="text-inherit"></app-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="pb-20" style="--padding-bottom: calc(5rem + env(safe-area-inset-bottom, 0px))">
  <div class="page-shell">
    <!-- Profile Section -->
    <ion-list-header class="px-4 pb-2.5 pt-5 text-xs font-semibold uppercase tracking-wider">
      <ion-label>{{ 'settings.sections.profile' | translate }}</ion-label>
    </ion-list-header>
    <ion-list class="mb-4">
      <ion-item button (click)="goToProfile()">
        <ion-avatar slot="start" class="h-12 w-12">
          <img src="assets/icon/favicon.png" [alt]="'settings.profile.avatarAlt' | translate" />
        </ion-avatar>
        <ion-label>
          <h2 class="mb-1 font-medium">{{ profileSettings.name || 'Usuario' }}</h2>
          <p class="text-sm">{{ profileSettings.email }}</p>
        </ion-label>
        <app-icon name="chevron-forward"></app-icon>
      </ion-item>
    </ion-list>

    <!-- Glucose Settings -->
    <ion-list-header class="px-4 pb-2.5 pt-5 text-xs font-semibold uppercase tracking-wider">
      <ion-label>{{ 'settings.sections.glucose' | translate }}</ion-label>
    </ion-list-header>
    <ion-list class="mb-4">
      <ion-item>
        <ion-label>{{ 'settings.glucose.unitLabel' | translate }}</ion-label>
        <ion-select
          [(ngModel)]="glucoseSettings.unit"
          (ionChange)="onGlucoseUnitChange($event)"
          interface="popover"
          class="max-w-[50%]"
        >
          <ion-select-option value="mg/dL">
            {{ 'settings.glucose.mgdl' | translate }}
          </ion-select-option>
          <ion-select-option value="mmol/L">
            {{ 'settings.glucose.mmol' | translate }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label>
          <h3 class="mb-1 font-medium">
            {{ 'settings.glucose.targetRange' | translate }}
          </h3>
          <p class="text-sm">
            {{ glucoseSettings.targetLow }} - {{ glucoseSettings.targetHigh }}
            {{ glucoseSettings.unit }}
          </p>
        </ion-label>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">
          {{ 'settings.glucose.minLabel' | translate }} ({{ glucoseSettings.unit }})
        </ion-label>
        <ion-range
          [(ngModel)]="glucoseSettings.targetLow"
          [min]="glucoseSettings.unit === 'mg/dL' ? 50 : 2.8"
          [max]="glucoseSettings.unit === 'mg/dL' ? 100 : 5.6"
          [step]="glucoseSettings.unit === 'mg/dL' ? 5 : 0.1"
          pin="true"
          (ionChange)="hasChanges = true"
          class="py-2"
        >
          <ion-label slot="start" class="text-xs">{{
            glucoseSettings.unit === 'mg/dL' ? 50 : 2.8
          }}</ion-label>
          <ion-label slot="end" class="text-xs">{{
            glucoseSettings.unit === 'mg/dL' ? 100 : 5.6
          }}</ion-label>
        </ion-range>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">
          {{ 'settings.glucose.maxLabel' | translate }} ({{ glucoseSettings.unit }})
        </ion-label>
        <ion-range
          [(ngModel)]="glucoseSettings.targetHigh"
          [min]="glucoseSettings.unit === 'mg/dL' ? 140 : 7.8"
          [max]="glucoseSettings.unit === 'mg/dL' ? 250 : 13.9"
          [step]="glucoseSettings.unit === 'mg/dL' ? 10 : 0.5"
          pin="true"
          (ionChange)="hasChanges = true"
          class="py-2"
        >
          <ion-label slot="start" class="text-xs">{{
            glucoseSettings.unit === 'mg/dL' ? 140 : 7.8
          }}</ion-label>
          <ion-label slot="end" class="text-xs">{{
            glucoseSettings.unit === 'mg/dL' ? 250 : 13.9
          }}</ion-label>
        </ion-range>
      </ion-item>
    </ion-list>

    <!-- Appearance Settings -->
    <ion-list-header class="px-4 pb-2.5 pt-5 text-xs font-semibold uppercase tracking-wider">
      <ion-label>{{ 'settings.sections.appearance' | translate }}</ion-label>
    </ion-list-header>
    <ion-list class="mb-4">
      <ion-item>
        <ion-label>{{ 'settings.appearance.themeLabel' | translate }}</ion-label>
        <ion-select
          [(ngModel)]="preferences.theme"
          (ionChange)="onThemeChange($event)"
          interface="popover"
          class="max-w-[50%]"
        >
          <ion-select-option value="light">
            {{ 'settings.appearance.themeLight' | translate }}
          </ion-select-option>
          <ion-select-option value="dark">
            {{ 'settings.appearance.themeDark' | translate }}
          </ion-select-option>
          <ion-select-option value="auto">
            {{ 'settings.appearance.themeAuto' | translate }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label>{{ 'settings.sections.language' | translate }}</ion-label>
        <ion-select
          [(ngModel)]="preferences.language"
          (ionChange)="onLanguageChange($event)"
          interface="popover"
          class="max-w-[50%]"
        >
          <ion-select-option value="es">
            {{ 'settings.language.es' | translate }}
          </ion-select-option>
          <ion-select-option value="en">
            {{ 'settings.language.en' | translate }}
          </ion-select-option>
        </ion-select>
      </ion-item>
    </ion-list>

    <!-- Notifications Settings -->
    <ion-list-header class="px-4 pb-2.5 pt-5 text-xs font-semibold uppercase tracking-wider">
      <ion-label>{{ 'settings.sections.notifications' | translate }}</ion-label>
    </ion-list-header>
    <ion-list class="mb-4">
      <!-- Web platform notification warning -->
      @if (isWebPlatform) {
        <ion-item lines="none" class="bg-warning/10">
          <app-icon name="alert-circle-outline" slot="start" class="text-warning"></app-icon>
          <ion-label class="ion-text-wrap">
            <p class="text-warning text-sm">
              {{ 'settings.notifications.webWarning' | translate }}
            </p>
          </ion-label>
        </ion-item>
      }

      <!-- Master notifications toggle -->
      <ion-item>
        <app-icon name="notifications-outline" slot="start"></app-icon>
        <ion-label>
          <h3 class="font-medium">{{ 'settings.notifications.enable' | translate }}</h3>
          <p class="text-sm">{{ 'settings.notifications.enableDesc' | translate }}</p>
        </ion-label>
        <ion-toggle
          [checked]="notificationsEnabled"
          (ionChange)="onNotificationsToggle($event)"
          slot="end"
          [attr.aria-label]="'settings.notifications.enable' | translate"
        ></ion-toggle>
      </ion-item>

      <!-- Reading Reminders -->
      @if (notificationsEnabled) {
        <ion-item lines="none" class="mt-2">
          <ion-label class="text-sm font-medium">
            {{ 'settings.notifications.readingReminders' | translate }}
          </ion-label>
        </ion-item>
        @for (reminder of readingReminders; track trackByReminder($index, reminder)) {
          <ion-item>
            <ion-label>
              <h3 class="font-medium">{{ reminder.label }}</h3>
              <p class="text-sm">{{ reminder.time }}</p>
            </ion-label>
            <ion-datetime
              presentation="time"
              [value]="'2024-01-01T' + reminder.time + ':00'"
              (ionChange)="onReminderTimeChange(reminder, $event)"
              class="ml-auto"
              style="max-width: 120px"
            ></ion-datetime>
            <ion-toggle
              [checked]="reminder.enabled"
              (ionChange)="onReminderToggle(reminder, $event)"
              slot="end"
              [attr.aria-label]="reminder.label"
            ></ion-toggle>
          </ion-item>
        }
        <!-- Test Notification Button -->
        <ion-item button (click)="testNotification()" data-testid="test-notification-btn">
          <app-icon name="notifications-outline" slot="start" class="text-warning"></app-icon>
          <ion-label>
            <h3 class="font-medium">{{ 'settings.notifications.test' | translate }}</h3>
            <p class="text-sm">{{ 'settings.notifications.testDesc' | translate }}</p>
          </ion-label>
        </ion-item>
      }
    </ion-list>

    <!-- Advanced Settings -->
    <ion-list-header class="px-4 pb-2.5 pt-5 text-xs font-semibold uppercase tracking-wider">
      <ion-label>{{ 'settings.sections.advanced' | translate }}</ion-label>
    </ion-list-header>
    <ion-list class="mb-4">
      <ion-item button (click)="goToAdvancedSettings()" class="flex items-center gap-2">
        <app-icon name="settings-outline"></app-icon>
        <ion-label>{{ 'settings.debug.advancedConfig' | translate }}</ion-label>
        <app-icon name="chevron-forward"></app-icon>
      </ion-item>

      <ion-item button (click)="signOut()" class="flex items-center gap-2">
        <app-icon name="log-out-outline" class="text-primary"></app-icon>
        <ion-label color="primary">
          {{ 'settings.signOut' | translate }}
        </ion-label>
      </ion-item>
    </ion-list>

    <!-- Demo Mode Notice -->
    @if (isDemoMode) {
      <ion-card class="demo-notice">
        <ion-card-content class="flex items-center gap-3 p-3">
          <app-icon
            name="information-circle-outline"
            class="text-warning shrink-0 text-2xl"
          ></app-icon>
          <p class="m-0 text-sm">
            {{ 'settings.demoMode' | translate }}
          </p>
        </ion-card-content>
      </ion-card>
    }

    <!-- Version Info -->
    <div class="p-5 text-center">
      <p class="text-base-content/60 dark:text-base-content/80 my-1 text-sm">
        {{ 'app.name' | translate }} v0.0.1
      </p>
      <p class="text-base-content/60 dark:text-base-content/80 my-1 text-sm">
        Â© 2024 {{ 'app.name' | translate }}
      </p>
    </div>
  </div>
</ion-content>
