<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="onCancel()">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ 'addReading.title' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="max-w-[600px] mx-auto p-4">
    <!-- Info Banner with Tip -->
    <div class="mb-6">
      <app-alert-banner type="info" [message]="'addReading.tip' | translate"></app-alert-banner>
    </div>

    <!-- Form -->
    <form [formGroup]="readingForm" (ngSubmit)="onSubmit()" class="flex flex-col gap-5">
      <!-- Glucose Value Input -->
      <div class="mb-1">
        <ion-item lines="none" class="form-item">
          <ion-label position="stacked" class="form-label">
            {{ 'addReading.glucoseLabel' | translate }} <span class="text-danger">*</span>
          </ion-label>
          <div class="input-with-unit">
            <ion-input
              formControlName="value"
              type="number"
              inputmode="decimal"
              [placeholder]="'addReading.glucosePlaceholder' | translate"
              class="glucose-input"
              [class.invalid]="
                readingForm.get('value')?.invalid && readingForm.get('value')?.touched
              "
            ></ion-input>
            <span class="text-lg font-medium text-medium whitespace-nowrap">{{ getUnitLabel() }}</span>
          </div>
        </ion-item>
        <div class="flex items-center gap-1.5 px-4 text-xs text-danger -mt-1" *ngIf="getValidationMessage('value')">
          <ion-icon name="alert-circle" color="danger" class="text-base"></ion-icon>
          <span>{{ getValidationMessage('value') }}</span>
        </div>
      </div>

      <!-- Status Preview -->
      <div class="status-preview" *ngIf="glucoseStatus">
        <div class="status-badge" [attr.data-status]="glucoseStatusColor">
          <span class="text-lg">{{ glucoseStatusEmoji }}</span>
          <span class="text-sm">{{ getStatusLabel() }}</span>
        </div>
      </div>

      <!-- Date & Time Picker -->
      <div class="mb-1">
        <ion-item lines="none" class="form-item">
          <ion-label position="stacked" class="form-label">
            {{ 'addReading.dateTimeLabel' | translate }} <span class="text-danger">*</span>
          </ion-label>
          <ion-datetime-button datetime="reading-datetime"></ion-datetime-button>
        </ion-item>

        <ion-modal [keepContentsMounted]="true">
          <ng-template>
            <ion-datetime
              id="reading-datetime"
              formControlName="datetime"
              presentation="date-time"
              [max]="readingForm.get('datetime')?.value"
              [preferWheel]="true"
            ></ion-datetime>
          </ng-template>
        </ion-modal>
      </div>

      <!-- Meal Context Selector -->
      <div class="mb-1">
        <ion-item lines="none" class="form-item">
          <ion-label position="stacked" class="form-label">
            {{ 'addReading.mealContext.label' | translate }}
          </ion-label>
          <ion-select
            formControlName="mealContext"
            [placeholder]="'addReading.mealContext.placeholder' | translate"
            interface="action-sheet"
            [cancelText]="'common.cancel' | translate"
            class="ion-select-full"
          >
            <ion-select-option [value]="null">{{ 'common.none' | translate }}</ion-select-option>
            <ion-select-option *ngFor="let option of mealContextOptions" [value]="option.value">
              {{ option.labelKey | translate }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </div>

      <!-- Notes Field -->
      <div class="mb-1">
        <ion-item lines="none" class="form-item">
          <ion-label position="stacked" class="form-label">
            {{ 'addReading.notes.label' | translate }}
          </ion-label>
          <ion-textarea
            formControlName="notes"
            [placeholder]="'addReading.notes.placeholder' | translate"
            rows="4"
            maxlength="500"
            class="notes-textarea"
          ></ion-textarea>
        </ion-item>
        <div class="text-right text-xs text-medium px-4 -mt-1">
          {{
            'addReading.notes.counter'
              | translate: { count: readingForm.get('notes')?.value?.length || 0, max: 500 }
          }}
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <ion-button
          expand="block"
          color="medium"
          fill="outline"
          (click)="onCancel()"
          [disabled]="isSubmitting"
          class="cancel-button"
        >
          {{ 'common.cancel' | translate }}
        </ion-button>
        <ion-button
          expand="block"
          type="submit"
          [disabled]="readingForm.invalid || isSubmitting"
          class="save-button"
        >
          <ion-spinner name="crescent" *ngIf="isSubmitting"></ion-spinner>
          <span *ngIf="!isSubmitting">{{ 'addReading.actions.save' | translate }}</span>
        </ion-button>
      </div>
    </form>
  </div>
</ion-content>
