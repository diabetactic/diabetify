<!-- Backdrop -->
@if (isOpen) {
  <div
    class="food-picker-backdrop"
    [class.food-picker-backdrop--visible]="isOpen"
    (click)="onBackdropClick()"
    [@fadeInOut]="isOpen ? 'visible' : 'hidden'"
    role="presentation"
  ></div>
}

<!-- Modal -->
<div
  class="food-picker-modal"
  [class.food-picker-modal--open]="isOpen"
  [@slideUp]="isOpen ? 'open' : 'closed'"
  role="dialog"
  [attr.aria-hidden]="!isOpen"
  aria-modal="true"
  aria-labelledby="food-picker-title"
>
  <!-- Handle bar -->
  <div class="food-picker-handle" aria-hidden="true">
    <div class="food-picker-handle-bar"></div>
  </div>

  <!-- Header -->
  <div class="food-picker-header">
    <div class="food-picker-title-row">
      <h2 id="food-picker-title" class="food-picker-title">
        {{ 'foodPicker.title' | translate }}
      </h2>
      <button
        class="food-picker-close"
        (click)="cancel()"
        [attr.aria-label]="'common.close' | translate"
        type="button"
      >
        <app-icon name="x" size="md"></app-icon>
      </button>
    </div>

    <!-- Search bar -->
    <div class="search-container">
      <ion-searchbar
        [placeholder]="'foodPicker.searchPlaceholder' | translate"
        (ionInput)="onSearchChange($event)"
        [value]="searchQuery()"
        mode="ios"
        class="food-picker-search"
        debounce="300"
      ></ion-searchbar>
      <ion-button (click)="scanBarcode()" color="secondary" class="scan-button">
        <app-icon name="barcode" size="md"></app-icon>
      </ion-button>
    </div>
  </div>

  <!-- Category tabs (only when not searching) -->
  @if (searchQuery().length < 2) {
    <div class="food-picker-categories">
      <div class="category-scroll">
        <button
          class="category-chip"
          [class.category-chip--active]="selectedCategory() === 'recent'"
          (click)="selectedCategory.set('recent')"
          type="button"
        >
          <span class="category-emoji">üïí</span>
          <span class="category-name">{{ 'foodPicker.categories.recent' | translate }}</span>
        </button>
        <button
          class="category-chip"
          [class.category-chip--active]="selectedCategory() === 'favorites'"
          (click)="selectedCategory.set('favorites')"
          type="button"
        >
          <span class="category-emoji">‚≠ê</span>
          <span class="category-name">{{ 'foodPicker.categories.favorites' | translate }}</span>
        </button>
        @for (cat of categories; track cat.key) {
          <button
            class="category-chip"
            [class.category-chip--active]="selectedCategory() === cat.key"
            (click)="selectedCategory.set(cat.key)"
            type="button"
          >
            <span class="category-emoji">{{ cat.emoji }}</span>
            <span class="category-name">{{ cat.nameKey | translate }}</span>
          </button>
        }
      </div>
    </div>
  }

  <!-- Food list -->
  <div class="food-picker-content">
    <div class="food-list">
      @for (food of displayedFoods(); track food.id) {
        <div class="food-item" [class.food-item--selected]="isSelected(food.id)">
          <button
            class="food-item-main"
            (click)="isSelected(food.id) ? removeFood(food.id) : addFood(food)"
            type="button"
          >
            <span class="food-emoji">{{ food.emoji }}</span>
            <div class="food-info">
              <span class="food-name">{{ food.nameKey | translate }}</span>
              <span class="food-serving">{{ getServingText(food) }}</span>
            </div>
            <div class="food-carbs">
              <span class="carbs-value">{{ food.carbsPerServing }}</span>
              <span class="carbs-unit">{{ 'foodPicker.carbsUnit' | translate }}</span>
            </div>
          </button>

          <!-- Quantity controls when selected -->
          @if (isSelected(food.id)) {
            <div class="food-quantity">
              <button
                class="qty-btn"
                (click)="updateServings(food.id, -0.5); $event.stopPropagation()"
                type="button"
                [attr.aria-label]="'foodPicker.decrease' | translate"
              >
                <app-icon name="minus" size="sm"></app-icon>
              </button>
              <span class="qty-value">
                {{ getSelectedFood(food.id)?.servings }}
              </span>
              <button
                class="qty-btn"
                (click)="updateServings(food.id, 0.5); $event.stopPropagation()"
                type="button"
                [attr.aria-label]="'foodPicker.increase' | translate"
              >
                <app-icon name="plus" size="sm"></app-icon>
              </button>
              <span class="qty-carbs"> {{ getSelectedFood(food.id)?.totalCarbs }}g </span>
            </div>
          }
        </div>
      } @empty {
        <div class="food-empty">
          <span class="food-empty-icon">üîç</span>
          <p>{{ 'foodPicker.noResults' | translate }}</p>
        </div>
      }
    </div>
    <!-- Manual Entry -->
    <div class="manual-entry">
      <button (click)="showManualEntry = true" class="manual-entry-btn">
        {{ 'foodPicker.manualEntry' | translate }}
      </button>
      @if (showManualEntry) {
        <div class="manual-entry-form">
          <label class="form-label mb-2 block" for="manual-food-name">
            {{ 'foodPicker.foodName' | translate }}
          </label>
          <input
            id="manual-food-name"
            [(ngModel)]="manualFoodName"
            [placeholder]="'foodPicker.foodName' | translate"
          />

          <label class="form-label mb-2 mt-4 block" for="manual-carbs">
            {{ 'foodPicker.carbs' | translate }}
          </label>
          <input
            id="manual-carbs"
            [(ngModel)]="manualCarbs"
            type="number"
            [placeholder]="'foodPicker.carbs' | translate"
          />
          <ion-button (click)="addManualFood()">{{ 'common.add' | translate }}</ion-button>
          <ion-button (click)="showManualEntry = false" fill="clear">
            {{ 'common.cancel' | translate }}
          </ion-button>
        </div>
      }
    </div>
  </div>

  <!-- Footer with totals and actions -->
  <div class="food-picker-footer">
    <!-- Selected summary -->
    @if (selectedCount() > 0) {
      <div class="selected-summary">
        <div class="summary-items">
          <span class="summary-count">
            {{ selectedCount() }} {{ 'foodPicker.itemsSelected' | translate }}
          </span>
          <button class="clear-btn" (click)="clearAll()" type="button">
            {{ 'foodPicker.clearAll' | translate }}
          </button>
        </div>
        <div class="summary-total">
          <span class="total-label">{{ 'foodPicker.totalCarbs' | translate }}</span>
          <span class="total-value">{{ totalCarbs() }}g</span>
        </div>
      </div>
    }

    <!-- Actions -->
    <div class="food-picker-actions">
      <ion-button fill="outline" (click)="cancel()" class="action-btn">
        {{ 'common.cancel' | translate }}
      </ion-button>
      <ion-button
        (click)="confirm()"
        [disabled]="selectedCount() === 0"
        class="action-btn action-btn--confirm"
      >
        <app-icon name="check" slot="start" size="sm"></app-icon>
        {{ 'foodPicker.confirm' | translate }} ({{ totalCarbs() }}g)
      </ion-button>
    </div>
  </div>
</div>
