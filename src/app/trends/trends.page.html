<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>{{ 'trends.title' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
  <ion-header collapse="condense">
    <ion-toolbar class="ion-padding-top">
      <ion-title size="large">{{ 'trends.title' | translate }}</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="page-shell">
    <!-- Period Selector -->
    <ion-segment [value]="selectedPeriod()" (ionChange)="onPeriodChange($event)" class="mb-4">
      <ion-segment-button value="week">
        <ion-label>{{ 'trends.period.week' | translate }}</ion-label>
      </ion-segment-button>
      <ion-segment-button value="month">
        <ion-label>{{ 'trends.period.month' | translate }}</ion-label>
      </ion-segment-button>
      <ion-segment-button value="all">
        <ion-label>{{ 'trends.period.all' | translate }}</ion-label>
      </ion-segment-button>
    </ion-segment>

    @if (loading()) {
      <div class="flex items-center justify-center py-12">
        <ion-spinner name="circular"></ion-spinner>
      </div>
    } @else if (statistics() && statistics()!.totalReadings > 0) {
      <!-- Statistics Cards -->
      <div class="mb-6 grid grid-cols-2 gap-4">
        <!-- A1C Card -->
        <ion-card class="m-0">
          <ion-card-content class="p-4">
            <div class="mb-1 text-sm text-gray-500 dark:text-gray-400">
              {{ 'trends.estimatedA1c' | translate }}
            </div>
            <div class="text-primary text-2xl font-bold">{{ statistics()!.estimatedA1C }}%</div>
          </ion-card-content>
        </ion-card>

        <!-- Average Glucose Card -->
        <ion-card class="m-0">
          <ion-card-content class="p-4">
            <div class="mb-1 text-sm text-gray-500 dark:text-gray-400">
              {{ 'trends.averageGlucose' | translate }}
            </div>
            <div class="text-primary text-2xl font-bold">
              {{ statistics()!.average }}
              <span class="text-sm font-normal">{{ preferredUnit() }}</span>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Glucose Readings Chart -->
      <ion-card>
        <ion-card-header class="flex items-center justify-between">
          <ion-card-title>{{ 'trends.glucoseReadings' | translate }}</ion-card-title>
          <ion-button (click)="exportChart()" [attr.aria-label]="'trends.exportChart' | translate">
            <app-icon name="download-outline" slot="icon-only" aria-hidden="true"></app-icon>
          </ion-button>
        </ion-card-header>
        <ion-card-content>
          <div class="h-64 w-full">
            <canvas
              baseChart
              [data]="lineChartData"
              [type]="lineChartType"
              [options]="lineChartOptions"
            ></canvas>
          </div>
        </ion-card-content>
      </ion-card>
    } @else {
      <div class="flex min-h-[50vh] flex-col items-center justify-center text-center">
        <app-icon name="trending_up" size="xl" class="text-primary mb-4"></app-icon>
        <h2 class="text-base-content mb-3 text-2xl font-semibold">
          {{ 'trends.noData' | translate }}
        </h2>
        <p class="text-base-content/60 max-w-md text-base">
          {{ 'trends.noDataMessage' | translate }}
        </p>
      </div>
    }
  </div>
</ion-content>
