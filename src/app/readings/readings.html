<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>{{ 'tabs.readings' | translate }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="openFilterModal()" class="relative">
        <ion-icon slot="icon-only" name="filter-outline"></ion-icon>
        <ion-badge *ngIf="getFilterCount() > 0" color="primary" class="absolute top-2 right-2 min-w-4 h-4 text-[10px] px-1 py-0.5">{{ getFilterCount() }}</ion-badge>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Search Bar -->
  <ion-toolbar color="primary" class="px-4 py-2">
    <ion-searchbar
      [(ngModel)]="searchTerm"
      (ionInput)="onSearchChange($event)"
      [placeholder]="'readings.searchPlaceholder' | translate"
      [debounce]="300"
      animated="true"
      showCancelButton="focus"
      (ionClear)="clearSearch()"
    >
    </ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      [pullingText]="'common.pullToRefresh' | translate"
      refreshingSpinner="circles"
      [refreshingText]="'common.refreshing' | translate"
    >
    </ion-refresher-content>
  </ion-refresher>

  <!-- Active Filters Chips -->
  <div class="flex items-center gap-2 px-4 py-3 bg-[var(--ion-color-light)] border-b border-[var(--ion-color-light-shade)] overflow-x-auto whitespace-nowrap" *ngIf="hasActiveFilters()">
    <ion-chip
      *ngIf="filters.status && filters.status !== 'all'"
      (click)="clearFilters()"
      color="primary"
      class="m-0 cursor-pointer"
    >
      <ion-label>{{ getStatusLabel(filters.status) }}</ion-label>
      <ion-icon name="close-circle"></ion-icon>
    </ion-chip>
    <ion-chip *ngIf="filters.startDate" (click)="clearFilters()" color="primary" class="m-0 cursor-pointer">
      <ion-label
        >{{ filters.startDate | date: 'MMM d' }} - {{ filters.endDate | date: 'MMM d' }}</ion-label
      >
      <ion-icon name="close-circle"></ion-icon>
    </ion-chip>
    <ion-chip *ngIf="filters.searchTerm" (click)="clearSearch()" color="primary" class="m-0 cursor-pointer">
      <ion-label>{{ 'readings.search' | translate }}: {{ filters.searchTerm }}</ion-label>
      <ion-icon name="close-circle"></ion-icon>
    </ion-chip>
    <ion-button fill="clear" size="small" (click)="clearFilters()" class="shrink-0">{{
      'readings.clearAll' | translate
    }}</ion-button>
  </div>

  <!-- Loading State -->
  <div class="flex flex-col items-center justify-center min-h-[300px] p-8" *ngIf="isLoading">
    <ion-spinner name="circular" class="mb-4"></ion-spinner>
    <p class="text-[var(--ion-color-medium)] text-sm m-0">{{ 'readings.loadingReadings' | translate }}</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && totalCount === 0" class="flex items-center justify-center min-h-[400px] p-8">
    <app-empty-state
      illustration="description"
      [heading]="'readings.noReadings' | translate"
      [message]="'readings.noReadingsMessage' | translate"
      [ctaText]="'readings.addReading' | translate"
      (ctaClick)="addReading()"
    >
    </app-empty-state>
  </div>

  <!-- No Results State (after filtering) -->
  <div
    *ngIf="!isLoading && totalCount > 0 && filteredReadings.length === 0"
    class="flex items-center justify-center min-h-[400px] p-8"
  >
    <app-empty-state
      illustration="search"
      [heading]="'readings.noResults' | translate"
      [message]="'readings.noResultsMessage' | translate"
      [ctaText]="'readings.clearFilters' | translate"
      (ctaClick)="clearFilters()"
    >
    </app-empty-state>
  </div>

  <!-- Readings Count -->
  <div class="px-4 py-3 pb-2 border-b border-[var(--ion-color-light-shade)]" *ngIf="!isLoading && filteredReadings.length > 0">
    <ion-text color="medium">
      <p class="m-0 text-[13px] text-center">
        {{ 'readings.showing' | translate }} {{ filteredReadings.length }}
        {{ 'readings.of' | translate }} {{ totalCount }} {{ 'readings.readings' | translate }}
        <span *ngIf="hasActiveFilters()"> ({{ 'readings.filtered' | translate }})</span>
      </p>
    </ion-text>
  </div>

  <!-- Grouped Readings List with Virtual Scrolling -->
  <div class="pb-20" *ngIf="!isLoading && groupedReadings.length > 0">
    <!-- Group by Date -->
    <div *ngFor="let group of groupedReadings; trackBy: trackByGroup" class="mb-6 last:mb-0">
      <!-- Date Header -->
      <div class="flex items-center justify-between px-4 py-4 pb-2 bg-[var(--ion-background-color)] sticky top-0 z-10 border-b-2 border-[var(--ion-color-primary)]">
        <ion-text>
          <h2 class="m-0 text-lg font-semibold text-[var(--ion-color-dark)]">{{ group.displayDate }}</h2>
        </ion-text>
        <ion-text color="medium">
          <p class="m-0 text-[13px]">
            {{ group.readings.length }}
            {{
              group.readings.length !== 1
                ? ('readings.readings' | translate)
                : ('readings.reading' | translate)
            }}
          </p>
        </ion-text>
      </div>

      <!-- Readings in this group -->
      <div class="px-4 py-2 m-0">
        <div
          *ngFor="let reading of group.readings; trackBy: trackByReading"
          class="cursor-pointer transition-transform duration-200 ease-in-out active:scale-[0.98]"
          (click)="onReadingClick(reading)"
        >
          <app-reading-item [reading]="reading" class="block w-full"></app-reading-item>
        </div>
      </div>
    </div>
  </div>

  <!-- Scroll to Top Button -->
  <ion-fab
    vertical="bottom"
    horizontal="end"
    slot="fixed"
    class="!bottom-20"
    *ngIf="groupedReadings.length > 2"
  >
    <ion-fab-button size="small" (click)="scrollToTop()" color="light" class="shadow-[0_4px_12px_rgb(0_0_0_/_0.15)]">
      <ion-icon name="arrow-up"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Add Reading FAB -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="addReading()" color="primary" class="shadow-[0_4px_12px_rgb(0_0_0_/_0.15)]">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>

<!-- Filter Modal -->
<ion-modal [isOpen]="isFilterModalOpen" (didDismiss)="closeFilterModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ 'readings.filterReadings' | translate }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeFilterModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <!-- Status Filter -->
      <div class="mb-6">
        <ion-list-header class="!px-0 !pr-0 mb-2">
          <ion-label class="text-sm font-semibold uppercase text-[var(--ion-color-medium)]">{{ 'readings.glucoseStatus' | translate }}</ion-label>
        </ion-list-header>
        <ion-list class="!p-0">
          <ion-item>
            <ion-select
              [(ngModel)]="filters.status"
              [placeholder]="'readings.selectStatus' | translate"
              interface="popover"
            >
              <ion-select-option value="all">{{
                'readings.filter.all' | translate
              }}</ion-select-option>
              <ion-select-option value="normal">{{
                'glucose.status.normal' | translate
              }}</ion-select-option>
              <ion-select-option value="low">{{
                'glucose.status.low' | translate
              }}</ion-select-option>
              <ion-select-option value="critical-low">{{
                'glucose.status.veryLow' | translate
              }}</ion-select-option>
              <ion-select-option value="high">{{
                'glucose.status.high' | translate
              }}</ion-select-option>
              <ion-select-option value="critical-high">{{
                'glucose.status.veryHigh' | translate
              }}</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-list>
      </div>

      <!-- Date Range Filter -->
      <div class="mb-6">
        <ion-list-header class="!px-0 !pr-0 mb-2">
          <ion-label class="text-sm font-semibold uppercase text-[var(--ion-color-medium)]">{{ 'readings.dateRange' | translate }}</ion-label>
        </ion-list-header>
        <ion-list class="!p-0">
          <ion-item>
            <ion-label position="stacked">{{ 'readings.startDate' | translate }}</ion-label>
            <ion-datetime-button datetime="startDatetime"></ion-datetime-button>
            <ion-modal [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime
                  id="startDatetime"
                  [(ngModel)]="filters.startDate"
                  presentation="date"
                  [max]="filters.endDate || undefined"
                >
                </ion-datetime>
              </ng-template>
            </ion-modal>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">{{ 'readings.endDate' | translate }}</ion-label>
            <ion-datetime-button datetime="endDatetime"></ion-datetime-button>
            <ion-modal [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime
                  id="endDatetime"
                  [(ngModel)]="filters.endDate"
                  presentation="date"
                  [min]="filters.startDate || undefined"
                >
                </ion-datetime>
              </ng-template>
            </ion-modal>
          </ion-item>
        </ion-list>
      </div>

      <!-- Quick Date Filters -->
      <div class="mb-6">
        <ion-list-header class="!px-0 !pr-0 mb-2">
          <ion-label class="text-sm font-semibold uppercase text-[var(--ion-color-medium)]">{{ 'readings.quickFilters' | translate }}</ion-label>
        </ion-list-header>
        <ion-button expand="block" fill="outline" (click)="setFilterAllTime()" class="mt-2 first:mt-0">
          {{ 'readings.filter.all' | translate }}
        </ion-button>
        <ion-button expand="block" fill="outline" (click)="setFilterLast24Hours()" class="mt-2 first:mt-0">
          {{ 'readings.filter.last24Hours' | translate }}
        </ion-button>
        <ion-button expand="block" fill="outline" (click)="setFilterLast7Days()" class="mt-2 first:mt-0">
          {{ 'readings.filter.last7Days' | translate }}
        </ion-button>
        <ion-button expand="block" fill="outline" (click)="setFilterLast30Days()" class="mt-2 first:mt-0">
          {{ 'readings.filter.last30Days' | translate }}
        </ion-button>
      </div>

      <!-- Action Buttons -->
      <div class="mt-8 pb-4">
        <ion-button expand="block" (click)="applyFiltersAndCloseModal()" class="mt-3 first:mt-0">
          {{ 'readings.applyFilters' | translate }}
        </ion-button>
        <ion-button expand="block" fill="clear" (click)="clearFiltersAndCloseModal()" class="mt-3 first:mt-0">
          {{ 'readings.clearAll' | translate }}
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
