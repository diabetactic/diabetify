# GitLab CI/CD Configuration for Diabetify
# Free tier: 400 CI/CD minutes/month (unlimited with self-hosted runners)
# Migration from CircleCI - optimized for Angular/Ionic/Capacitor

stages:
  - install
  - quality
  - build
  - test
  - deploy

# Cache node_modules between jobs
.node_cache: &node_cache
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - node_modules/
      - .angular/cache/
    policy: pull-push

# Base job template
.node_job:
  image: node:22-alpine
  <<: *node_cache
  before_script:
    - corepack enable
    - corepack prepare pnpm@latest --activate
    - pnpm config set store-dir .pnpm-store

# Install dependencies (runs once, cached for other jobs)
install:
  extends: .node_job
  stage: install
  script:
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# Lint check
lint:
  extends: .node_job
  stage: quality
  needs: [install]
  script:
    - pnpm run lint
  allow_failure: true # Warnings shouldn't block

# Format check
format:
  extends: .node_job
  stage: quality
  needs: [install]
  script:
    - pnpm run format:check
  allow_failure: false

# Unit tests
test:unit:
  extends: .node_job
  stage: test
  needs: [install]
  script:
    - pnpm test -- --ci --coverage --maxWorkers=2
  coverage: '/Statements\s*:\s*(\d+\.?\d*)%/'
  artifacts:
    when: always
    paths:
      - coverage/
      - test-results/
    reports:
      junit: test-results/jest/junit.xml
    expire_in: 7 days

# Production build
build:prod:
  extends: .node_job
  stage: build
  needs: [install, lint, format]
  script:
    - pnpm run build:prod
  artifacts:
    paths:
      - www/
    expire_in: 1 week

# Android build (only on master)
build:android:
  extends: .node_job
  stage: build
  needs: [build:prod]
  image: cimg/android:2024.11-node # Android SDK image
  only:
    - master
    - main
  script:
    - pnpm run mobile:sync
    - cd android && ./gradlew assembleDebug
  artifacts:
    paths:
      - android/app/build/outputs/apk/debug/*.apk
    expire_in: 30 days

# Deploy to GitLab Pages (static hosting)
pages:
  stage: deploy
  needs: [build:prod]
  only:
    - master
    - main
  script:
    - mv www public
  artifacts:
    paths:
      - public
    expire_in: 30 days

# E2E Tests (manual trigger to save minutes)
test:e2e:
  extends: .node_job
  stage: test
  needs: [build:prod]
  when: manual
  script:
    - npx playwright install chromium --with-deps
    - pnpm run test:e2e
  artifacts:
    when: always
    paths:
      - playwright/artifacts/
    expire_in: 7 days

# Dependency security scan
security:
  extends: .node_job
  stage: quality
  needs: [install]
  script:
    - pnpm audit --audit-level=high
  allow_failure: true

# Variables
variables:
  PNPM_HOME: /root/.local/share/pnpm
  FF_USE_FASTZIP: 'true'
  ARTIFACT_COMPRESSION_LEVEL: fast
