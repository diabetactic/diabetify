# Android App Signing Guide - Diabetactic

## Overview

Android app signing is required for production deployment. This guide covers keystore generation, signing configuration, and best practices for the Diabetactic application.

## Understanding App Signing

### Why Signing Matters

- **Identity Verification**: Proves the APK comes from a trusted source
- **Update Security**: Only apps signed with the same key can update existing installations
- **Play Store Requirement**: Google Play requires all apps to be signed
- **Integrity Protection**: Prevents tampering with APK contents

### Signing Types

| Type    | Use Case              | Keystore                 | Security     |
| ------- | --------------------- | ------------------------ | ------------ |
| Debug   | Development & testing | Auto-generated by SDK    | Low (shared) |
| Release | Production            | Custom keystore (secure) | High         |

## Debug Signing (Development)

### Default Debug Keystore

Android Studio automatically creates a debug keystore:

**Location**: `~/.android/debug.keystore`

**Credentials** (default):

- **Keystore Password**: `android`
- **Key Alias**: `androiddebugkey`
- **Key Password**: `android`

### Current Configuration

In `android/app/build.gradle`:

```groovy
signingConfigs {
    debug {
        storeFile file(System.properties['user.home'] + '/.android/debug.keystore')
        storePassword 'android'
        keyAlias 'androiddebugkey'
        keyPassword 'android'
    }
}
buildTypes {
    debug {
        signingConfig signingConfigs.debug
    }
}
```

### Build Debug APK

```bash
cd android
./gradlew assembleDebug

# Output: android/app/build/outputs/apk/debug/app-debug.apk
```

### Debug Keystore Notes

- **DO NOT use for production** - credentials are public knowledge
- **Valid for 365 days** from creation
- **Shared across all developers** - can cause confusion
- **Cannot be uploaded to Play Store**

## Release Signing (Production)

### Step 1: Generate Production Keystore

```bash
# Navigate to a secure directory
cd ~/keystores  # Create this directory with restricted permissions
mkdir -p ~/keystores
chmod 700 ~/keystores

# Generate keystore with keytool (included with JDK)
keytool -genkeypair \
  -v \
  -keystore diabetactic-release.jks \
  -alias diabetactic-key \
  -keyalg RSA \
  -keysize 2048 \
  -validity 10000 \
  -storepass YOUR_KEYSTORE_PASSWORD \
  -keypass YOUR_KEY_PASSWORD \
  -dname "CN=Hospital Name, OU=IT Department, O=Hospital Organization, L=City, ST=State, C=Country_Code"
```

**Parameter Explanation**:

- `-keystore`: Filename for the keystore
- `-alias`: Name to identify this key (use for signing)
- `-keyalg RSA`: Encryption algorithm
- `-keysize 2048`: Key strength (2048 or 4096 recommended)
- `-validity 10000`: Validity in days (~27 years)
- `-storepass`: Password to access keystore
- `-keypass`: Password to access specific key
- `-dname`: Distinguished Name (your organization info)

**Interactive Mode** (if you prefer prompts):

```bash
keytool -genkeypair -v -keystore diabetactic-release.jks -alias diabetactic-key -keyalg RSA -keysize 2048 -validity 10000
# You'll be prompted for passwords and organization details
```

### Step 2: Verify Keystore

```bash
# List contents
keytool -list -v -keystore diabetactic-release.jks -storepass YOUR_KEYSTORE_PASSWORD

# Expected output:
# Alias name: diabetactic-key
# Creation date: Nov 30, 2025
# Entry type: PrivateKeyEntry
# Certificate fingerprints:
#   SHA1: XX:XX:XX:...
#   SHA256: XX:XX:XX:...
```

### Step 3: Configure Gradle for Release Signing

#### Option A: Using keystore.properties (Recommended)

Create `android/keystore.properties` (DO NOT commit to git):

```properties
storeFile=/home/username/keystores/diabetactic-release.jks
storePassword=YOUR_KEYSTORE_PASSWORD
keyAlias=diabetactic-key
keyPassword=YOUR_KEY_PASSWORD
```

Update `android/app/build.gradle`:

```groovy
// Load keystore properties
def keystorePropertiesFile = rootProject.file("keystore.properties")
def keystoreProperties = new Properties()
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

android {
    ...
    signingConfigs {
        debug {
            storeFile file(System.properties['user.home'] + '/.android/debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
        release {
            storeFile file(keystoreProperties['storeFile'])
            storePassword keystoreProperties['storePassword']
            keyAlias keystoreProperties['keyAlias']
            keyPassword keystoreProperties['keyPassword']
        }
    }
    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            signingConfig signingConfigs.release
        }
    }
}
```

#### Option B: Environment Variables

Set environment variables:

```bash
export DIABETACTIC_KEYSTORE_FILE=/home/username/keystores/diabetactic-release.jks
export DIABETACTIC_KEYSTORE_PASSWORD=YOUR_KEYSTORE_PASSWORD
export DIABETACTIC_KEY_ALIAS=diabetactic-key
export DIABETACTIC_KEY_PASSWORD=YOUR_KEY_PASSWORD
```

Update `android/app/build.gradle`:

```groovy
android {
    ...
    signingConfigs {
        release {
            storeFile file(System.getenv("DIABETACTIC_KEYSTORE_FILE") ?: "")
            storePassword System.getenv("DIABETACTIC_KEYSTORE_PASSWORD")
            keyAlias System.getenv("DIABETACTIC_KEY_ALIAS")
            keyPassword System.getenv("DIABETACTIC_KEY_PASSWORD")
        }
    }
    buildTypes {
        release {
            signingConfig signingConfigs.release
        }
    }
}
```

### Step 4: Build Signed Release APK

```bash
# Ensure keystore is configured
cd android

# Clean previous builds
./gradlew clean

# Build signed release APK
./gradlew assembleRelease

# Output location:
# android/app/build/outputs/apk/release/app-release.apk
```

### Step 5: Verify Signature

```bash
# Check signature
jarsigner -verify -verbose -certs app-release.apk

# Expected output:
# jar verified.
# The signer certificate will expire on...

# View detailed signature info
keytool -printcert -jarfile app-release.apk
```

## Google Play Store Signing

### Play App Signing (Recommended)

Google Play offers to manage your app signing key for you.

**Benefits**:

- Google securely stores your signing key
- You upload APKs signed with an "upload key"
- Google re-signs with the app signing key before distribution
- Lost upload key can be reset (app signing key is safe)

**Setup Process**:

1. Generate **upload keystore** (same as release keystore above)
2. Build signed APK with upload key
3. Create app in Google Play Console
4. Opt in to "Play App Signing" during first upload
5. Download Play Encrypt Private Key (PEPK) tool
6. Export your app signing key to Google:

```bash
java -jar pepk.jar \
  --keystore=diabetactic-release.jks \
  --alias=diabetactic-key \
  --output=encrypted_private_key_path \
  --encryptionkey=YOUR_PLAY_CONSOLE_ENCRYPTION_KEY
```

7. Upload encrypted key to Play Console

### Upload Key vs App Signing Key

| Key Type        | Purpose               | Storage Location | Can Reset? |
| --------------- | --------------------- | ---------------- | ---------- |
| Upload Key      | Sign APKs you upload  | Your keystore    | Yes        |
| App Signing Key | Sign distributed APKs | Google servers   | No         |
| Debug Key       | Development only      | Local machine    | N/A        |

## Keystore Security Best Practices

### Storage & Backup

#### DO:

- Store keystore in a **secure, encrypted location**
- Backup keystore to **multiple secure locations** (encrypted drives, safe deposit box)
- Use a **password manager** for keystore passwords
- Restrict file permissions: `chmod 600 diabetactic-release.jks`
- Document keystore details (without passwords) in secure wiki
- Test keystore backup restoration regularly

#### DON'T:

- Commit keystore to version control (git, SVN)
- Email keystore or passwords
- Store passwords in plain text files
- Share keystore with unauthorized personnel
- Use weak passwords (minimum 12 characters, mixed case, numbers, symbols)

### Password Guidelines

**Keystore Password**:

- Minimum 12 characters
- Mix of uppercase, lowercase, numbers, symbols
- Not based on dictionary words
- Unique (don't reuse from other systems)

**Key Password**:

- Can be same as keystore password for simplicity
- Or different for additional security layer

### Access Control

**Who Needs Access**:

- Release Manager (primary)
- Backup Release Manager (secondary)
- Senior IT Staff (emergency only)

**Access Procedure**:

1. Document who has access
2. Log all keystore usage
3. Review access quarterly
4. Revoke access for departed staff
5. Rotate passwords annually

## Troubleshooting

### Common Signing Errors

#### Error: "Keystore file not found"

**Solution**:

```bash
# Verify keystore exists
ls -l /path/to/diabetactic-release.jks

# Check keystore.properties path
cat android/keystore.properties

# Use absolute path, not relative
storeFile=/home/username/keystores/diabetactic-release.jks  # Good
storeFile=~/keystores/diabetactic-release.jks                # Bad (~ not expanded)
```

#### Error: "Keystore was tampered with, or password was incorrect"

**Solution**:

```bash
# Test password manually
keytool -list -keystore diabetactic-release.jks -storepass YOUR_PASSWORD

# If password is correct but still fails:
# - Check for special characters in password (escape in gradle)
# - Verify keystore file is not corrupted (restore from backup)
```

#### Error: "Failed to read key from keystore"

**Solution**:

```bash
# Verify alias exists
keytool -list -v -keystore diabetactic-release.jks

# Check key password
keytool -list -v -keystore diabetactic-release.jks -alias diabetactic-key -storepass STORE_PASS -keypass KEY_PASS
```

#### Error: "Signature mismatch" when updating app

**Cause**: APK signed with different key than original installation

**Solution**:

- Ensure you're using the same keystore for updates
- If keystore lost, users must uninstall and reinstall (data loss!)
- This is why keystore backup is critical

### Gradle Build Fails

#### Error: "Unrecognized option: --module-path"

**Cause**: Using Java 8 instead of Java 21

**Solution**:

```bash
# Check Java version
java -version  # Should show Java 21

# Set JAVA_HOME
export JAVA_HOME=/path/to/jdk-21

# Or use mise
mise use java@21
```

#### Error: "Could not determine java version from '11.0.x'"

**Cause**: Android Gradle Plugin requires Java 21 for SDK 34

**Solution**:

```bash
# Update Java
mise install java@21
mise use java@21

# Verify Gradle sees correct Java
cd android
./gradlew --version  # Check "JVM" line
```

## CI/CD Integration

### Secure Keystore in CI Pipeline

#### GitHub Actions Example

```yaml
# .github/workflows/release.yml
name: Build Release APK

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/keystore.jks

      - name: Build Release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cd android
          ./gradlew assembleRelease

      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: app-release.apk
          path: android/app/build/outputs/apk/release/app-release.apk
```

**Setup Secrets**:

```bash
# Encode keystore to base64
base64 -i diabetactic-release.jks | pbcopy

# Add to GitHub Secrets:
# KEYSTORE_BASE64: <paste base64>
# KEYSTORE_PASSWORD: <your password>
# KEY_ALIAS: diabetactic-key
# KEY_PASSWORD: <your key password>
```

## Keystore Migration

### Scenario: Lost Original Keystore

**If you lose the release keystore, you CANNOT update the app on user devices.**

**Options**:

1. **New package name**: Release as new app (users must reinstall)
2. **Play App Signing**: If enabled, request upload key reset from Google
3. **Recovery impossible**: If no backup and no Play App Signing

### Rotating Keystore (New App)

If creating a new version with different package name:

```bash
# 1. Generate new keystore
keytool -genkeypair -v -keystore diabetactic-v2-release.jks ...

# 2. Update android/app/build.gradle
defaultConfig {
    applicationId "io.diabetactic.app.v2"  # New package name
}

# 3. Build with new keystore
./gradlew assembleRelease
```

## Checklist

### Before First Release

- [ ] Production keystore generated
- [ ] Keystore backed up to secure location (minimum 2 copies)
- [ ] Passwords stored in password manager
- [ ] Keystore access documented (who has access)
- [ ] Gradle configured for release signing
- [ ] Test release build succeeds
- [ ] Signature verified with `jarsigner -verify`
- [ ] Upload key fingerprint recorded (for Play Console)
- [ ] Disaster recovery procedure documented

### For Each Release

- [ ] Version code incremented
- [ ] Version name updated
- [ ] Release notes prepared
- [ ] Build signed with correct keystore
- [ ] APK signature verified
- [ ] Test APK installs over previous version (no data loss)
- [ ] APK size checked (under 100MB recommended)
- [ ] ProGuard/R8 optimization applied (if enabled)

## Additional Resources

- [Android Developer Guide: Signing Your App](https://developer.android.com/studio/publish/app-signing)
- [Google Play App Signing](https://support.google.com/googleplay/android-developer/answer/9842756)
- [keytool Documentation](https://docs.oracle.com/en/java/javase/21/docs/specs/man/keytool.html)

## Emergency Contacts

| Issue                  | Contact                     |
| ---------------------- | --------------------------- |
| Lost Keystore          | Release Manager + Senior IT |
| Forgotten Password     | Password Management Team    |
| Play Console Issues    | Google Play Support         |
| Signature Verification | Security Team               |
| Build System Failures  | DevOps Team                 |

## Quick Reference

```bash
# Generate keystore
keytool -genkeypair -v -keystore release.jks -alias app-key -keyalg RSA -keysize 2048 -validity 10000

# List keystore contents
keytool -list -v -keystore release.jks

# Verify keystore password
keytool -list -keystore release.jks -storepass PASSWORD

# Build signed release
cd android && ./gradlew assembleRelease

# Verify APK signature
jarsigner -verify -verbose -certs app-release.apk

# View APK signature details
keytool -printcert -jarfile app-release.apk

# Extract SHA1 for Play Console
keytool -list -v -keystore release.jks -alias app-key -storepass PASSWORD | grep SHA1

# Backup keystore (example)
cp release.jks /secure/backup/location/release-$(date +%Y%m%d).jks
```
