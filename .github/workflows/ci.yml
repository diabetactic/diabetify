name: CI

on:
  push:
    branches: [master, main, develop]
    paths:
      - 'src/**'
      - 'playwright/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'angular.json'
      - 'tsconfig*.json'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [master, main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '24'
  PNPM_VERSION: '10.12.1'

jobs:
  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 1: Fast Feedback (parallel jobs)
  # Testing Trophy: Base layer - many fast tests for quick feedback
  # ══════════════════════════════════════════════════════════════════════════
  type-check:
    runs-on: [self-hosted, high-mem]
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
      - name: Type Check
        run: pnpm exec tsc --noEmit -p tsconfig.build.json

  static-analysis:
    runs-on: [self-hosted, high-mem]
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
      - name: Lint + Static Quality Gates
        run: pnpm run quality:static
      - name: i18n Check
        run: pnpm run i18n:check

  integration-tests-msw:
    runs-on: [self-hosted, high-mem]
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
      - name: Integration Tests (MSW)
        run: pnpm run test:integration:msw

  unit-tests:
    runs-on: [self-hosted, high-mem]
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Unit Tests with Coverage
        run: pnpm test:coverage
        # Coverage thresholds enforced in vitest.config.ts:
        # - branches: 70%
        # - functions: 75%
        # - lines: 80%
        # - statements: 80%
        # Build will fail if coverage drops below these thresholds

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 2: Build (~60s, only if Phase 1 passes)
  # ══════════════════════════════════════════════════════════════════════════
  build:
    needs: [type-check, static-analysis, integration-tests-msw, unit-tests]
    runs-on: [self-hosted, high-mem]
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Cache Angular build assets
        uses: actions/cache@v4
        with:
          path: .angular/cache
          key: angular-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            angular-${{ runner.os }}-

      - name: Build Mock Mode
        run: pnpm run build:mock

      - name: Upload www artifact
        uses: actions/upload-artifact@v4
        with:
          name: www
          path: www/
          retention-days: 1

  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 2b: Production Build Smoke (prevents prod-only hangs)
  # Runs an optimized prod build and validates critical Ionic overlays load.
  # ══════════════════════════════════════════════════════════════════════════
  prod-smoke:
    needs: [type-check, static-analysis, integration-tests-msw, unit-tests]
    runs-on: [self-hosted, high-mem]
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Cache Angular build assets
        uses: actions/cache@v4
        with:
          path: .angular/cache
          key: angular-prod-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            angular-prod-${{ runner.os }}-

      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium

      - name: Install Playwright system deps (Ubuntu runners)
        run: |
          if command -v apt-get >/dev/null 2>&1 && command -v sudo >/dev/null 2>&1; then
            pnpm exec playwright install-deps chromium
          else
            echo "Skipping playwright install-deps (non-Ubuntu runner or no sudo)"
          fi

      - name: Production smoke test (Ionic overlays)
        run: pnpm run test:prod-smoke

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: prod-smoke-artifacts
          path: |
            playwright-report-prod-smoke/
            playwright/artifacts-prod-smoke/
          retention-days: 7

  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 3: UI Integration Tests (~90s)
  # Testing Trophy: Middle layer - UI tests with mock backend
  # Single browser (mobile-first app), Playwright cached
  # ══════════════════════════════════════════════════════════════════════════
  ui-tests:
    needs: build
    runs-on: [self-hosted, high-mem]
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Download build
        if: ${{ env.ACT != 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: www
          path: www/

      - name: Build mock mode (act)
        if: ${{ env.ACT == 'true' }}
        run: pnpm run build:mock

      # Cache Playwright browsers (saves ~30s per run)
      - name: Get Playwright version
        id: playwright-version
        run: |
          VERSION="$(pnpm -s list @playwright/test --depth=0 --json | node -pe "const fs=require('fs'); const data=JSON.parse(fs.readFileSync(0,'utf8')); process.stdout.write(data?.[0]?.devDependencies?.['@playwright/test']?.version ?? data?.[0]?.dependencies?.['@playwright/test']?.version ?? 'unknown');")"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium

      - name: Install Playwright system deps (Ubuntu runners)
        run: |
          if command -v apt-get >/dev/null 2>&1 && command -v sudo >/dev/null 2>&1; then
            pnpm exec playwright install-deps chromium
          else
            echo "Skipping playwright install-deps (non-Ubuntu runner or no sudo)"
          fi

      - name: Verify www/browser/ exists
        run: |
          if [ ! -d "www/browser" ]; then
            echo "::error::www/browser/ directory not found. The build might have failed or was skipped."
            exit 1
          fi

      - name: Start static server (act)
        if: ${{ env.ACT == 'true' }}
        run: |
          nohup npx serve www/browser -l 4200 -s > serve.log 2>&1 &
          echo $! > serve.pid

      - name: Wait for server (act)
        if: ${{ env.ACT == 'true' }}
        run: |
          npx wait-on http://localhost:4200 --timeout 30000
          cat serve.log

      - name: Start static server (CI)
        if: ${{ env.ACT != 'true' }}
        run: npx serve www/browser -l 4200 -s &

      - name: Wait for server (CI)
        if: ${{ env.ACT != 'true' }}
        run: npx wait-on http://localhost:4200 --timeout 30000

      # SINGLE browser - mobile only (it's a mobile-first app!)
      - name: Run UI Integration Tests
        # Multiple --grep-invert flags override each other; must use single combined pattern
        run: pnpm exec playwright test --grep-invert "@docker|visual" --project=mobile-chromium
        env:
          E2E_SKIP_SERVER: true
          E2E_MOCK_MODE: true

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-artifacts
          path: |
            playwright-report/
            playwright/artifacts/
          retention-days: 7

  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 4: Real E2E Tests (Optional - Docker backend)
  # Testing Trophy: Top layer - few slow tests with full stack
  # Trigger: Push to main OR PR with 'run-e2e' label
  # ══════════════════════════════════════════════════════════════════════════
  docker-e2e:
    needs: build
    runs-on: [self-hosted, high-mem]
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      contains(github.event.pull_request.labels.*.name, 'run-e2e')
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Download build
        if: ${{ env.ACT != 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: www
          path: www/

      - name: Build mock mode (act)
        if: ${{ env.ACT == 'true' }}
        run: pnpm run build:mock

      - name: Start Docker backend
        run: |
          docker compose -f docker/docker-compose.ci.yml up -d --wait
          sleep 5

      - name: Backend Integration Tests (Docker)
        run: pnpm run test:integration:backend

      - name: Seed test data
        run: ./docker/seed-test-data.sh full

      - name: Cache Playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright
        run: pnpm exec playwright install chromium

      - name: Install Playwright system deps (Ubuntu runners)
        run: |
          if command -v apt-get >/dev/null 2>&1 && command -v sudo >/dev/null 2>&1; then
            pnpm exec playwright install-deps chromium
          else
            echo "Skipping playwright install-deps (non-Ubuntu runner or no sudo)"
          fi

      - name: Verify www/ exists
        run: |
          if [ ! -d "www" ]; then
            echo "::error::www/ directory not found. The build might have failed or was skipped."
            exit 1
          fi

      - name: Start frontend (act)
        if: ${{ env.ACT == 'true' }}
        run: |
          nohup npx serve www -l 4200 -s > serve.log 2>&1 &
          echo $! > serve.pid

      - name: Wait for services (act)
        if: ${{ env.ACT == 'true' }}
        run: |
          npx wait-on http://localhost:4200 --timeout 30000
          npx wait-on http://localhost:8000/health --timeout 60000
          cat serve.log

      - name: Start frontend (CI)
        if: ${{ env.ACT != 'true' }}
        run: npx serve www -l 4200 -s &

      - name: Wait for services (CI)
        if: ${{ env.ACT != 'true' }}
        run: |
          npx wait-on http://localhost:4200 --timeout 30000
          npx wait-on http://localhost:8000/health --timeout 60000

      - name: Run Real E2E Tests
        run: pnpm test:e2e --project=mobile-chromium
        env:
          E2E_API_URL: http://localhost:8000
          E2E_BACKOFFICE_URL: http://localhost:8001

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-e2e-artifacts
          path: |
            playwright-report/
            playwright/artifacts/
          retention-days: 7

      - name: Stop Docker
        if: always()
        run: docker compose -f docker/docker-compose.ci.yml down -v

  # ══════════════════════════════════════════════════════════════════════════
  # PR Utilities
  # ══════════════════════════════════════════════════════════════════════════
  pr-labeler:
    runs-on: [self-hosted, high-mem]
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number });
            const totalChanges = (pr.additions ?? 0) + (pr.deletions ?? 0);

            const sizeLabels = [
              { name: 'size/XS', max: 10 },
              { name: 'size/S',  max: 100 },
              { name: 'size/M',  max: 500 },
              { name: 'size/L',  max: 1000 },
              { name: 'size/XL', max: Number.POSITIVE_INFINITY },
            ];

            const desired = sizeLabels.find(l => totalChanges <= l.max)?.name ?? 'size/XL';

            // Ensure labels exist
            for (const l of sizeLabels) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: l.name });
              } catch {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: l.name,
                  color: 'ededed',
                  description: `PR size label (${l.name})`,
                }).catch(() => {});
              }
            }

            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner,
              repo,
              issue_number: pull_number,
            });

            // Remove any existing size/* label
            const existingSize = currentLabels
              .map(l => l.name)
              .filter(name => typeof name === 'string' && name.startsWith('size/'));

            for (const name of existingSize) {
              if (name !== desired) {
                await github.rest.issues.removeLabel({ owner, repo, issue_number: pull_number, name }).catch(() => {});
              }
            }

            // Add desired label
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pull_number,
              labels: [desired],
            });
