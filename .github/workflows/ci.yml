name: CI

on:
  push:
    branches: [master, main, develop]
    paths:
      - 'src/**'
      - 'playwright/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'angular.json'
      - 'tsconfig*.json'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [master, main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 1: Fast Feedback (parallel, ~90s total)
  # Testing Trophy: Base layer - many fast tests for quick feedback
  # ══════════════════════════════════════════════════════════════════════════
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm

      - name: Type Check
        run: pnpm exec tsc --noEmit -p tsconfig.build.json

      - name: Lint
        run: pnpm run lint

      - name: i18n Check
        run: pnpm run i18n:check

  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm

      - name: Unit Tests with Coverage
        run: pnpm test:coverage
        # Coverage thresholds enforced in vitest.config.ts:
        # - branches: 70%
        # - functions: 75%
        # - lines: 80%
        # - statements: 80%
        # Build will fail if coverage drops below these thresholds

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: Upload coverage to DeepSource
        uses: deepsourcelabs/test-coverage-action@master
        with:
          key: javascript
          coverage-file: coverage/lcov.info
          dsn: ${{ secrets.DEEPSOURCE_DSN }}

  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 2: Build (~60s, only if Phase 1 passes)
  # ══════════════════════════════════════════════════════════════════════════
  build:
    needs: [lint, unit-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm

      - name: Build Mock Mode
        run: pnpm run build:mock

      - name: Upload www artifact
        uses: actions/upload-artifact@v6
        with:
          name: www
          path: www/
          retention-days: 1

  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 3: UI Integration Tests (~90s)
  # Testing Trophy: Middle layer - UI tests with mock backend
  # Single browser (mobile-first app), Playwright cached
  # ══════════════════════════════════════════════════════════════════════════
  ui-tests:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: www
          path: www/

      # Cache Playwright browsers (saves ~30s per run)
      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(pnpm list @playwright/test --json | jq -r '.[0].devDependencies["@playwright/test"].version // "unknown"')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright (cache miss)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Playwright deps (cache hit)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Start static server (SPA mode)
        run: npx serve www -l 4200 -s &

      - name: Wait for server
        run: npx wait-on http://localhost:4200 --timeout 30000

      # SINGLE browser - mobile only (it's a mobile-first app!)
      - name: Run UI Integration Tests
        run: pnpm test:e2e --project=mobile-chromium --grep-invert "visual|@docker"
        env:
          E2E_SKIP_SERVER: true
          E2E_MOCK_MODE: true

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ui-test-artifacts
          path: |
            playwright-report/
            playwright/artifacts/
          retention-days: 7

  # ══════════════════════════════════════════════════════════════════════════
  # PHASE 4: Real E2E Tests (Optional - Docker backend)
  # Testing Trophy: Top layer - few slow tests with full stack
  # Trigger: Push to main OR PR with 'run-e2e' label
  # ══════════════════════════════════════════════════════════════════════════
  docker-e2e:
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      contains(github.event.pull_request.labels.*.name, 'run-e2e')
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: www
          path: www/

      - name: Start Docker backend
        run: |
          docker compose -f docker/docker-compose.ci.yml up -d --wait
          sleep 5

      - name: Seed test data
        run: ./docker/seed-test-data.sh full

      - name: Cache Playwright
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright
        run: pnpm exec playwright install --with-deps chromium

      - name: Start frontend
        run: npx serve www -l 4200 -s &

      - name: Wait for services
        run: |
          npx wait-on http://localhost:4200 --timeout 30000
          npx wait-on http://localhost:8000/health --timeout 60000

      - name: Run Real E2E Tests
        run: pnpm test:e2e --project=mobile-chromium --grep "@docker"
        env:
          E2E_DOCKER_TESTS: true
          E2E_API_URL: http://localhost:8000
          E2E_BACKOFFICE_URL: http://localhost:8001

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: docker-e2e-artifacts
          path: |
            playwright-report/
            playwright/artifacts/
          retention-days: 7

      - name: Stop Docker
        if: always()
        run: docker compose -f docker/docker-compose.ci.yml down -v

  # ══════════════════════════════════════════════════════════════════════════
  # PR Utilities
  # ══════════════════════════════════════════════════════════════════════════
  pr-labeler:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_max_size: '10'
          s_max_size: '100'
          m_max_size: '500'
