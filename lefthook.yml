# Lefthook Configuration for Diabetify
# Replaces Husky + lint-staged for faster parallel git hooks
#
# Features:
# - Parallel pre-commit linting (10x faster than sequential Husky)
# - Anti-AI commit signature detection (blocks AI-authored commits)
# - Sensitive data leak prevention
# - Build validation on push
# - Branch name validation
# - Package lock consistency
# - File size limits

pre-commit:
  parallel: true
  commands:
    lint-ts:
      glob: '*.{ts,js}'
      run: npx prettier --write {staged_files} && npx eslint --fix {staged_files}
      stage_fixed: true

    lint-html:
      glob: '*.html'
      run: npx prettier --write {staged_files}
      stage_fixed: true

    lint-scss:
      glob: '*.scss'
      run: npx prettier --write {staged_files} && npx stylelint --fix {staged_files}
      stage_fixed: true

    lint-json:
      glob: '*.{json,md}'
      run: npx prettier --write {staged_files}
      stage_fixed: true

    # Prevent accidental commits of sensitive data
    no-secrets:
      glob: '*.{ts,js,json,env}'
      run: |
        if grep -rE "(password|secret|api_key|private_key)\s*[:=]\s*['\"][^'\"]+['\"]" {staged_files} 2>/dev/null | grep -v "\.spec\." | grep -v "mock" | grep -v "// Public test credentials" | grep -v "debug-panel"; then
          echo "âŒ Potential secrets detected! Review staged files."
          exit 1
        fi
      fail_text: 'Potential secrets detected in staged files!'

    # Check for large files (>1MB) - prevents bloating repository
    no-large-files:
      run: |
        MAX_SIZE=1048576  # 1MB in bytes
        for file in {staged_files}; do
          if [ -f "$file" ]; then
            size=$(wc -c < "$file" 2>/dev/null || echo "0")
            if [ "$size" -gt "$MAX_SIZE" ]; then
              echo "âŒ File too large: $file ($(numfmt --to=iec $size 2>/dev/null || echo "${size} bytes"))"
              echo "   Consider using Git LFS for large files."
              exit 1
            fi
          fi
        done
      fail_text: 'Large files detected! Use Git LFS or reduce file size.'

    # Verify pnpm-lock.yaml is in sync with package.json
    lockfile-check:
      glob: 'package.json'
      run: |
        if [ -f pnpm-lock.yaml ]; then
          if ! pnpm install --frozen-lockfile --ignore-scripts 2>/dev/null; then
            echo "âš ï¸  pnpm-lock.yaml may be out of sync. Run 'pnpm install' to update."
          fi
        fi

    # Check for console.log statements in production code (warning only)
    no-console-logs:
      glob: '*.ts'
      run: |
        if grep -n "console\\.log\\|console\\.debug" {staged_files} 2>/dev/null | grep -v "\.spec\.ts" | grep -v "logger\.service\.ts" | grep -v "environment" | grep -v "logPlatformInfo"; then
          echo "âš ï¸  console.log statements found. Consider using LoggerService instead."
        fi
        # Warning only - don't fail the commit
        exit 0

    # Check for hardcoded text in SCSS (warning only)
    no-hardcoded-text:
      glob: '*.scss'
      run: |
        # Flag content: "text" but allow symbols/icons (single char or common symbols)
        if grep -n "content:\s*['\"][a-zA-Z][a-zA-Z]" {staged_files} 2>/dev/null; then
          echo "âš ï¸  Hardcoded text in CSS detected. Use HTML data-* attributes or i18n in templates instead."
          echo "   Allowed: symbols (â€¢, â†’, âœ“) | Not allowed: words/phrases"
        fi
        # Warning only - don't fail the commit
        exit 0

commit-msg:
  commands:
    # Block AI-authored commit signatures
    no-ai-signatures:
      run: |
        # Block common AI assistant signatures
        if grep -qiE "(Generated with|Co-Authored-By:.*Claude|Co-Authored-By:.*GPT|Co-Authored-By:.*Copilot|ðŸ¤–.*Generated|AI-assisted)" "$1"; then
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âŒ AI SIGNATURE DETECTED IN COMMIT MESSAGE                      â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  This repository blocks AI-authored commit signatures.          â•‘"
          echo "â•‘  Please remove any AI attribution lines from your commit.       â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  Blocked patterns:                                               â•‘"
          echo "â•‘  â€¢ 'Generated with [Claude/GPT/Copilot]'                        â•‘"
          echo "â•‘  â€¢ 'Co-Authored-By: Claude/GPT/Copilot'                         â•‘"
          echo "â•‘  â€¢ 'ðŸ¤– Generated'                                               â•‘"
          echo "â•‘  â€¢ 'AI-assisted'                                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          exit 1
        fi
      fail_text: 'AI signature detected in commit message!'

    # Enforce conventional commit format
    conventional-commit:
      run: |
        # Check for conventional commit format: type(scope): description
        if ! head -1 "$1" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}$"; then
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âš ï¸  COMMIT MESSAGE FORMAT                                       â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  Use conventional commit format:                                 â•‘"
          echo "â•‘  type(scope): description                                        â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  Types: feat, fix, docs, style, refactor, perf, test,           â•‘"
          echo "â•‘         build, ci, chore, revert                                â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  Examples:                                                       â•‘"
          echo "â•‘  â€¢ feat(readings): add glucose trend chart                      â•‘"
          echo "â•‘  â€¢ fix(auth): resolve token refresh race condition              â•‘"
          echo "â•‘  â€¢ docs: update API documentation                               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          # Warning only, don't block
        fi

pre-push:
  parallel: false # Run sequentially - quality must pass before build
  commands:
    # Validate branch naming convention
    branch-name:
      run: |
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
        # Allow master, main, develop, release/*, hotfix/*, feature/*, fix/*, test/*, docs/*
        if ! echo "$BRANCH" | grep -qE "^(master|main|develop|release/|hotfix/|feature/|fix/|test/|docs/|chore/)"; then
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âš ï¸  BRANCH NAMING CONVENTION                                    â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  Current branch: $BRANCH"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  Recommended prefixes:                                           â•‘"
          echo "â•‘  â€¢ feature/  - New features                                      â•‘"
          echo "â•‘  â€¢ fix/      - Bug fixes                                         â•‘"
          echo "â•‘  â€¢ hotfix/   - Urgent production fixes                           â•‘"
          echo "â•‘  â€¢ release/  - Release branches                                  â•‘"
          echo "â•‘  â€¢ docs/     - Documentation updates                             â•‘"
          echo "â•‘  â€¢ test/     - Test infrastructure                               â•‘"
          echo "â•‘  â€¢ chore/    - Maintenance tasks                                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          # Warning only - don't block
        fi

    # Run quality checks before push
    quality:
      run: pnpm run quality
      fail_text: "Quality checks failed. Run 'pnpm run quality' to see details."

    # Verify TypeScript types
    typecheck:
      run: npx ng build --configuration=production --aot 2>&1 | head -50 || true
      fail_text: 'TypeScript errors detected!'

    # Verify build passes (production build validates types)
    build-check:
      run: pnpm run build:prod
      fail_text: 'Production build failed! Fix errors before pushing.'
