# Lefthook Configuration for Diabetify
# Replaces Husky + lint-staged for faster parallel git hooks
#
# Features:
# - Parallel pre-commit linting (10x faster than sequential Husky)
# - Anti-AI commit signature detection (blocks AI-authored commits)
# - Sensitive data leak prevention
# - Build validation on push
# - Branch name validation
# - Package lock consistency
# - File size limits

pre-commit:
  parallel: true
  commands:
    lint-ts:
      glob: '*.{ts,js}'
      run: npx prettier --write {staged_files} && npx eslint --fix {staged_files}
      stage_fixed: true

    lint-html:
      glob: '*.html'
      run: npx prettier --write {staged_files}
      stage_fixed: true

    lint-scss:
      glob: '*.scss'
      run: npx prettier --write {staged_files} && npx stylelint --fix {staged_files}
      stage_fixed: true

    lint-json:
      glob: '*.{json,md}'
      run: npx prettier --write {staged_files}
      stage_fixed: true

    # Prevent accidental commits of sensitive data
    no-secrets:
      glob: '*.{ts,js,json,env}'
      run: |
        if grep -rE "(password|secret|api_key|private_key)\s*[:=]\s*['\"][^'\"]+['\"]" {staged_files} 2>/dev/null | grep -v "\.spec\." | grep -v "mock" | grep -v "\.helper\." | grep -v "// Public test credentials" | grep -v "debug-panel"; then
          echo "❌ Potential secrets detected! Review staged files."
          exit 1
        fi
      fail_text: 'Potential secrets detected in staged files!'

    # Check for large files (>1MB) - prevents bloating repository
    no-large-files:
      run: |
        MAX_SIZE=1048576  # 1MB in bytes
        for file in {staged_files}; do
          if [ -f "$file" ]; then
            size=$(wc -c < "$file" 2>/dev/null || echo "0")
            if [ "$size" -gt "$MAX_SIZE" ]; then
              echo "❌ File too large: $file ($(numfmt --to=iec $size 2>/dev/null || echo "${size} bytes"))"
              echo "   Consider using Git LFS for large files."
              exit 1
            fi
          fi
        done
      fail_text: 'Large files detected! Use Git LFS or reduce file size.'

    # Verify pnpm-lock.yaml is in sync with package.json
    lockfile-check:
      glob: 'package.json'
      run: |
        if [ -f pnpm-lock.yaml ]; then
          if ! pnpm install --frozen-lockfile --ignore-scripts 2>/dev/null; then
            echo "⚠️  pnpm-lock.yaml may be out of sync. Run 'pnpm install' to update."
          fi
        fi

    # Check for console.log statements in production code (warning only)
    no-console-logs:
      glob: '*.ts'
      run: |
        if grep -n "console\\.log\\|console\\.debug" {staged_files} 2>/dev/null | grep -v "\.spec\.ts" | grep -v "logger\.service\.ts" | grep -v "environment" | grep -v "logPlatformInfo"; then
          echo "⚠️  console.log statements found. Consider using LoggerService instead."
        fi
        # Warning only - don't fail the commit
        exit 0

    # Check for hardcoded text in SCSS (warning only)
    no-hardcoded-text:
      glob: '*.scss'
      run: |
        # Flag content: "text" but allow symbols/icons (single char or common symbols)
        if grep -n "content:\s*['\"][a-zA-Z][a-zA-Z]" {staged_files} 2>/dev/null; then
          echo "⚠️  Hardcoded text in CSS detected. Use HTML data-* attributes or i18n in templates instead."
          echo "   Allowed: symbols (•, →, ✓) | Not allowed: words/phrases"
        fi
        # Warning only - don't fail the commit
        exit 0

commit-msg:
  commands:
    # Enforce conventional commit format
    conventional-commit:
      run: |
        # Check for conventional commit format: type(scope): description
        if ! head -1 "$1" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}$"; then
          echo ""
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║  ⚠️  COMMIT MESSAGE FORMAT                                       ║"
          echo "║                                                                  ║"
          echo "║  Use conventional commit format:                                 ║"
          echo "║  type(scope): description                                        ║"
          echo "║                                                                  ║"
          echo "║  Types: feat, fix, docs, style, refactor, perf, test,           ║"
          echo "║         build, ci, chore, revert                                ║"
          echo "║                                                                  ║"
          echo "║  Examples:                                                       ║"
          echo "║  • feat(readings): add glucose trend chart                      ║"
          echo "║  • fix(auth): resolve token refresh race condition              ║"
          echo "║  • docs: update API documentation                               ║"
          echo "╚══════════════════════════════════════════════════════════════════╝"
          echo ""
          # Warning only, don't block
        fi

pre-push:
  parallel: false # Run sequentially - quality must pass before build
  commands:
    # Validate branch naming convention
    branch-name:
      run: |
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
        # Allow master, main, develop, release/*, hotfix/*, feature/*, fix/*, test/*, docs/*
        if ! echo "$BRANCH" | grep -qE "^(master|main|develop|release/|hotfix/|feature/|fix/|test/|docs/|chore/)"; then
          echo ""
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║  ⚠️  BRANCH NAMING CONVENTION                                    ║"
          echo "║                                                                  ║"
          echo "║  Current branch: $BRANCH"
          echo "║                                                                  ║"
          echo "║  Recommended prefixes:                                           ║"
          echo "║  • feature/  - New features                                      ║"
          echo "║  • fix/      - Bug fixes                                         ║"
          echo "║  • hotfix/   - Urgent production fixes                           ║"
          echo "║  • release/  - Release branches                                  ║"
          echo "║  • docs/     - Documentation updates                             ║"
          echo "║  • test/     - Test infrastructure                               ║"
          echo "║  • chore/    - Maintenance tasks                                 ║"
          echo "╚══════════════════════════════════════════════════════════════════╝"
          echo ""
          # Warning only - don't block
        fi

    # Lint check (errors only, warnings don't block)
    lint-errors:
      run: pnpm run lint --quiet
      fail_text: "Lint errors found! Run 'pnpm run lint' to see details."

    # NOTE: Tests removed from pre-push (too slow, CI handles them)
    # Run manually before major pushes: pnpm test

    # NOTE: Heavy checks (typecheck, build-check) removed from pre-push
    # Run these manually or let CI handle them:
    #   pnpm test          (before major pushes)
    #   pnpm run build:prod  (before releases)

    # Code quality analysis (warnings only, don't block)
    dead-code-check:
      run: |
        if ! pnpm run analyze:dead-code 2>&1 | grep -q "No issues found"; then
          echo "⚠️  Dead code detected. Run 'pnpm run fix:dead-code' to clean up."
        fi
        # Warning only - don't block
        exit 0

    # Check for circular dependencies (blocks push - critical issue)
    circular-deps:
      run: pnpm run analyze:circular
      fail_text: 'Circular dependencies detected! Review and refactor to remove cycles.'

    # Check code complexity (warning only)
    complexity-check:
      run: |
        if ! pnpm run analyze:complexity 2>&1 | grep -q "No files matched"; then
          echo "⚠️  High complexity detected. Consider refactoring complex functions."
        fi
        # Warning only - don't block
        exit 0
