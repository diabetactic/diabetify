# Lefthook Configuration for Diabetify
# Replaces Husky + lint-staged for faster parallel git hooks
#
# Features:
# - Parallel pre-commit linting (10x faster than sequential Husky)
# - Anti-AI commit signature detection (blocks AI-authored commits)
# - Sensitive data leak prevention
# - Build validation on push
# - Branch name validation
# - Package lock consistency
# - File size limits

pre-commit:
  parallel: true
  commands:
    lint-ts:
      glob: '*.{ts,js}'
      run: npx prettier --write {staged_files} && npx eslint --fix {staged_files}
      stage_fixed: true

    lint-html:
      glob: '*.html'
      run: npx prettier --write {staged_files}
      stage_fixed: true

    lint-scss:
      glob: '*.scss'
      run: npx prettier --write {staged_files} && npx stylelint --fix {staged_files}
      stage_fixed: true

    lint-json:
      glob: '*.{json,md}'
      run: npx prettier --write {staged_files}
      stage_fixed: true

    # Prevent accidental commits of sensitive data
    no-secrets:
      glob: '*.{ts,js,json,env}'
      run: |
        if grep -rE "(password|secret|api_key|private_key)\s*[:=]\s*['\"][^'\"]+['\"]" {staged_files} 2>/dev/null | grep -v "\.spec\." | grep -v "mock" | grep -v "// Public test credentials" | grep -v "debug-panel"; then
          echo "‚ùå Potential secrets detected! Review staged files."
          exit 1
        fi
      fail_text: 'Potential secrets detected in staged files!'

    # Check for large files (>1MB) - prevents bloating repository
    no-large-files:
      run: |
        MAX_SIZE=1048576  # 1MB in bytes
        for file in {staged_files}; do
          if [ -f "$file" ]; then
            size=$(wc -c < "$file" 2>/dev/null || echo "0")
            if [ "$size" -gt "$MAX_SIZE" ]; then
              echo "‚ùå File too large: $file ($(numfmt --to=iec $size 2>/dev/null || echo "${size} bytes"))"
              echo "   Consider using Git LFS for large files."
              exit 1
            fi
          fi
        done
      fail_text: 'Large files detected! Use Git LFS or reduce file size.'

    # Verify pnpm-lock.yaml is in sync with package.json
    lockfile-check:
      glob: 'package.json'
      run: |
        if [ -f pnpm-lock.yaml ]; then
          if ! pnpm install --frozen-lockfile --ignore-scripts 2>/dev/null; then
            echo "‚ö†Ô∏è  pnpm-lock.yaml may be out of sync. Run 'pnpm install' to update."
          fi
        fi

    # Check for console.log statements in production code (warning only)
    no-console-logs:
      glob: '*.ts'
      run: |
        if grep -n "console\\.log\\|console\\.debug" {staged_files} 2>/dev/null | grep -v "\.spec\.ts" | grep -v "logger\.service\.ts" | grep -v "environment" | grep -v "logPlatformInfo"; then
          echo "‚ö†Ô∏è  console.log statements found. Consider using LoggerService instead."
        fi
        # Warning only - don't fail the commit
        exit 0

    # Check for hardcoded text in SCSS (warning only)
    no-hardcoded-text:
      glob: '*.scss'
      run: |
        # Flag content: "text" but allow symbols/icons (single char or common symbols)
        if grep -n "content:\s*['\"][a-zA-Z][a-zA-Z]" {staged_files} 2>/dev/null; then
          echo "‚ö†Ô∏è  Hardcoded text in CSS detected. Use HTML data-* attributes or i18n in templates instead."
          echo "   Allowed: symbols (‚Ä¢, ‚Üí, ‚úì) | Not allowed: words/phrases"
        fi
        # Warning only - don't fail the commit
        exit 0

commit-msg:
  commands:
    # Block AI-authored commit signatures
    no-ai-signatures:
      run: |
        # Block common AI assistant signatures
        if grep -qiE "(Generated with|Co-Authored-By:.*Claude|Co-Authored-By:.*GPT|Co-Authored-By:.*Copilot|ü§ñ.*Generated|AI-assisted)" "$1"; then
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  ‚ùå AI SIGNATURE DETECTED IN COMMIT MESSAGE                      ‚ïë"
          echo "‚ïë                                                                  ‚ïë"
          echo "‚ïë  This repository blocks AI-authored commit signatures.          ‚ïë"
          echo "‚ïë  Please remove any AI attribution lines from your commit.       ‚ïë"
          echo "‚ïë                                                                  ‚ïë"
          echo "‚ïë  Blocked patterns:                                               ‚ïë"
          echo "‚ïë  ‚Ä¢ 'Generated with [Claude/GPT/Copilot]'                        ‚ïë"
          echo "‚ïë  ‚Ä¢ 'Co-Authored-By: Claude/GPT/Copilot'                         ‚ïë"
          echo "‚ïë  ‚Ä¢ 'ü§ñ Generated'                                               ‚ïë"
          echo "‚ïë  ‚Ä¢ 'AI-assisted'                                                ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          exit 1
        fi
      fail_text: 'AI signature detected in commit message!'

    # Enforce conventional commit format
    conventional-commit:
      run: |
        # Check for conventional commit format: type(scope): description
        if ! head -1 "$1" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}$"; then
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  ‚ö†Ô∏è  COMMIT MESSAGE FORMAT                                       ‚ïë"
          echo "‚ïë                                                                  ‚ïë"
          echo "‚ïë  Use conventional commit format:                                 ‚ïë"
          echo "‚ïë  type(scope): description                                        ‚ïë"
          echo "‚ïë                                                                  ‚ïë"
          echo "‚ïë  Types: feat, fix, docs, style, refactor, perf, test,           ‚ïë"
          echo "‚ïë         build, ci, chore, revert                                ‚ïë"
          echo "‚ïë                                                                  ‚ïë"
          echo "‚ïë  Examples:                                                       ‚ïë"
          echo "‚ïë  ‚Ä¢ feat(readings): add glucose trend chart                      ‚ïë"
          echo "‚ïë  ‚Ä¢ fix(auth): resolve token refresh race condition              ‚ïë"
          echo "‚ïë  ‚Ä¢ docs: update API documentation                               ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          # Warning only, don't block
        fi

pre-push:
  parallel: false # Run sequentially - quality must pass before build
  commands:
    # Validate branch naming convention
    branch-name:
      run: |
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
        # Allow master, main, develop, release/*, hotfix/*, feature/*, fix/*, test/*, docs/*
        if ! echo "$BRANCH" | grep -qE "^(master|main|develop|release/|hotfix/|feature/|fix/|test/|docs/|chore/)"; then
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  ‚ö†Ô∏è  BRANCH NAMING CONVENTION                                    ‚ïë"
          echo "‚ïë                                                                  ‚ïë"
          echo "‚ïë  Current branch: $BRANCH"
          echo "‚ïë                                                                  ‚ïë"
          echo "‚ïë  Recommended prefixes:                                           ‚ïë"
          echo "‚ïë  ‚Ä¢ feature/  - New features                                      ‚ïë"
          echo "‚ïë  ‚Ä¢ fix/      - Bug fixes                                         ‚ïë"
          echo "‚ïë  ‚Ä¢ hotfix/   - Urgent production fixes                           ‚ïë"
          echo "‚ïë  ‚Ä¢ release/  - Release branches                                  ‚ïë"
          echo "‚ïë  ‚Ä¢ docs/     - Documentation updates                             ‚ïë"
          echo "‚ïë  ‚Ä¢ test/     - Test infrastructure                               ‚ïë"
          echo "‚ïë  ‚Ä¢ chore/    - Maintenance tasks                                 ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          # Warning only - don't block
        fi

    # Run quality checks before push
    quality:
      run: pnpm run quality
      fail_text: "Quality checks failed. Run 'pnpm run quality' to see details."

    # NOTE: Heavy checks (typecheck, build-check) removed from pre-push
    # Run these manually or let CI handle them:
    #   pnpm run build:prod  (before major pushes)
    # They're too slow for every push (2-5 min each)

    # Code quality analysis
    dead-code-check:
      run: pnpm run analyze:dead-code
      fail_text: 'Dead code detected! Run "pnpm run fix:dead-code" to remove unused exports.'

    # Check for circular dependencies
    circular-deps:
      run: pnpm run analyze:circular
      fail_text: 'Circular dependencies detected! Review and refactor to remove cycles.'

    # Check code complexity (warning only)
    complexity-check:
      run: |
        if ! pnpm run analyze:complexity 2>&1 | grep -q "No files matched"; then
          echo "‚ö†Ô∏è  High complexity detected. Consider refactoring complex functions."
        fi
        # Warning only - don't block
        exit 0
