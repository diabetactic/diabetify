# Lefthook Configuration for Diabetify
# Replaces Husky + lint-staged for faster parallel git hooks
#
# Features:
# - Parallel pre-commit linting (10x faster than sequential Husky)
# - Anti-AI commit signature detection (blocks AI-authored commits)
# - Sensitive data leak prevention
# - Build validation on push

pre-commit:
  parallel: true
  commands:
    lint-ts:
      glob: '*.{ts,js}'
      run: npx prettier --write {staged_files} && npx eslint --fix {staged_files}
      stage_fixed: true

    lint-html:
      glob: '*.html'
      run: npx prettier --write {staged_files}
      stage_fixed: true

    lint-scss:
      glob: '*.scss'
      run: npx prettier --write {staged_files} && npx stylelint --fix {staged_files}
      stage_fixed: true

    lint-json:
      glob: '*.{json,md}'
      run: npx prettier --write {staged_files}
      stage_fixed: true

    # Prevent accidental commits of sensitive data
    no-secrets:
      glob: '*.{ts,js,json,env}'
      run: |
        if grep -rE "(password|secret|api_key|private_key)\s*[:=]\s*['\"][^'\"]+['\"]" {staged_files} 2>/dev/null | grep -v "\.spec\." | grep -v "mock"; then
          echo "âŒ Potential secrets detected! Review staged files."
          exit 1
        fi
      fail_text: "Potential secrets detected in staged files!"

commit-msg:
  commands:
    # Block AI-authored commit signatures
    no-ai-signatures:
      run: |
        # Block common AI assistant signatures
        if grep -qiE "(Generated with|Co-Authored-By:.*Claude|Co-Authored-By:.*GPT|Co-Authored-By:.*Copilot|ğŸ¤–.*Generated|AI-assisted)" "$1"; then
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âŒ AI SIGNATURE DETECTED IN COMMIT MESSAGE                      â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  This repository blocks AI-authored commit signatures.          â•‘"
          echo "â•‘  Please remove any AI attribution lines from your commit.       â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  Blocked patterns:                                               â•‘"
          echo "â•‘  â€¢ 'Generated with [Claude/GPT/Copilot]'                        â•‘"
          echo "â•‘  â€¢ 'Co-Authored-By: Claude/GPT/Copilot'                         â•‘"
          echo "â•‘  â€¢ 'ğŸ¤– Generated'                                               â•‘"
          echo "â•‘  â€¢ 'AI-assisted'                                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          exit 1
        fi
      fail_text: "AI signature detected in commit message!"

    # Enforce conventional commit format
    conventional-commit:
      run: |
        # Check for conventional commit format: type(scope): description
        if ! head -1 "$1" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}$"; then
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âš ï¸  COMMIT MESSAGE FORMAT                                       â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  Use conventional commit format:                                 â•‘"
          echo "â•‘  type(scope): description                                        â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  Types: feat, fix, docs, style, refactor, perf, test,           â•‘"
          echo "â•‘         build, ci, chore, revert                                â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  Examples:                                                       â•‘"
          echo "â•‘  â€¢ feat(readings): add glucose trend chart                      â•‘"
          echo "â•‘  â€¢ fix(auth): resolve token refresh race condition              â•‘"
          echo "â•‘  â€¢ docs: update API documentation                               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          # Warning only, don't block
        fi

pre-push:
  commands:
    # Run quality checks before push
    quality:
      run: pnpm run quality
      fail_text: "Quality checks failed. Run 'pnpm run quality' to see details."

    # Verify build passes
    build-check:
      run: pnpm run build:prod
      fail_text: "Production build failed! Fix errors before pushing."
