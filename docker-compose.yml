# =============================================================================
# Docker Compose Configuration for Diabetify Development & CI/CD
# =============================================================================
# Services: dev, test, test-watch, e2e, coverage, lint, ci
#
# Usage:
#   docker compose up dev                    # Start dev server
#   docker compose run --rm test             # Run unit tests
#   docker compose run --rm e2e              # Run E2E tests
#   docker compose run --rm ci               # Full CI pipeline
# =============================================================================

version: '3.8'

# =============================================================================
# Shared Configuration
# =============================================================================

x-base-service: &base-service
  build:
    context: .
    dockerfile: docker/Dockerfile.dev
    cache_from:
      - diabetactic:dev
  image: diabetactic:dev
  working_dir: /app
  environment:
    - NODE_ENV=development
    - CI=false

# =============================================================================
# Services
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Development Server (Port 4200)
  # ---------------------------------------------------------------------------
  dev:
    <<: *base-service
    container_name: diabetactic-dev
    command: npm run start:mock
    ports:
      - '4200:4200'
    volumes:
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./tsconfig.app.json:/app/tsconfig.app.json:ro
      - ./angular.json:/app/angular.json:ro
      - ./tailwind.config.js:/app/tailwind.config.js:ro
      - ./postcss.config.js:/app/postcss.config.js:ro
      - dev-cache:/app/.angular
      - dev-www:/app/www
    environment:
      - NODE_ENV=development
      - CI=false
      - ENV=mock
    networks:
      - diabetactic
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Unit Tests (Jest)
  # ---------------------------------------------------------------------------
  test:
    <<: *base-service
    container_name: diabetactic-test
    command: npm test
    volumes:
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./tsconfig.spec.json:/app/tsconfig.spec.json:ro
      - ./jest.config.js:/app/jest.config.js:ro
      - ./setup-jest.ts:/app/setup-jest.ts:ro
      - ./angular.json:/app/angular.json:ro
      - ./coverage:/app/coverage
      - test-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=false
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Unit Tests Watch Mode
  # ---------------------------------------------------------------------------
  test-watch:
    <<: *base-service
    container_name: diabetactic-test-watch
    command: npm run test:watch
    volumes:
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./tsconfig.spec.json:/app/tsconfig.spec.json:ro
      - ./jest.config.js:/app/jest.config.js:ro
      - ./setup-jest.ts:/app/setup-jest.ts:ro
      - ./angular.json:/app/angular.json:ro
      - ./coverage:/app/coverage
      - test-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=false
    stdin_open: true
    tty: true
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # E2E Tests (Playwright)
  # ---------------------------------------------------------------------------
  e2e:
    <<: *base-service
    container_name: diabetactic-e2e
    command: npm run test:e2e
    volumes:
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./playwright:/app/playwright:ro
      - ./playwright.config.ts:/app/playwright.config.ts:ro
      - ./angular.json:/app/angular.json:ro
      - ./playwright-report:/app/playwright-report
      - ./playwright/artifacts:/app/playwright/artifacts
      - e2e-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=true
      - PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Accessibility Tests
  # ---------------------------------------------------------------------------
  a11y:
    <<: *base-service
    container_name: diabetactic-a11y
    command: npm run test:a11y
    volumes:
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./playwright:/app/playwright:ro
      - ./playwright.config.ts:/app/playwright.config.ts:ro
      - ./angular.json:/app/angular.json:ro
      - ./playwright-report:/app/playwright-report
      - ./playwright/artifacts:/app/playwright/artifacts
      - a11y-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=true
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Coverage Report
  # ---------------------------------------------------------------------------
  coverage:
    <<: *base-service
    container_name: diabetactic-coverage
    command: npm run test:coverage
    volumes:
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./tsconfig.spec.json:/app/tsconfig.spec.json:ro
      - ./jest.config.js:/app/jest.config.js:ro
      - ./setup-jest.ts:/app/setup-jest.ts:ro
      - ./angular.json:/app/angular.json:ro
      - ./coverage:/app/coverage
      - coverage-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=false
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Linting (ESLint + Stylelint)
  # ---------------------------------------------------------------------------
  lint:
    <<: *base-service
    container_name: diabetactic-lint
    command: bash -c "npm run lint && npm run lint:styles"
    volumes:
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./.eslintrc.json:/app/.eslintrc.json:ro
      - ./.stylelintrc.json:/app/.stylelintrc.json:ro
      - ./angular.json:/app/angular.json:ro
    environment:
      - NODE_ENV=development
      - CI=true
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Full CI Pipeline (lint + test + e2e)
  # ---------------------------------------------------------------------------
  ci:
    <<: *base-service
    container_name: diabetactic-ci
    command: bash -c "
      echo '=== Running Lint ===' &&
      npm run lint &&
      npm run lint:styles &&
      echo '=== Running Unit Tests ===' &&
      npm run test:ci &&
      echo '=== Running E2E Tests ===' &&
      npm run test:e2e &&
      echo '=== CI Pipeline Complete ==='
      "
    volumes:
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./playwright:/app/playwright:ro
      - ./playwright.config.ts:/app/playwright.config.ts:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./tsconfig.spec.json:/app/tsconfig.spec.json:ro
      - ./jest.config.js:/app/jest.config.js:ro
      - ./setup-jest.ts:/app/setup-jest.ts:ro
      - ./angular.json:/app/angular.json:ro
      - ./.eslintrc.json:/app/.eslintrc.json:ro
      - ./.stylelintrc.json:/app/.stylelintrc.json:ro
      - ./coverage:/app/coverage
      - ./playwright-report:/app/playwright-report
      - ./playwright/artifacts:/app/playwright/artifacts
      - ci-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=true
      - PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Production Build
  # ---------------------------------------------------------------------------
  build-prod:
    <<: *base-service
    container_name: diabetactic-build-prod
    command: npm run build:prod
    volumes:
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./angular.json:/app/angular.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./tsconfig.app.json:/app/tsconfig.app.json:ro
      - ./tailwind.config.js:/app/tailwind.config.js:ro
      - ./postcss.config.js:/app/postcss.config.js:ro
      - ./www:/app/www
      - build-cache:/app/.angular
    environment:
      - NODE_ENV=production
      - CI=true
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Interactive Shell (for debugging)
  # ---------------------------------------------------------------------------
  shell:
    <<: *base-service
    container_name: diabetactic-shell
    command: bash
    volumes:
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./angular.json:/app/angular.json:ro
      - ./coverage:/app/coverage
      - ./playwright-report:/app/playwright-report
      - ./www:/app/www
      - shell-cache:/app/.angular
    environment:
      - NODE_ENV=development
      - CI=false
    stdin_open: true
    tty: true
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # i18n Check (Translation Keys)
  # ---------------------------------------------------------------------------
  i18n:
    <<: *base-service
    container_name: diabetactic-i18n
    command: npm run i18n:check
    volumes:
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./scripts:/app/scripts:ro
    environment:
      - NODE_ENV=development
      - CI=true
    networks:
      - diabetactic

# =============================================================================
# Networks
# =============================================================================

networks:
  diabetactic:
    driver: bridge
    name: diabetactic-network

# =============================================================================
# Named Volumes (for build cache persistence)
# =============================================================================

volumes:
  dev-cache:
    name: diabetactic-dev-cache
  dev-www:
    name: diabetactic-dev-www
  test-cache:
    name: diabetactic-test-cache
  e2e-cache:
    name: diabetactic-e2e-cache
  a11y-cache:
    name: diabetactic-a11y-cache
  coverage-cache:
    name: diabetactic-coverage-cache
  ci-cache:
    name: diabetactic-ci-cache
  build-cache:
    name: diabetactic-build-cache
  shell-cache:
    name: diabetactic-shell-cache
