# =============================================================================
# Docker Compose Configuration for Diabetify Development & CI/CD
# =============================================================================
# This file provides multiple services for development, testing, and CI/CD:
#
# Services:
#   - dev:         Development server with hot reload (port 4200)
#   - test:        Run unit tests with Jest
#   - test-watch:  Run unit tests in watch mode
#   - e2e:         Run Playwright E2E tests
#   - coverage:    Run tests with coverage report
#   - lint:        Run ESLint and Stylelint
#   - ci:          Full CI pipeline (lint + test + e2e)
#
# Usage:
#   docker compose up dev                    # Start dev server
#   docker compose run --rm test             # Run unit tests
#   docker compose run --rm test-watch       # Test watch mode
#   docker compose run --rm e2e              # Run E2E tests
#   docker compose run --rm coverage         # Generate coverage report
#   docker compose run --rm lint             # Run linters
#   docker compose run --rm ci               # Full CI pipeline
#
# =============================================================================

version: '3.8'

# =============================================================================
# Shared Configuration
# =============================================================================

x-base-service: &base-service
  build:
    context: .
    dockerfile: docker/Dockerfile.dev
    cache_from:
      - diabetactic:dev
  image: diabetactic:dev
  working_dir: /app
  environment:
    - NODE_ENV=development
    - CI=false

x-base-volumes: &base-volumes
  - ./src:/app/src:ro                      # Source code (read-only for safety)
  - ./package.json:/app/package.json:ro    # Package files
  - ./package-lock.json:/app/package-lock.json:ro
  - ./tsconfig.json:/app/tsconfig.json:ro
  - ./tsconfig.app.json:/app/tsconfig.app.json:ro
  - ./tsconfig.spec.json:/app/tsconfig.spec.json:ro
  - ./angular.json:/app/angular.json:ro
  - ./jest.config.js:/app/jest.config.js:ro
  - ./setup-jest.ts:/app/setup-jest.ts:ro
  - ./playwright.config.ts:/app/playwright.config.ts:ro
  - ./tailwind.config.js:/app/tailwind.config.js:ro
  - ./postcss.config.js:/app/postcss.config.js:ro
  - ./.eslintrc.json:/app/.eslintrc.json:ro
  - ./.prettierrc:/app/.prettierrc:ro
  - ./.stylelintrc.json:/app/.stylelintrc.json:ro
  # Exclude from container
  - /app/node_modules                       # Use container's node_modules
  - /app/.angular                           # Prevent host pollution
  - /app/www                                # Build output

# =============================================================================
# Services
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Development Server (Port 4200)
  # ---------------------------------------------------------------------------
  dev:
    <<: *base-service
    container_name: diabetactic-dev
    command: npm run start:mock
    ports:
      - "4200:4200"
    volumes:
      <<: *base-volumes
      # Allow write access for Angular build cache
      - dev-cache:/app/.angular
      - dev-www:/app/www
    environment:
      - NODE_ENV=development
      - CI=false
      - ENV=mock                            # Use mock backend by default
    networks:
      - diabetactic
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Unit Tests (Jest)
  # ---------------------------------------------------------------------------
  test:
    <<: *base-service
    container_name: diabetactic-test
    command: npm test
    volumes:
      <<: *base-volumes
      - ./coverage:/app/coverage            # Coverage output
      - test-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=false
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Unit Tests Watch Mode
  # ---------------------------------------------------------------------------
  test-watch:
    <<: *base-service
    container_name: diabetactic-test-watch
    command: npm run test:watch
    volumes:
      <<: *base-volumes
      - ./coverage:/app/coverage
      - test-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=false
    stdin_open: true                        # Keep stdin open
    tty: true                               # Allocate pseudo-TTY for interactive watch
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # E2E Tests (Playwright)
  # ---------------------------------------------------------------------------
  e2e:
    <<: *base-service
    container_name: diabetactic-e2e
    command: npm run test:e2e
    volumes:
      <<: *base-volumes
      - ./playwright-report:/app/playwright-report        # HTML report
      - ./playwright/artifacts:/app/playwright/artifacts  # Screenshots/videos
      - e2e-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=true                             # Run in CI mode (headless)
      - PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # E2E Tests (Headed Mode)
  # ---------------------------------------------------------------------------
  e2e-headed:
    <<: *base-service
    container_name: diabetactic-e2e-headed
    command: npm run test:e2e:headed
    volumes:
      <<: *base-volumes
      - ./playwright-report:/app/playwright-report
      - ./playwright/artifacts:/app/playwright/artifacts
      - e2e-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=false
      - DISPLAY=${DISPLAY:-:0}              # X11 display for headed mode
      - PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Accessibility Tests
  # ---------------------------------------------------------------------------
  a11y:
    <<: *base-service
    container_name: diabetactic-a11y
    command: npm run test:a11y
    volumes:
      <<: *base-volumes
      - ./playwright-report:/app/playwright-report
      - ./playwright/artifacts:/app/playwright/artifacts
      - a11y-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=true
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Coverage Report
  # ---------------------------------------------------------------------------
  coverage:
    <<: *base-service
    container_name: diabetactic-coverage
    command: npm run test:coverage
    volumes:
      <<: *base-volumes
      - ./coverage:/app/coverage            # HTML and LCOV reports
      - coverage-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=false
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Linting (ESLint + Stylelint)
  # ---------------------------------------------------------------------------
  lint:
    <<: *base-service
    container_name: diabetactic-lint
    command: bash -c "npm run lint && npm run lint:styles"
    volumes:
      <<: *base-volumes
    environment:
      - NODE_ENV=development
      - CI=true
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Formatting Check (Prettier)
  # ---------------------------------------------------------------------------
  format:
    <<: *base-service
    container_name: diabetactic-format
    command: npm run format:check
    volumes:
      <<: *base-volumes
    environment:
      - NODE_ENV=development
      - CI=true
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Full CI Pipeline (lint + test + e2e)
  # ---------------------------------------------------------------------------
  ci:
    <<: *base-service
    container_name: diabetactic-ci
    command: bash -c "
      echo '=== Running Lint ===' &&
      npm run lint &&
      npm run lint:styles &&
      echo '=== Running Unit Tests ===' &&
      npm run test:ci &&
      echo '=== Running E2E Tests ===' &&
      npm run test:e2e &&
      echo '=== CI Pipeline Complete ==='
      "
    volumes:
      <<: *base-volumes
      - ./coverage:/app/coverage                          # Jest coverage
      - ./playwright-report:/app/playwright-report        # E2E reports
      - ./playwright/artifacts:/app/playwright/artifacts  # E2E artifacts
      - ci-cache:/app/.angular
    environment:
      - NODE_ENV=test
      - CI=true                             # Enable CI mode
      - PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Production Build
  # ---------------------------------------------------------------------------
  build-prod:
    <<: *base-service
    container_name: diabetactic-build-prod
    command: npm run build:prod
    volumes:
      <<: *base-volumes
      - ./www:/app/www                      # Production output
      - build-cache:/app/.angular
    environment:
      - NODE_ENV=production
      - CI=true
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Bundle Analysis
  # ---------------------------------------------------------------------------
  build-analyze:
    <<: *base-service
    container_name: diabetactic-build-analyze
    command: npm run build:analyze
    volumes:
      <<: *base-volumes
      - ./www:/app/www
      - build-cache:/app/.angular
    environment:
      - NODE_ENV=production
      - CI=true
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # Interactive Shell (for debugging)
  # ---------------------------------------------------------------------------
  shell:
    <<: *base-service
    container_name: diabetactic-shell
    command: bash
    volumes:
      <<: *base-volumes
      - ./coverage:/app/coverage
      - ./playwright-report:/app/playwright-report
      - ./www:/app/www
      - shell-cache:/app/.angular
    environment:
      - NODE_ENV=development
      - CI=false
    stdin_open: true
    tty: true
    networks:
      - diabetactic

  # ---------------------------------------------------------------------------
  # i18n Check (Translation Keys)
  # ---------------------------------------------------------------------------
  i18n:
    <<: *base-service
    container_name: diabetactic-i18n
    command: npm run i18n:check
    volumes:
      <<: *base-volumes
    environment:
      - NODE_ENV=development
      - CI=true
    networks:
      - diabetactic

# =============================================================================
# Networks
# =============================================================================

networks:
  diabetactic:
    driver: bridge
    name: diabetactic-network

# =============================================================================
# Named Volumes (for build cache persistence)
# =============================================================================

volumes:
  dev-cache:
    name: diabetactic-dev-cache
  dev-www:
    name: diabetactic-dev-www
  test-cache:
    name: diabetactic-test-cache
  e2e-cache:
    name: diabetactic-e2e-cache
  a11y-cache:
    name: diabetactic-a11y-cache
  coverage-cache:
    name: diabetactic-coverage-cache
  ci-cache:
    name: diabetactic-ci-cache
  build-cache:
    name: diabetactic-build-cache
  shell-cache:
    name: diabetactic-shell-cache

# =============================================================================
# Usage Examples
# =============================================================================
#
# Development:
#   docker compose up dev                    # Start dev server (http://localhost:4200)
#   docker compose logs -f dev               # Follow dev server logs
#
# Testing:
#   docker compose run --rm test             # Run unit tests once
#   docker compose run --rm test-watch       # Watch mode (interactive)
#   docker compose run --rm coverage         # Generate coverage report
#   docker compose run --rm e2e              # Run E2E tests (headless)
#   docker compose run --rm e2e-headed       # Run E2E tests (browser visible)
#   docker compose run --rm a11y             # Run accessibility tests
#
# Quality:
#   docker compose run --rm lint             # Run linters
#   docker compose run --rm format           # Check formatting
#   docker compose run --rm i18n             # Check translation keys
#
# Build:
#   docker compose run --rm build-prod       # Production build
#   docker compose run --rm build-analyze    # Bundle analysis
#
# CI/CD:
#   docker compose run --rm ci               # Full CI pipeline
#
# Debugging:
#   docker compose run --rm shell            # Interactive bash shell
#   docker compose exec dev bash             # Shell in running dev container
#
# Cleanup:
#   docker compose down                      # Stop all services
#   docker compose down -v                   # Stop and remove volumes
#   docker system prune -af --volumes        # Clean everything (use with caution)
#
# =============================================================================
