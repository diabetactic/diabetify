# ==========================================
# Flow: Robust Login - Fresh State
# Description: Stop app, clear keychain, open via deep link, log in if needed
# Uses openLink (not launchApp which fails on this device)
# Handles both: already logged in OR needs login
# ==========================================

appId: io.diabetactic.app

env:
  TEST_USER_ID: '1000'
  TEST_USER_PASSWORD: 'tuvieja'

---
# 1. STOP APP FIRST (ensures clean restart)
- stopApp

# 2. CLEAR KEYCHAIN (clears stored auth tokens - tries to force login)
- clearKeychain

# 3. OPEN APP VIA DEEP LINK (launchApp fails on this device, openLink works)
- openLink: diabetactic://

# 4. HYDRATION WAIT - Give WebView time to initialize
- waitForAnimationToEnd:
    timeout: 5000

# 5. WAIT FOR APP TO SHOW (welcome OR dashboard - handles both cases)
- extendedWaitUntil:
    visible:
      text: '.*Diabetactic.*|.*Bienvenido.*|.*Welcome.*|.*Vamos.*|.*Sign In.*|.*DNI.*|.*Inicio.*|.*Home.*|.*Lecturas.*|.*Readings.*|.*Citas.*|.*Appointments.*|.*Perfil.*|.*Profile.*|.*Panel.*'
    timeout: 20000
- waitForAnimationToEnd:
    timeout: 2000

# 6. TAP CTA TO GO TO LOGIN (only if on welcome screen)
# Uses separate flow file because runFlow+when requires file: not commands:
- runFlow:
    when:
      visible: '.*Vamos.*'
    file: tap-vamos.yaml
# Fallback: try Let's Go / Sign In / Iniciar variants
- tapOn:
    text: '.*Let.*s Go.*|.*Sign In.*|.*Iniciar.*'
    optional: true
- waitForAnimationToEnd:
    timeout: 2000

# 7. CONDITIONAL LOGIN - only if DNI field is visible (not logged in)
- runFlow:
    when:
      visible: '.*DNI.*'
    file: login-form-steps.yaml

# 8. VERIFY DASHBOARD LOADED (bilingual)
- extendedWaitUntil:
    visible:
      text: '.*Inicio.*|.*Home.*|.*Dashboard.*|.*Tablero.*|.*Lecturas.*|.*Readings.*|.*Citas.*|.*Appointments.*|.*Perfil.*|.*Profile.*|.*Panel.*'
    timeout: 15000
- waitForAnimationToEnd:
    timeout: 1000
