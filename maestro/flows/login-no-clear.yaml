# ==========================================
# Flow: Login WITHOUT Clearing State
# Description: Used for persistence tests where stored preferences must survive.
#              Does NOT call clearState. Handles both "already logged in" and
#              "needs to log in" scenarios.
# Uses .* wildcards for bilingual support with special chars
# ==========================================

appId: io.diabetactic.app

env:
  TEST_USER_ID: '1000'
  TEST_USER_PASSWORD: 'tuvieja'

---
# 0. STOP APP FIRST TO ENSURE CLEAN STATE
- stopApp

# 0.1. LAUNCH APP VIA DEEP LINK (launchApp has issues)
- openLink: diabetactic://

# 1. HYDRATION WAIT - Give app time to fully start
- waitForAnimationToEnd:
    timeout: 3000

# 2. WAIT FOR APP TO SHOW SOMETHING
# Could be welcome screen (need to login) or dashboard (already logged in)
- extendedWaitUntil:
    visible:
      text: '.*Diabetactic.*|.*Inicio.*|.*Dashboard.*|.*Home.*|.*Perfil.*|.*Profile.*|.*Vamos.*|.*DNI.*'
    timeout: 15000

# 3. CHECK IF ALREADY ON DASHBOARD (skip login if so)
# Try to find a dashboard element first - if found, we're logged in
- runFlow:
    when:
      visible: '.*Lecturas.*|.*Readings.*|.*Citas.*|.*Appointments.*|.*Inicio.*|.*Home.*'
    file: skip-login.yaml

# 4. IF ON WELCOME SCREEN, TAP TO GO TO LOGIN
- tapOn:
    text: '.*Vamos.*|.*Let.*Go.*|.*Sign.*In.*'
    optional: true
- waitForAnimationToEnd:
    timeout: 2000

# 5. CONDITIONAL LOGIN - only if login form is visible
# Use broader match for DNI-related text
- runFlow:
    when:
      visible: '.*DNI.*'
    file: login-form-steps.yaml

# 6. VERIFY DASHBOARD LOADED
- extendedWaitUntil:
    visible:
      text: '.*Inicio.*|.*Home.*|.*Dashboard.*|.*Tablero.*|.*Citas.*|.*Appointments.*|.*Lecturas.*|.*Readings.*|.*Perfil.*|.*Profile.*'
    timeout: 15000
- waitForAnimationToEnd:
    timeout: 1000
