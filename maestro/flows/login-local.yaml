# ==========================================
# Flow: Login for Local Docker Backend
# Description: Login flow optimized for local Docker testing
# Uses: TEST_USER_ID and TEST_USER_PASSWORD from config or env
# Note: Does NOT clear state - use for faster iteration
# ==========================================

appId: io.diabetactic.app

env:
  # Local Docker backend (Android emulator)
  API_BASE_URL: 'http://10.0.2.2:8000'
  BACKOFFICE_API_URL: 'http://10.0.2.2:8001'

---
# 1. LAUNCH APP (no clearState for faster testing)
- launchApp

# 2. WAIT FOR APP TO INITIALIZE
- extendedWaitUntil:
    visible:
      text: '.*Diabetactic.*|.*Bienvenido.*|.*Welcome.*|.*Iniciar.*|.*Login.*|.*Dashboard.*|.*Inicio.*'
    timeout: 15000

# 3. CHECK IF ALREADY LOGGED IN
- runFlow:
    when:
      visible:
        text: '.*Inicio.*|.*Home.*|.*Dashboard.*|.*Lecturas.*|.*Readings.*'
    commands:
      # Already logged in - we're done
      - assertVisible:
          text: '.*Inicio.*|.*Home.*|.*Dashboard.*|.*Lecturas.*|.*Readings.*|.*Citas.*|.*Appointments.*'
    optional: true

# 4. IF ON WELCOME SCREEN, TAP LOGIN
- tapOn:
    text: '.*Iniciar.*Sesi.*n.*|.*Log.*In.*|.*Entrar.*|.*Sign.*In.*'
    optional: true
- waitForAnimationToEnd:
    timeout: 2000

# 5. WAIT FOR LOGIN FORM
- extendedWaitUntil:
    visible:
      text: '.*Usuario.*|.*Username.*|.*DNI.*|.*ID.*|.*Correo.*|.*Email.*'
    timeout: 8000
    optional: true

# 6. ENTER USERNAME (DNI)
- tapOn:
    text: '.*Usuario.*|.*Username.*|.*DNI.*'
    index: 0
    optional: true
- inputText: ${TEST_USER_ID}
- hideKeyboard

# 7. ENTER PASSWORD
- tapOn:
    text: '.*Contrase.*a.*|.*Password.*'
    index: 0
    optional: true
- inputText: ${TEST_USER_PASSWORD}
- hideKeyboard

# 8. TAP LOGIN BUTTON
- tapOn:
    text: '.*Entrar.*|.*Iniciar.*|.*Login.*|.*Sign.*In.*|.*Acceder.*'
- waitForAnimationToEnd:
    timeout: 3000

# 9. WAIT FOR DASHBOARD OR TAB BAR
- extendedWaitUntil:
    visible:
      text: '.*Inicio.*|.*Home.*|.*Dashboard.*|.*Lecturas.*|.*Readings.*|.*Citas.*|.*Appointments.*|.*Perfil.*|.*Profile.*'
    timeout: 20000

# 10. VERIFY WE'RE LOGGED IN
- assertVisible:
    text: '.*Inicio.*|.*Home.*|.*Lecturas.*|.*Readings.*|.*Citas.*|.*Appointments.*|.*Perfil.*|.*Profile.*'
