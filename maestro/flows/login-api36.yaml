# ==========================================
# Flow: Login for API 36+ (No launchApp)
# Description: Works with already-running app. For API 36 compatibility.
# Usage: Run scripts/run-tests.sh which launches app via adb first.
# ==========================================

appId: io.diabetactic.app

env:
  TEST_USER_ID: '1000'
  TEST_USER_PASSWORD: 'tuvieja'

---
# 1. ENSURE APP IS IN FOREGROUND
# Don't use launchApp or clearState - app should already be running via adb
- waitForAnimationToEnd:
    timeout: 2000

# 2. CHECK CURRENT STATE - could be welcome, login, or dashboard
- extendedWaitUntil:
    visible:
      text: '.*Diabetactic.*|.*Vamos.*|.*Inicio.*|.*Dashboard.*|.*DNI.*|.*Lecturas.*|.*Readings.*'
    timeout: 10000

# 3. IF ON DASHBOARD, LOG OUT FIRST
- tapOn:
    text: 'Perfil|Profile'
    optional: true
- waitForAnimationToEnd:
    timeout: 1000

- scrollUntilVisible:
    element:
      text: '.*Cerrar sesión.*|.*Sign out.*|.*Logout.*'
    direction: DOWN
    timeout: 5000
    optional: true
- tapOn:
    text: '.*Cerrar sesión.*|.*Sign out.*|.*Logout.*'
    optional: true
- tapOn:
    text: 'Cerrar sesión|Sign out|Confirmar|Confirm|OK'
    optional: true
- waitForAnimationToEnd:
    timeout: 2000

# 4. NOW ON WELCOME SCREEN OR LOGIN SCREEN
- extendedWaitUntil:
    visible:
      text: '.*Diabetactic.*|.*Vamos.*|.*DNI.*|.*Iniciar.*'
    timeout: 8000

# 5. TAP VAMOS IF ON WELCOME
- tapOn:
    text: '.*Vamos.*|.*Let.*Go.*'
    optional: true
- waitForAnimationToEnd:
    timeout: 1500

# 6. WAIT FOR LOGIN FORM READY
- extendedWaitUntil:
    visible:
      text: 'DNI|Iniciar Sesión|Sign In'
    timeout: 5000

# 7. INPUT USERNAME - use data-testid for robustness
- tapOn:
    id: 'login-username-input'
- eraseText
- inputText: '${TEST_USER_ID}'
- hideKeyboard

# 8. INPUT PASSWORD - use data-testid for robustness
- tapOn:
    id: 'login-password-input'
- eraseText
- inputText: '${TEST_USER_PASSWORD}'
- hideKeyboard

# 9. SUBMIT - use data-testid for robustness
- tapOn:
    id: 'login-submit-btn'
- waitForAnimationToEnd:
    timeout: 3000

# 10. VERIFY DASHBOARD LOADED
- extendedWaitUntil:
    visible:
      text: '.*(Inicio|Home|Dashboard|Tablero|Lecturas|Readings|Mi Día|My Day).*'
    timeout: 20000
- waitForAnimationToEnd:
    timeout: 2000
