appId: io.diabetactic.app
---
# Reusable flow: Ensure user is logged in
# Description: Handles login if not already logged in
# Usage: runFlow: file: ../../flows/setup/ensure-logged-in.yaml
# Env vars: USERNAME (default: 1000), PASSWORD (default: tuvieja)

# Check if already logged in
- runFlow:
    when:
      notVisible: "Panel de Control"
    commands:
      # Handle welcome screen if visible
      - runFlow:
          when:
            visible: "Empezar|Get Started"
          commands:
            - tapOn:
                text: "Empezar|Get Started"
                optional: true
            - waitForAnimationToEnd

      # Check if at login screen
      - runFlow:
          when:
            visible: "Iniciar Sesión|Login|Sign In"
          commands:
            # Tap login button if needed
            - tapOn:
                text: "Iniciar Sesión"
                optional: true
            - waitForAnimationToEnd

            # Fill credentials
            - tapOn:
                id: "email-input"
                optional: true
            - tapOn:
                point: "50%,45%"
                optional: true
            - waitForAnimationToEnd:
                timeout: 5000
            - eraseText
            - inputText: "${USERNAME:1000}"

            - tapOn:
                id: "password-input"
                optional: true
            - tapOn:
                point: "50%,52%"
                optional: true
            - waitForAnimationToEnd:
                timeout: 5000
            - eraseText
            - inputText: "${PASSWORD:tuvieja}"
            - hideKeyboard

            # Submit login
            - tapOn:
                text: "Iniciar Sesión"
                retryTapIfNoChange: true
            - waitForAnimationToEnd:
                timeout: 5000

# Verify logged in
- assertVisible: "Panel de Control"