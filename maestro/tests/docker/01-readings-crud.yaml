# ==========================================
# Test: Docker Backend - Readings CRUD with Backend Verification
# Description: Full readings CRUD against local Docker backend
# Tags: @docker @docker-readings
# Prerequisites:
#   - Docker backend running (cd docker && ./start.sh)
#   - Test data seeded (cd docker && ./seed-test-data.sh)
# ==========================================

appId: io.diabetactic.app

env:
  # Override for Docker backend (Android emulator)
  API_BASE_URL: 'http://10.0.2.2:8000'
  BACKOFFICE_API_URL: 'http://10.0.2.2:8001'
  DOCKER_BACKEND: 'true'
  TEST_GLUCOSE_VALUE: '127'

---
# 1. VERIFY DOCKER BACKEND HAS SEEDED DATA
- runScript:
    file: ../../scripts/verify-backend-docker.js
    env:
      VERIFY_ACTION: 'readings_count'
      MIN_COUNT: '1'
      API_BASE_URL: ${API_BASE_URL}

# 2. LOGIN
- runFlow: ../../flows/login-local.yaml

# 3. NAVIGATE TO READINGS
- runFlow: ../../flows/navigate-readings.yaml

# 4. VERIFY READINGS PAGE LOADED
- extendedWaitUntil:
    visible:
      text: '.*Lecturas.*|.*Readings.*'
    timeout: 10000
- waitForAnimationToEnd:
    timeout: 2000

# 5. VERIFY SEEDED READINGS ARE VISIBLE
- extendedWaitUntil:
    visible:
      text: '.*Mostrando.*lecturas.*|.*Showing.*readings.*'
    timeout: 15000

# 6. TAP ADD READING BUTTON (FAB)
- tapOn:
    id: 'fab-add-reading'
    optional: true
- runFlow:
    when:
      notVisible:
        id: 'fab-add-reading'
    commands:
      - tapOn:
          text: '.*Agregar.*|.*Add.*|.*Nueva.*'
    optional: true
- waitForAnimationToEnd:
    timeout: 2000

# 7. VERIFY ADD FORM APPEARED
- extendedWaitUntil:
    visible:
      text: '.*Agregar.*Lectura.*|.*Add.*Reading.*|.*Valor.*|.*Value.*'
    timeout: 5000

# 8. ENTER GLUCOSE VALUE
- tapOn:
    id: 'glucose-value-input'
    optional: true
- inputText: ${TEST_GLUCOSE_VALUE}
- hideKeyboard
- waitForAnimationToEnd:
    timeout: 500

# 9. SCROLL TO SAVE BUTTON
- swipe:
    start: '50%,80%'
    end: '50%,40%'
- waitForAnimationToEnd:
    timeout: 500

# 10. TAP SAVE BUTTON
- tapOn:
    id: 'add-reading-save-btn'
    optional: true
- runFlow:
    when:
      notVisible:
        id: 'add-reading-save-btn'
    commands:
      - tapOn:
          text: '.*Guardar.*|.*Save.*|.*Agregar.*|.*Add.*'
    optional: true
- waitForAnimationToEnd:
    timeout: 3000

# 11. VERIFY BACK ON READINGS LIST
- extendedWaitUntil:
    visible:
      text: '.*Mostrando.*lecturas.*|.*Showing.*readings.*|.*Lecturas.*|.*Readings.*'
    timeout: 10000

# 12. CRITICAL: VERIFY DOCKER BACKEND RECEIVED THE READING
- runScript:
    file: ../../scripts/verify-backend-docker.js
    env:
      VERIFY_ACTION: 'readings_exist'
      EXPECTED_VALUE: ${TEST_GLUCOSE_VALUE}
      API_BASE_URL: ${API_BASE_URL}

# 13. VERIFY OUTPUT
- assertTrue: ${output.verified}
- assertTrue: ${output.readingFound}

# 14. UI VERIFICATION - Value should appear in list
- assertVisible:
    text: '127'

# 15. FINAL VERIFICATION
- assertVisible:
    text: '.*Lecturas.*|.*Readings.*'
# Test passes - Reading created and verified in Docker backend!
