# ==========================================
# Test: Readings - Filter by Date Range
# Description: Test date range filtering functionality
# Covers: Open filter modal, select date range, verify filtered results
# Uses bilingual selectors and shadow DOM workarounds
# ==========================================

appId: io.diabetactic.app

---
# 1. LOGIN WITH FRESH STATE
- runFlow: ../../flows/login.yaml

# 2. NAVIGATE TO READINGS TAB
- runFlow: ../../flows/navigate-readings.yaml

# 3. WAIT FOR READINGS PAGE TO FULLY HYDRATE
- extendedWaitUntil:
    visible:
      text: 'Mostrando.*lecturas|Showing.*readings|Lecturas|Readings'
    timeout: 10000
- waitForAnimationToEnd:
    timeout: 2000

# 4. VERIFY FILTER BUTTON IS VISIBLE
- assertVisible:
    text: 'Filter|Filtrar'
    optional: true

# 5. TAP FILTER BUTTON (filter icon in toolbar)
# Try icon first, fallback to point tap
- tapOn:
    id: 'filter-button'
    optional: true
- tapOn:
    point: '90%,10%'
    optional: true
- waitForAnimationToEnd:
    timeout: 2000

# 6. VERIFY FILTER MODAL OPENED
- extendedWaitUntil:
    visible:
      text: 'Filtrar Lecturas|Filter Readings|Filtros|Filters'
    timeout: 8000

# 7. VERIFY DATE RANGE OPTION IS VISIBLE
- assertVisible:
    text: 'Rango de Fecha|Date Range|Desde|From|Hasta|To'

# 8. SELECT START DATE SECTION
# Tap on "From" or "Desde" date picker
- tapOn:
    text: 'Desde|From'
    optional: true
- waitForAnimationToEnd:
    timeout: 1000

# 9. IF DATE PICKER OPENED, SELECT A DATE
# Date picker might show calendar - select "today - 7 days"
- tapOn:
    text: 'OK|Aceptar'
    optional: true
- waitForAnimationToEnd:
    timeout: 1000

# 10. SELECT END DATE SECTION
- tapOn:
    text: 'Hasta|To|Until'
    optional: true
- waitForAnimationToEnd:
    timeout: 1000

# 11. CONFIRM END DATE
- tapOn:
    text: 'OK|Aceptar'
    optional: true
- waitForAnimationToEnd:
    timeout: 1000

# 12. SCROLL TO ENSURE APPLY BUTTON IS VISIBLE
- swipe:
    start: '50%,80%'
    end: '50%,40%'
    duration: 400
- waitForAnimationToEnd:
    timeout: 500

# 13. TAP APPLY FILTERS BUTTON
- tapOn:
    id: 'apply-filters-btn'
    optional: true
- tapOn:
    text: 'Aplicar Filtros|Apply Filters|Aplicar|Apply'
    optional: true
- waitForAnimationToEnd:
    timeout: 2000

# 14. VERIFY MODAL CLOSED AND BACK ON READINGS PAGE
- extendedWaitUntil:
    visible:
      text: 'Mostrando.*lecturas|Showing.*readings'
    timeout: 8000

# 15. VERIFY FILTER CHIP/BADGE IS VISIBLE (indicates active filter)
- assertVisible:
    text: 'Rango de Fecha|Date Range'
    optional: true

# 16. VERIFY FILTER COUNT BADGE ON FILTER BUTTON
# Should show "1" badge indicating one active filter
- assertVisible:
    text: '1'
    optional: true

# 17. TAP FILTER BUTTON AGAIN TO VERIFY SELECTED VALUES PERSIST
- tapOn:
    point: '90%,10%'
    optional: true
- waitForAnimationToEnd:
    timeout: 2000

# 18. VERIFY FILTER MODAL SHOWS ACTIVE FILTERS
- extendedWaitUntil:
    visible:
      text: 'Filtrar Lecturas|Filter Readings'
    timeout: 5000

# 19. CLEAR FILTERS
- scrollUntilVisible:
    element:
      text: 'Limpiar Filtros|Clear Filters|Limpiar|Clear'
    direction: DOWN
    timeout: 5000
- tapOn:
    text: 'Limpiar Filtros|Clear Filters|Limpiar|Clear'
- waitForAnimationToEnd:
    timeout: 2000

# 20. VERIFY FILTERS CLEARED (no active filter chips)
- extendedWaitUntil:
    visible:
      text: 'Mostrando.*lecturas|Showing.*readings'
    timeout: 8000

# 21. VERIFY FILTER BADGE DISAPPEARED
- assertNotVisible:
    text: 'Rango de Fecha|Date Range'
    timeout: 2000
