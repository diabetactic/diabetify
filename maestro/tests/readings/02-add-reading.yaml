# ==========================================
# Test: Add Glucose Reading
# Description: Add a new reading and verify it appears
# Uses text selectors (data-testid not accessible in Capacitor WebView)
# ==========================================

appId: io.diabetactic.app

env:
  TEST_GLUCOSE_VALUE: '120'

---
# 1. LOGIN
- runFlow: ../../flows/login.yaml

# 2. NAVIGATE TO READINGS TAB
- runFlow: ../../flows/navigate-readings.yaml

# 3. WAIT FOR PAGE TO FULLY HYDRATE
- waitForAnimationToEnd:
    timeout: 2000

# 4. TAP ADD BUTTON (FAB - using text from dashboard button)
# On dashboard there's a visible "Agregar Lectura" button, or tap + icon FAB
- tapOn:
    text: 'Agregar Lectura|Add Reading|Agregar Nueva Lectura|Add New Reading'
- waitForAnimationToEnd:
    timeout: 2000

# 5. VERIFY ADD READING FORM LOADED
- extendedWaitUntil:
    visible:
      text: 'Agregar Lectura|Add Reading'
    timeout: 5000

# 6. ENTER GLUCOSE VALUE
# Try data-testid first (more reliable), fallback to point tap for shadow DOM
- tapOn:
    id: 'glucose-value-input'
    optional: true
- tapOn:
    point: '50%,35%'
    optional: true
- waitForAnimationToEnd:
    timeout: 500
- inputText: ${TEST_GLUCOSE_VALUE}
- hideKeyboard
- waitForAnimationToEnd:
    timeout: 1000

# 7. SWIPE UP TO MAKE SURE SAVE BUTTON IS VISIBLE
- swipe:
    start: '50%,80%'
    end: '50%,40%'
- waitForAnimationToEnd:
    timeout: 500

# 8. SAVE READING - use data-testid or fallback to text selector
- tapOn:
    id: 'add-reading-save-btn'
    optional: true
- tapOn:
    text: 'Guardar|Save'
    optional: true
- tapOn:
    point: '50%,90%'
    optional: true
- waitForAnimationToEnd:
    timeout: 2000

# 9. WAIT FOR SUCCESS (back to readings list)
- extendedWaitUntil:
    visible:
      text: 'Mostrando.*lecturas|Showing.*readings|Lecturas|Readings'
    timeout: 8000

# 10. VERIFY WE'RE ON READINGS PAGE (new reading may need sync to appear)
- assertVisible:
    text: 'Lecturas|Readings'

# 11. OPTIONAL: Check if 120 appears (may need time to sync)
- assertVisible:
    text: '120'
    optional: true
