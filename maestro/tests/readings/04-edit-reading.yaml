# ==========================================
# Test: Edit Existing Reading (WITH BACKEND VERIFICATION)
# Description: Edit a glucose reading and VERIFY update in backend
# This test validates data persistence on edit, not just UI
# ==========================================

appId: io.diabetactic.app

env:
  # Create reading with this value first
  INITIAL_VALUE: '175'
  # Edit to this value
  EDITED_VALUE: '135'
  API_BASE_URL: 'https://diabetactic-api-gateway-37949d6f182f.herokuapp.com'

---
# 1. LOGIN WITH FRESH STATE
- runFlow: ../../flows/login.yaml

# 2. NAVIGATE TO READINGS TAB
- runFlow: ../../flows/navigate-readings.yaml

# 3. WAIT FOR READINGS PAGE TO FULLY HYDRATE
- extendedWaitUntil:
    visible:
      text: 'Lecturas|Readings'
    timeout: 10000

# 3.1 WAIT FOR LOADING TO COMPLETE
- extendedWaitUntil:
    notVisible:
      text: 'Cargando lecturas|Loading readings'
    timeout: 20000
- waitForAnimationToEnd:
    timeout: 2000

# 4. CREATE A READING TO EDIT (deterministic test)
- tapOn:
    id: 'fab-add-reading'
- waitForAnimationToEnd:
    timeout: 2000

- extendedWaitUntil:
    visible:
      text: 'Agregar Lectura|Add Reading'
    timeout: 5000

- tapOn:
    id: 'glucose-value-input'
- inputText: ${INITIAL_VALUE}
- hideKeyboard

- swipe:
    start: '50%,80%'
    end: '50%,40%'

- tapOn:
    id: 'add-reading-save-btn'
- waitForAnimationToEnd:
    timeout: 3000

# 5. VERIFY READING WAS CREATED IN BACKEND
- runScript:
    file: ../../scripts/verify-backend.js
    env:
      VERIFY_ACTION: 'readings_exist'
      EXPECTED_VALUE: ${INITIAL_VALUE}
      USER_ID: ${TEST_USER_ID}
      USER_PASSWORD: ${TEST_USER_PASSWORD}
      API_BASE_URL: ${API_BASE_URL}

- assertTrue: ${output.verified}

# 6. WAIT FOR LIST TO RELOAD
- extendedWaitUntil:
    visible:
      text: 'Mostrando.*lecturas|Showing.*readings|Lecturas|Readings'
    timeout: 10000

# 7. VERIFY INITIAL VALUE APPEARS
- assertVisible:
    text: '175'

# 8. TAP ON THE READING TO EDIT IT
- tapOn:
    text: '175'
- waitForAnimationToEnd:
    timeout: 2000

# 9. VERIFY READING DETAIL VIEW OPENED
- extendedWaitUntil:
    visible:
      text: 'Editar Lectura|Edit Reading|Editar|Edit|Detalles|Details'
    timeout: 8000

# 10. TAP EDIT BUTTON IF IN DETAIL VIEW
- tapOn:
    text: 'Editar|Edit'
- waitForAnimationToEnd:
    timeout: 1500

# 11. VERIFY EDIT FORM IS VISIBLE
- extendedWaitUntil:
    visible:
      text: 'Glucosa|Glucose'
    timeout: 5000

# 12. CLEAR EXISTING VALUE AND ENTER NEW VALUE
- tapOn:
    id: 'glucose-value-input'
- eraseText
- inputText: ${EDITED_VALUE}
- hideKeyboard
- waitForAnimationToEnd:
    timeout: 1000

# 13. SCROLL TO ENSURE SAVE BUTTON IS VISIBLE
- swipe:
    start: '50%,80%'
    end: '50%,40%'
    duration: 400
- waitForAnimationToEnd:
    timeout: 500

# 14. TAP SAVE/UPDATE BUTTON
- tapOn:
    text: 'Guardar|Save|Actualizar|Update'
- waitForAnimationToEnd:
    timeout: 3000

# 15. VERIFY BACK ON READINGS LIST
- extendedWaitUntil:
    visible:
      text: 'Mostrando.*lecturas|Showing.*readings'
    timeout: 8000

# 16. CRITICAL: VERIFY BACKEND HAS THE EDITED VALUE
- runScript:
    file: ../../scripts/verify-backend.js
    env:
      VERIFY_ACTION: 'readings_exist'
      EXPECTED_VALUE: ${EDITED_VALUE}
      USER_ID: ${TEST_USER_ID}
      USER_PASSWORD: ${TEST_USER_PASSWORD}
      API_BASE_URL: ${API_BASE_URL}

# 17. VERIFY OUTPUT
- assertTrue: ${output.verified}
- assertTrue: ${output.readingFound}

# 18. UI VERIFICATION - Edited value should appear
- assertVisible:
    text: '135'

# 19. VERIFY PAGE IS STABLE
- assertVisible:
    text: 'Lecturas|Readings'
