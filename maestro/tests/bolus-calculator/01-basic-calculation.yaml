# ==========================================
# Test: Bolus Calculator - Basic Insulin Calculation
# Description: Test complete flow of insulin dose calculation
# Covers: Input glucose, input carbs, calculate, verify result
# Uses point-based taps for shadow DOM form elements
# ==========================================

appId: io.diabetactic.app

env:
  TEST_GLUCOSE_VALUE: '180'
  TEST_CARB_VALUE: '45'

---
# 1. LOGIN
- runFlow: ../../flows/login.yaml

# 2. WAIT FOR DASHBOARD TO FULLY LOAD (skeleton complete)
- extendedWaitUntil:
    visible:
      text: '.*(Inicio|Home|Dashboard).*'
    timeout: 8000
- waitForAnimationToEnd:
    timeout: 2000

# 3. WAIT FOR SKELETON LOADING TO COMPLETE
# Dashboard shows skeleton while loading stats - wait for it to finish
- extendedWaitUntil:
    visible:
      text: 'Tiempo en Rango|Time in Range|%|mg/dL'
    timeout: 18000
- waitForAnimationToEnd:
    timeout: 2000

# 4. WAIT FOR QUICK ACTIONS TO LOAD (indicates skeleton complete)
- extendedWaitUntil:
    visible:
      text: 'Acciones Rápidas|Quick Actions'
    timeout: 10000

# 5. SCROLL DOWN TO ENSURE BUTTON IS VISIBLE
- swipe:
    start: '50%,70%'
    end: '50%,40%'
    duration: 400
- waitForAnimationToEnd:
    timeout: 500

# 6. NAVIGATE TO BOLUS CALCULATOR VIA QUICK ACTIONS BUTTON
- tapOn:
    text: 'Calculadora de Bolos|Bolus Calculator'
- waitForAnimationToEnd:
    timeout: 1500

# 7. VERIFY BOLUS CALCULATOR PAGE LOADED
- extendedWaitUntil:
    visible:
      text: 'Calculadora de Bolo|Bolus Calculator'
    timeout: 8000

# 8. VERIFY FORM ELEMENTS ARE VISIBLE
- assertVisible:
    text: 'Glucosa Actual|Current Glucose'
- assertVisible:
    text: 'Carbohidratos|Carbohydrates'

# 9. ENTER GLUCOSE VALUE
- tapOn:
    id: 'current-glucose-input'
- waitForAnimationToEnd:
    timeout: 500
- inputText: ${TEST_GLUCOSE_VALUE}
- hideKeyboard
- waitForAnimationToEnd:
    timeout: 1000

# 10. ENTER CARBOHYDRATE VALUE
- tapOn:
    id: 'carb-grams-input'
- waitForAnimationToEnd:
    timeout: 500
- inputText: ${TEST_CARB_VALUE}
- hideKeyboard
- waitForAnimationToEnd:
    timeout: 1000

# 11. SCROLL TO ENSURE CALCULATE BUTTON IS VISIBLE
- swipe:
    start: '50%,80%'
    end: '50%,40%'
    duration: 400
- waitForAnimationToEnd:
    timeout: 500

# 12. TAP CALCULATE BUTTON
- tapOn:
    id: 'calculate-bolus-btn'
- waitForAnimationToEnd:
    timeout: 2000

# 13. VERIFY RESULT IS DISPLAYED
# Should see "Recommended Dose" heading and units
- extendedWaitUntil:
    visible:
      text: 'Dosis Recomendada|Recommended Dose'
    timeout: 8000

# 14. VERIFY INSULIN UNITS ARE SHOWN
- assertVisible:
    text: 'unidades|units'

# 15. VERIFY DETAILS SECTION IS VISIBLE
- assertVisible:
    text: 'Detalles|Details'

# 16. VERIFY INPUT VALUES ARE DISPLAYED IN RESULTS
- assertVisible:
    text: '180'
- assertVisible:
    text: '45'

# 17. VERIFY NEW CALCULATION BUTTON IS AVAILABLE
- scrollUntilVisible:
    element:
      text: 'Nueva Calculación|New Calculation'
    direction: DOWN
    timeout: 5000

# 18. TAP NEW CALCULATION TO RESET FORM
- tapOn:
    text: 'Nueva Calculación|New Calculation'
- waitForAnimationToEnd:
    timeout: 1000

# 19. VERIFY FORM IS RESET (result should disappear)
- assertNotVisible:
    text: 'Dosis Recomendada|Recommended Dose'

# 20. VERIFY FORM IS READY FOR NEW INPUT
- assertVisible:
    text: 'Calcular Dosis|Calculate Dose'
