appId: io.diabetactic.app
env:
  BACKOFFICE_API_URL: 'https://dt-api-gateway-backoffice-3dead350d8fa.herokuapp.com'
  TEST_USER_ID: '1000'
  TEST_USER_PASSWORD: 'tuvieja'
  API_USER_ID: '1' # Backend assigns user_id: 1 for login "1000"
  ADMIN_USERNAME: 'admin'
  ADMIN_PASSWORD: 'admin'
  GLUCOSE_OBJECTIVE: '110'
  DOSE: '12'
---
# ==========================================
# Test: Full Appointment State Machine (Robust Version)
# Flow: NONE -> PENDING -> ACCEPTED -> CREATED
# Fixes: Modals, Stale UI, API Integration
# ==========================================

# 1. SETUP & CLEAN STATE
- clearState: io.diabetactic.app
- launchApp

# 2. LOGIN FLOW (Inline - Handles Welcome Screen)
- extendedWaitUntil:
    visible:
      text: '.*Diabetactic.*'
    timeout: 3000

- tapOn:
    text: 'Iniciar Sesión|Sign In'
    optional: true
- waitForAnimationToEnd

- extendedWaitUntil:
    visible:
      text: 'DNI o Email|DNI or Email'
    timeout: 3000

- tapOn:
    text: 'DNI o Email|DNI or Email'
- eraseText
- inputText: '${TEST_USER_ID}'
- hideKeyboard

- tapOn:
    text: 'Contraseña|Password'
- eraseText
- inputText: '${TEST_USER_PASSWORD}'
- hideKeyboard

- tapOn:
    text: 'Iniciar Sesión|Sign In'
- waitForAnimationToEnd

# 3. VERIFY DASHBOARD & NAVIGATE
- extendedWaitUntil:
    visible:
      text: 'Dashboard|Tablero|Inicio|Home'
    timeout: 5000

- tapOn:
    text: 'Citas|Appointments'
- waitForAnimationToEnd

# 4. PRE-CONDITION: CLEAR QUEUE (API)
- runScript:
    file: ../../scripts/backoffice-api-fetch.js
    env:
      ACTION: 'clear'
      USER_ID: ${API_USER_ID}
      BACKOFFICE_API_URL: ${BACKOFFICE_API_URL}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

# Force app restart to reload data from server
- stopApp
- waitForAnimationToEnd:
    timeout: 1000
- launchApp
- waitForAnimationToEnd

# Navigate back to appointments
- extendedWaitUntil:
    visible:
      text: 'Dashboard|Tablero|Inicio|Home'
    timeout: 3000
- tapOn:
    text: 'Citas|Appointments'
- waitForAnimationToEnd

# 5. STEP 1: REQUEST APPOINTMENT (NONE -> PENDING)
- extendedWaitUntil:
    visible:
      text: 'Solicitar Cita|Request Appointment'
    timeout: 3000

- tapOn:
    text: 'Solicitar Cita|Request Appointment'
- waitForAnimationToEnd

# --- FIX: HANDLE CONFIRMATION MODAL ---
# "Su solicitud ha sido enviada" -> [OK]
- extendedWaitUntil:
    visible:
      text: '.*(OK|Aceptar).*'
    timeout: 2000
- tapOn:
    text: '.*(OK|Aceptar).*'
- waitForAnimationToEnd

# 6. VERIFY PENDING STATE
- extendedWaitUntil:
    visible:
      text: '.*(Pendiente|Pending).*'
    timeout: 3000

# 7. STEP 2: ADMIN ACCEPTS (PENDING -> ACCEPTED)
- runScript:
    file: ../../scripts/backoffice-api-fetch.js
    env:
      ACTION: 'accept'
      USER_ID: ${API_USER_ID}
      BACKOFFICE_API_URL: ${BACKOFFICE_API_URL}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

# Force app restart to reload accepted state
- stopApp
- waitForAnimationToEnd:
    timeout: 1000
- launchApp
- waitForAnimationToEnd

# Navigate back to appointments
- extendedWaitUntil:
    visible:
      text: 'Dashboard|Tablero|Inicio|Home'
    timeout: 3000
- tapOn:
    text: 'Citas|Appointments'
- waitForAnimationToEnd

# 8. VERIFY ACCEPTED STATE
- extendedWaitUntil:
    visible:
      text: '.*(Aceptada|Accepted).*'
    timeout: 3000

# 9. STEP 3: CREATE CLINICAL APPOINTMENT (ACCEPTED -> CREATED)
- tapOn:
    text: 'Agregar.*|Add.*'
- waitForAnimationToEnd

# Wait for Form
- extendedWaitUntil:
    visible:
      text: '.*(Objetivo|Objective).*'
    timeout: 3000

# Fill Form (Shadow DOM Bypass)
- tapOn:
    text: '.*(Objetivo|Objective).*'
- inputText: '${GLUCOSE_OBJECTIVE}'
- hideKeyboard

- tapOn:
    text: '.*(Dosis|Dose).*'
- inputText: '${DOSE}'
- hideKeyboard

# Scroll down to find submit button
- scroll
- waitForAnimationToEnd

# Submit button might be below form - double scroll to find it
- scroll
- waitForAnimationToEnd:
    timeout: 1000

# Tap submit button
- tapOn:
    text: 'Guardar|Crear'
- waitForAnimationToEnd

# --- FIX: HANDLE SUCCESS MODAL (If exists) ---
- tapOn:
    text: '.*(OK|Aceptar).*'
    optional: true
- waitForAnimationToEnd

# 10. FINAL VERIFICATION (CREATED)
- extendedWaitUntil:
    visible:
      text: '.*(Citas|Appointments).*'
    timeout: 3000

# Look for the card showing "Actual" or the details we just entered
- assertVisible:
    text: '.*(Actual|Current).*'
    optional: true
