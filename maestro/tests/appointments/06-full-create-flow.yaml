# ==========================================
# Test: Complete Appointment Creation Flow with Backend Verification
# Description: Full E2E test that creates a REAL appointment
#   1. Clears queue via backoffice API
#   2. Requests appointment (NONE → PENDING)
#   3. Accepts via backoffice API (PENDING → ACCEPTED)
#   4. Fills form and submits (ACCEPTED → CREATED)
#   5. Verifies new appointment in list
# ==========================================

appId: io.diabetactic.app

env:
  BACKOFFICE_API_URL: https://dt-api-gateway-backoffice-3dead350d8fa.herokuapp.com
  USER_API_URL: https://diabetactic-api-gateway-37949d6f182f.herokuapp.com
  TEST_USER_ID: '1000'
  ADMIN_USERNAME: admin
  ADMIN_PASSWORD: admin

---
# ============ PHASE 1: SETUP - Clear Queue ============
- runScript:
    file: ../../scripts/backoffice-api-fetch.js
    env:
      ACTION: clear

# ============ PHASE 2: LOGIN ============
- runFlow: ../../flows/login.yaml

# ============ PHASE 3: NAVIGATE TO APPOINTMENTS ============
- runFlow: ../../flows/navigate-appointments.yaml

# Wait for page to fully load
- extendedWaitUntil:
    visible:
      text: '.*Citas.*|.*Appointments.*'
    timeout: 8000

- extendedWaitUntil:
    notVisible:
      text: '.*Cargando.*|.*Loading.*'
    timeout: 15000

# ============ PHASE 4: REQUEST APPOINTMENT ============
# With queue cleared, should see "Solicitar Cita" button
- extendedWaitUntil:
    visible:
      text: '.*Solicitar.*Cita.*|.*Request.*Appointment.*'
    timeout: 10000

- tapOn:
    text: '.*Solicitar.*Cita.*|.*Request.*Appointment.*'

# Wait for request to process
- waitForAnimationToEnd:
    timeout: 3000

# Verify state changed to PENDING
- extendedWaitUntil:
    visible:
      text: '.*Pendiente.*|.*Pending.*|.*esperando.*revisión.*|.*waiting.*reviewed.*'
    timeout: 10000

# ============ PHASE 5: ACCEPT VIA BACKOFFICE API ============
- runScript:
    file: ../../scripts/backoffice-api-fetch.js
    env:
      ACTION: accept
      USER_ID: '1000'

# Pull to refresh to get updated state (explicit coordinates)
- swipe:
    start: '50%,30%'
    end: '50%,70%'
    duration: 500
- waitForAnimationToEnd:
    timeout: 3000

# Verify state changed to ACCEPTED
- extendedWaitUntil:
    visible:
      text: '.*Aceptada.*|.*Accepted.*|.*completar.*formulario.*|.*fill.*form.*|.*Nueva.*Cita.*|.*New.*Appointment.*'
    timeout: 15000

# ============ PHASE 6: FILL APPOINTMENT FORM ============
# Tap on create appointment button (should be visible in ACCEPTED state)
- tapOn:
    text: '.*Nueva.*Cita.*|.*New.*Appointment.*|.*Completar.*Formulario.*|.*Fill.*Form.*|.*Agregar.*Cita.*|.*Add.*Appointment.*'

# Wait for form to load
- extendedWaitUntil:
    visible:
      text: '.*Objetivo.*Glucosa.*|.*Glucose.*Objective.*|.*Nueva.*Cita.*|.*New.*Appointment.*'
    timeout: 8000

# Fill Glucose Objective
- tapOn:
    text: '.*Objetivo.*Glucosa.*|.*Glucose.*Objective.*'
- inputText: '120'
- hideKeyboard

# Scroll down to see more fields
- swipe:
    start: '50%,70%'
    end: '50%,30%'
    duration: 400

# Fill Dose
- tapOn:
    text: '.*Dosis.*|.*Dose.*'
    index: 0
- inputText: '10'
- hideKeyboard

# Fill Fast Insulin brand
- tapOn:
    text: '.*Marca.*Insulina.*|.*Fast.*Insulin.*|.*Insulina.*Rápida.*'
- inputText: 'Humalog'
- hideKeyboard

# Scroll more
- swipe:
    start: '50%,70%'
    end: '50%,30%'
    duration: 400

# Fill Fixed Dose
- tapOn:
    text: '.*Dosis.*Fija.*|.*Fixed.*Dose.*'
- inputText: '5'
- hideKeyboard

# Fill Ratio
- tapOn:
    text: '.*Relación.*|.*Ratio.*'
- inputText: '10'
- hideKeyboard

# Scroll more
- swipe:
    start: '50%,70%'
    end: '50%,30%'
    duration: 400

# Fill Sensitivity
- tapOn:
    text: '.*Sensibilidad.*|.*Sensitivity.*|.*Factor.*Corrección.*'
- inputText: '50'
- hideKeyboard

# Scroll to see motive checkboxes
- swipe:
    start: '50%,70%'
    end: '50%,30%'
    duration: 400

# Select a motive (tap on Ajuste checkbox)
- tapOn:
    text: '.*Ajuste.*|.*Adjustment.*'

# Scroll to submit button
- swipe:
    start: '50%,70%'
    end: '50%,30%'
    duration: 400

# ============ PHASE 7: SUBMIT FORM ============
- tapOn:
    text: '.*Guardar.*|.*Submit.*|.*Enviar.*|.*Save.*'

# Wait for submission
- waitForAnimationToEnd:
    timeout: 5000

# ============ PHASE 8: VERIFY APPOINTMENT CREATED ============
# Should be back on appointments page with CREATED state
- extendedWaitUntil:
    visible:
      text: '.*Citas.*|.*Appointments.*|.*Completada.*|.*Created.*|.*registrada.*'
    timeout: 10000

# Verify the new appointment appears in the list
# The appointment should show motive "Ajuste" or "Adjustment"
- assertVisible:
    text: '.*Ajuste.*|.*Adjustment.*|.*AJUSTE.*'
# Test completed successfully - new appointment was created!
