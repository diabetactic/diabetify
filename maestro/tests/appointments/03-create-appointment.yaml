# ==========================================
# Test: Create Clinical Appointment (ACCEPTED -> CREATED)
# Description: User fills clinical form after acceptance
# Prerequisite: User must be in ACCEPTED state
# ==========================================

appId: io.diabetactic.app

env:
  GLUCOSE_OBJECTIVE: '100'
  DOSE: '10'
  BACKOFFICE_API_URL: 'https://dt-api-gateway-backoffice-3dead350d8fa.herokuapp.com'
  BACKOFFICE_ADMIN_USERNAME: 'admin'
  BACKOFFICE_ADMIN_PASSWORD: 'admin'
  TEST_USER_ID: '1000'

---
# 0. ENSURE QUEUE CLEAN & CREATE ACCEPTED STATE
- runScript:
    file: ../../scripts/backoffice-api-fetch.js
    env:
      ACTION: 'open'
      BACKOFFICE_API_URL: ${BACKOFFICE_API_URL}
      ADMIN_USERNAME: ${BACKOFFICE_ADMIN_USERNAME}
      ADMIN_PASSWORD: ${BACKOFFICE_ADMIN_PASSWORD}

# 1. LOGIN
- runFlow: ../../flows/login.yaml

# 2. NAVIGATE TO APPOINTMENTS
- runFlow: ../../flows/navigate-appointments.yaml

# 2b. IF NOT ACCEPTED, REQUEST THEN ACCEPT VIA API
- tapOn:
    text: 'Solicitar Cita|Request Appointment'
    optional: true
- tapOn:
    text: '.*(OK|Aceptar).*'
    optional: true
- waitForAnimationToEnd
- extendedWaitUntil:
    visible:
      text: 'Pendiente|Pending'
    timeout: 8000
    optional: true

- runScript:
    file: ../../scripts/backoffice-api-fetch.js
    env:
      ACTION: 'accept'
      USER_ID: ${TEST_USER_ID}
      BACKOFFICE_API_URL: ${BACKOFFICE_API_URL}
      ADMIN_USERNAME: ${BACKOFFICE_ADMIN_USERNAME}
      ADMIN_PASSWORD: ${BACKOFFICE_ADMIN_PASSWORD}

- stopApp
- waitForAnimationToEnd:
    timeout: 1000
- launchApp
- waitForAnimationToEnd
- runFlow: ../../flows/login.yaml
- runFlow: ../../flows/navigate-appointments.yaml

# 3. VERIFY ACCEPTED STATE (Create button visible)
- extendedWaitUntil:
    visible:
      text: 'Agregar Nueva Cita|Add New Appointment'
    timeout: 8000

# 4. TAP CREATE APPOINTMENT BUTTON
- tapOn:
    text: 'Agregar Nueva Cita|Add New Appointment'
- waitForAnimationToEnd

# 5. VERIFY CLINICAL FORM LOADED
- extendedWaitUntil:
    visible:
      text: 'Objetivo de Glucosa|Glucose Objective'
    timeout: 5000

# 6. FILL GLUCOSE OBJECTIVE (Shadow DOM bypass)
- tapOn:
    text: 'Objetivo de Glucosa|Glucose Objective'
- inputText: ${GLUCOSE_OBJECTIVE}
- hideKeyboard
- waitForAnimationToEnd

# 7. FILL DOSE
- tapOn:
    text: 'Dosis|Dose'
- inputText: ${DOSE}
- hideKeyboard
- waitForAnimationToEnd

# 8. SELECT INSULIN TYPE (if visible)
- tapOn:
    text: 'Tipo de Insulina|Insulin Type'
    optional: true
- waitForAnimationToEnd
- tapOn:
    text: 'Acción Rápida|Rapid Acting'
    optional: true
- waitForAnimationToEnd

# 9. SELECT MOTIVE/REASON
- tapOn:
    text: 'Motivo|Reason'
    optional: true
- waitForAnimationToEnd
- tapOn:
    text: 'Ajuste de Dosis|Adjustment'
    optional: true
- waitForAnimationToEnd

# 10. SUBMIT FORM (bilingual)
- tapOn:
    text: 'Guardar|Save'
- waitForAnimationToEnd

# 11. WAIT FOR SUCCESS
- extendedWaitUntil:
    visible:
      text: 'Citas|Appointments'
    timeout: 8000

# 12. VERIFY CREATED STATE
- assertVisible:
    text: 'Actual|Current'
    optional: true
