# ==========================================
# Test: Request Appointment (WITH BACKEND VERIFICATION)
# Description: Request appointment and VERIFY state changes to PENDING
# This test validates the full appointment request flow
# ==========================================

appId: io.diabetactic.app

env:
  BACKOFFICE_API_URL: 'https://dt-api-gateway-backoffice-3dead350d8fa.herokuapp.com'
  API_BASE_URL: 'https://diabetactic-api-gateway-37949d6f182f.herokuapp.com'
  ADMIN_USERNAME: 'admin'
  ADMIN_PASSWORD: 'admin'

---
# 1. SETUP: Clear any existing appointment queue
- runScript:
    file: ../../scripts/backoffice-api-fetch.js
    env:
      ACTION: 'clear'
      BACKOFFICE_API_URL: ${BACKOFFICE_API_URL}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

# 2. SETUP: Open the queue
- runScript:
    file: ../../scripts/backoffice-api-fetch.js
    env:
      ACTION: 'open'
      BACKOFFICE_API_URL: ${BACKOFFICE_API_URL}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

# 3. LOGIN
- runFlow: ../../flows/login.yaml

# 4. VERIFY INITIAL STATE IS NONE
- runScript:
    file: ../../scripts/verify-backend.js
    env:
      VERIFY_ACTION: 'appointment_state'
      EXPECTED_STATE: 'NONE'
      USER_ID: ${TEST_USER_ID}
      USER_PASSWORD: ${TEST_USER_PASSWORD}
      API_BASE_URL: ${API_BASE_URL}

# 5. NAVIGATE TO APPOINTMENTS
- runFlow: ../../flows/navigate-appointments.yaml

# 6. VERIFY PAGE HEADER LOADED
- extendedWaitUntil:
    visible:
      text: 'Citas|Appointments'
    timeout: 8000

# 7. WAIT FOR PAGE TO FULLY LOAD
- waitForAnimationToEnd:
    timeout: 3000

# 8. TAP REQUEST APPOINTMENT BUTTON
- tapOn:
    text: 'Solicitar|Request|Pedir Cita|Request Appointment'
- waitForAnimationToEnd:
    timeout: 2000

# 9. IF FORM APPEARS, FILL AND SUBMIT
# (Queue might auto-submit, or show form - handle both)
- extendedWaitUntil:
    visible:
      text: 'Cola|Queue|Enviado|Submitted|PENDING|Pendiente|Solicitar|Submit'
    timeout: 10000

# 10. IF SUBMIT BUTTON VISIBLE, TAP IT
- tapOn:
    text: 'Enviar|Submit|Confirmar|Confirm'
    optional: true
- waitForAnimationToEnd:
    timeout: 3000

# 11. CRITICAL: VERIFY BACKEND STATE IS NOW PENDING
- runScript:
    file: ../../scripts/verify-backend.js
    env:
      VERIFY_ACTION: 'appointment_state'
      EXPECTED_STATE: 'PENDING'
      USER_ID: ${TEST_USER_ID}
      USER_PASSWORD: ${TEST_USER_PASSWORD}
      API_BASE_URL: ${API_BASE_URL}

# 12. VERIFY OUTPUT
- assertTrue: ${output.verified}

# 13. UI VERIFICATION - Should show pending status
- assertVisible:
    text: 'PENDING|Pendiente|En Cola|In Queue|Esperando|Waiting'
