# ==========================================
# Test: Accept Appointment (WITH BACKEND VERIFICATION)
# Description: Accept a pending appointment via backoffice and verify UI updates
# This test validates the full PENDING -> ACCEPTED flow
# Uses .* wildcards for bilingual support with special chars
# ==========================================

appId: io.diabetactic.app

env:
  TEST_USER_ID: '1000'
  TEST_USER_PASSWORD: 'tuvieja'
  BACKOFFICE_API_URL: 'https://dt-api-gateway-backoffice-3dead350d8fa.herokuapp.com'
  API_BASE_URL: 'https://diabetactic-api-gateway-37949d6f182f.herokuapp.com'
  ADMIN_USERNAME: 'admin'
  ADMIN_PASSWORD: 'admin'

---
# 1. SETUP: Clear queue and create a pending appointment
- runScript:
    file: ../../scripts/backoffice-api-fetch.js
    env:
      ACTION: 'clear'
      BACKOFFICE_API_URL: ${BACKOFFICE_API_URL}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

- runScript:
    file: ../../scripts/backoffice-api-fetch.js
    env:
      ACTION: 'open'
      BACKOFFICE_API_URL: ${BACKOFFICE_API_URL}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

# 2. LOGIN
- runFlow: ../../flows/login.yaml

# 3. NAVIGATE TO APPOINTMENTS AND REQUEST
- runFlow: ../../flows/navigate-appointments.yaml

- extendedWaitUntil:
    visible:
      text: '.*Citas.*|.*Appointments.*'
    timeout: 8000

# 4. WAIT FOR LOADING TO COMPLETE
- extendedWaitUntil:
    notVisible:
      text: '.*Cargando.*citas.*|.*Loading.*appointments.*|.*Cargando.*'
    timeout: 20000
- waitForAnimationToEnd:
    timeout: 2000

# 5. REQUEST APPOINTMENT (if not already pending)
- tapOn:
    text: '.*Solicitar.*|.*Request.*|.*Pedir.*Cita.*'
    optional: true
- waitForAnimationToEnd:
    timeout: 2000

- tapOn:
    text: '.*Enviar.*|.*Submit.*|.*Confirmar.*|.*Confirm.*'
    optional: true
- waitForAnimationToEnd:
    timeout: 3000

# 6. VERIFY STATE IS PENDING
- runScript:
    file: ../../scripts/verify-backend.js
    env:
      VERIFY_ACTION: 'appointment_state'
      EXPECTED_STATE: 'PENDING'
      USER_ID: ${TEST_USER_ID}
      USER_PASSWORD: ${TEST_USER_PASSWORD}
      API_BASE_URL: ${API_BASE_URL}

# 7. ACCEPT APPOINTMENT VIA BACKOFFICE API
- runScript:
    file: ../../scripts/backoffice-api-fetch.js
    env:
      ACTION: 'accept'
      USER_ID: ${TEST_USER_ID}
      BACKOFFICE_API_URL: ${BACKOFFICE_API_URL}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

# 8. CRITICAL: VERIFY BACKEND STATE IS NOW ACCEPTED
- runScript:
    file: ../../scripts/verify-backend.js
    env:
      VERIFY_ACTION: 'appointment_state'
      EXPECTED_STATE: 'ACCEPTED'
      USER_ID: ${TEST_USER_ID}
      USER_PASSWORD: ${TEST_USER_PASSWORD}
      API_BASE_URL: ${API_BASE_URL}

- assertTrue: ${output.verified}

# 9. REFRESH UI (pull to refresh with explicit coordinates)
- swipe:
    start: '50%,30%'
    end: '50%,70%'
    duration: 500
- waitForAnimationToEnd:
    timeout: 5000

# 10. UI VERIFICATION - Should show accepted status
- extendedWaitUntil:
    visible:
      text: '.*ACCEPTED.*|.*Aceptado.*|.*Aceptada.*|.*Aprobado.*|.*Approved.*'
    timeout: 10000

- assertVisible:
    text: '.*ACCEPTED.*|.*Aceptado.*|.*Aceptada.*|.*Aprobado.*|.*Approved.*'

# 11. VERIFY PAGE IS STABLE
- assertVisible:
    text: '.*Citas.*|.*Appointments.*'
