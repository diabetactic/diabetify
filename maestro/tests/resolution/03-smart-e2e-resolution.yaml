# ==========================================
# Test: Smart E2E Resolution Verification
# Description: Complete end-to-end test that:
#   1. Creates fresh appointment data via API
#   2. Adds resolution via backoffice API
#   3. Verifies resolution exists via API (not just UI)
#   4. Navigates to appointment and verifies UI display
#
# This test CREATES new data rather than relying on existing data.
# Uses backend scripts for verification - "trust but verify" approach.
# ==========================================

appId: io.diabetactic.app

---
# ==========================================
# STEP 1: SETUP - Run E2E flow script to ensure data exists
# ==========================================
- runScript:
    file: ../../scripts/e2e-resolution-flow.js
    env:
      USER_ID: '1000'
      USER_PASSWORD: 'tuvieja'
      ADMIN_USER: 'admin'
      ADMIN_PASS: 'admin'

# Log the output for debugging
- evalScript: |
    console.log('=== Script Output ===');
    console.log('Appointment ID: ' + output.appointmentId);
    console.log('Basal Type: ' + output.basalType);
    console.log('Basal Dose: ' + output.basalDose);
    console.log('Ratio: ' + output.ratio);
    console.log('Sensitivity: ' + output.sensitivity);
    console.log('API Verified: ' + output.verified);

# ==========================================
# STEP 2: VERIFY - Double-check via separate API script
# ==========================================
- runScript:
    file: ../../scripts/verify-resolution-api.js
    env:
      APPOINTMENT_ID: '${output.appointmentId}'

# Assert API verification passed
- assertTrue:
    condition: ${output.exists}
    label: 'Resolution exists in backend API'

# ==========================================
# STEP 3: LOGIN TO APP (using smart login flow)
# ==========================================
# Smart login handles any state - already logged in or not
- runFlow: ../../flows/login-smart.yaml

# ==========================================
# STEP 4: NAVIGATE TO APPOINTMENTS
# ==========================================
- runFlow: ../../flows/navigate-appointments.yaml

# Wait for appointments page to fully load
- extendedWaitUntil:
    visible:
      text: '.*Citas.*|.*Appointments.*'
    timeout: 10000

- extendedWaitUntil:
    notVisible:
      text: '.*Cargando.*citas.*|.*Loading.*appointments.*'
    timeout: 20000

- waitForAnimationToEnd:
    timeout: 2000

# ==========================================
# STEP 5: FIND AND TAP THE APPOINTMENT
# ==========================================
# Look for the ACTUAL appointment card (most recent completed appointment)
# Uses dynamic appointment ID from script output

# Wait for appointment card to be visible
- extendedWaitUntil:
    visible:
      text: '.*ACTUAL.*|.*Cita.*#.*|.*Appointment.*#.*'
    timeout: 10000

# Dismiss any error dialogs that may have appeared
- tapOn:
    text: '.*OK.*|.*Aceptar.*'
    optional: true
- waitForAnimationToEnd:
    timeout: 1000

# Tap on the SPECIFIC appointment using dynamic ID from script
- tapOn:
    text: '.*Cita #${output.appointmentId}.*'
    optional: true
- tapOn:
    text: '.*Appointment #${output.appointmentId}.*'
    optional: true
# Fallback: tap any completed appointment card
- tapOn:
    text: '.*Cita #\\d+.*'
    optional: true

- waitForAnimationToEnd:
    timeout: 3000

# Handle error dialog if it appears after tap
- tapOn:
    text: '.*OK.*|.*Aceptar.*'
    optional: true
- waitForAnimationToEnd:
    timeout: 1000

# ==========================================
# STEP 6: VERIFY APPOINTMENT DETAIL PAGE LOADED
# ==========================================
# Try multiple patterns for detail page title
- extendedWaitUntil:
    visible:
      text: '.*Detalles.*Cita.*|.*Appointment.*Details.*|.*CITA.*#.*|.*Par√°metros.*Tratamiento.*'
    timeout: 15000

# Wait for appointment data to load
- extendedWaitUntil:
    notVisible:
      text: '.*Cargando.*cita.*|.*Loading.*appointment.*'
    timeout: 15000

- waitForAnimationToEnd:
    timeout: 2000

# ==========================================
# STEP 7: WAIT FOR RESOLUTION LOADING
# ==========================================
# CRITICAL: Resolution loads AFTER appointment data (separate API call)
# Must wait for resolution loading state to complete before scrolling
- extendedWaitUntil:
    notVisible:
      text: '.*Cargando.*resoluci.*|.*Loading.*resolution.*'
    timeout: 20000

# Allow time for resolution data to render
- waitForAnimationToEnd:
    timeout: 2000

# ==========================================
# STEP 8: SCROLL TO RESOLUTION SECTION
# ==========================================
# Resolution card is at the BOTTOM of the page - needs MULTIPLE scrolls
# Each scroll reveals different sections: params, insulin details, control data, THEN resolution

# Scroll 1 - Past treatment parameters
- scroll:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd:
    timeout: 1500

# Scroll 2 - Past insulin details
- scroll:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd:
    timeout: 1500

# Scroll 3 - Past optional fields (control data, etc)
- scroll:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd:
    timeout: 1500

# Scroll 4 - Reveal resolution card
- scroll:
    direction: DOWN
    duration: 500
- waitForAnimationToEnd:
    timeout: 1500

# ==========================================
# STEP 9: VERIFY RESOLUTION DISPLAY
# ==========================================
# Verify resolution card header is visible (bilingual)
- extendedWaitUntil:
    visible:
      text: '.*Resoluci.*|.*Resolution.*'
    timeout: 10000

# Verify resolution data labels are present (bilingual patterns)
- assertVisible:
    text: '.*Tipo.*Insulina.*Basal.*|.*Basal.*Insulin.*Type.*'
    label: 'Basal Type label visible'

- assertVisible:
    text: '.*Dosis.*Basal.*|.*Basal.*Dose.*'
    label: 'Basal Dose label visible'

# Verify dynamic test values from script output (unique per run)
- assertVisible:
    text: '.*${output.basalType}.*'
    label: 'Dynamic basal type value visible'

- assertVisible:
    text: '.*${output.basalDose}.*'
    label: 'Dynamic basal dose value visible'

# ==========================================
# STEP 10: FINAL API VERIFICATION
# ==========================================
# Re-verify via API to confirm consistency
- runScript:
    file: ../../scripts/verify-resolution-api.js
    env:
      APPOINTMENT_ID: '${output.appointmentId}'

- assertTrue:
    condition: ${output.exists}
    label: 'Final API verification - resolution still exists'

# Log final verification
- evalScript: |
    console.log('=== FINAL VERIFICATION ===');
    console.log('Appointment ID: ' + output.appointmentId);
    console.log('Resolution exists: ' + output.exists);
    console.log('Basal Type: ' + output.basalType);
    console.log('Basal Dose: ' + output.basalDose);
    console.log('TEST PASSED: Resolution verified via API and UI');

# ==========================================
# TEST COMPLETE
# ==========================================
